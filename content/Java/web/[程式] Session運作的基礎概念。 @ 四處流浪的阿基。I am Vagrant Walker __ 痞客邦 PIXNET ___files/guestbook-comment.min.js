(function(angular,window,jQuery,location,alert,document){var guestbookElement=angular.element(document.getElementById("pix-Guestbook-Comment-block")),sideGbElement=angular.element(document.getElementById("side_gb"));angular.module("pixGlobalValue",[]);angular.module("pixGlobalValue").value("pix",window.pix);angular.module("pixGuestbook",["angularSpinner","pixGlobalValue"]).run(["$rootScope","guestbookService",function($rootScope,guestbookService){$rootScope.guestbookService=guestbookService}]);angular.module("pixGuestbook").config(["$locationProvider",function($locationProvider){$locationProvider.html5Mode(true).hashPrefix("!")}]);var $AnchorScrollProvider=function(){this.$get=["$window","$location","$rootScope",function($window,$location,$rootScope){function scroll(){}return scroll}]};angular.module("pixGuestbook").provider("$anchorScroll",$AnchorScrollProvider);angular.module("pixGuestbook").service("configService",[function(){var self=this;self.data={};self.set=function(key,value){self.data[key]=value};self.get=function(key){return self.data[key]}}]);angular.module("pixGuestbook").service("guestbookService",["$http","pix","$location","configService",function($http,pix,$location,configService){var post=function(url,data){data.sToken=pix.sToken;return $http.post(url,jQuery.param(data),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})};var self=this;self.showCommentForm=false;self.openCommentForm=function(){self.showCommentForm=true;var image=new Image;image.src=configService.get("openCommentFormTraceLink")};self.closeCommentForm=function(){self.showCommentForm=false;$location.hash("")};self.logout=function(link){return $http.get(link)};self.sendGuestbookComment=function(nickname,title,content,authCode,isPrivate){var data={nickname:nickname,title:title,content:content,authCode:authCode,isApp:1};if(isPrivate){data.isPrivate=1}return post("/blog/postguestbookarticle",data)};self.reloadCaptcha=function(){return post("/blog/reloadguestbookcaptcha",{})}}]);angular.module("pixGuestbook").controller("GuestbookCommentCtrl",["$scope","$rootScope","$timeout","configService","guestbookService",function($scope,$rootScope,$timeout,configService,guestbookService){$scope.isLoading=false;$scope.hasLogon=configService.get("guestName")&&configService.get("guestName").length>0?true:false;$scope.guestName=configService.get("guestName");$scope.guestAvatar=configService.get("guestAvatar");var init=function(){$scope.nickname="";$scope.title="";$scope.content="";$scope.authCode="";$scope.isPrivate=false};init();$scope.$on("open comment form",function(){$timeout(function(){guestbookService.openCommentForm()})});$scope.submit=function(){$scope.isLoading=true;guestbookService.sendGuestbookComment($scope.nickname,$scope.title,$scope.content,$scope.authCode,$scope.isPrivate).then(function(ret){$scope.isLoading=false;$scope.$broadcast("reloadCaptcha");var data=ret.data;if(data.error){alert(data.message);$scope.authCode="";return false}if(data.guestbook_article){sideGbElement.scope().$emit("sendGuestbookArticle",data.guestbook_article)}init();guestbookService.closeCommentForm()})};if(location.hash.match(/guestbook-comment/)){guestbookService.openCommentForm()}if(location.hash.match(/comments/)){var comment=document.querySelector("a[name='comments']");if(comment&&comment.scrollIntoView){comment.scrollIntoView()}}if(sideGbElement.length&&location.hash.match(/side_gb/)){$timeout(function(){jQuery(window).scrollTop(sideGbElement.offset().top-50)})}}]);angular.module("pixGuestbook").directive("reloadCaptcha",["guestbookService",function(guestbookService){return{link:function postLink(scope,element,attrs){var reloadCaptchaBtn=element.find(".reload-captcha-btn");var reloadCaptchaImage=element.find(".reload-captcha-img");var reloadCaptcha=function(){guestbookService.reloadCaptcha().then(function(ret){var data=ret.data;if(data.error){throw new Error(data.message)}reloadCaptchaImage.attr("src",data.authcode_url)})};reloadCaptchaBtn.on("click",function(){reloadCaptcha()});scope.$on("reloadCaptcha",function(){reloadCaptcha()})}}}]);angular.module("pixGuestbook").directive("config",["configService",function(configService){return{link:function postLink(scope,element,attrs){configService.set("guestName",attrs.guestName);configService.set("guestAvatar",attrs.guestAvatar);configService.set("isOwner","true"===attrs.isOwner);configService.set("openCommentFormTraceLink",attrs.openCommentFormTraceLink)}}}]);angular.module("pixGuestbook").directive("backDrop",["$document","guestbookService",function($document,guestbookService){return{link:function postLink(scope,element,attrs){var elementMatchesAnyInArray=function(element,elementArray){for(var i=0;i<elementArray.length;i++){if(element==elementArray[i]){return true}}return false};$document.bind("click",function(event){var attr=event.target.getAttribute("data-open-comment");if("true"==attr){return}if(elementMatchesAnyInArray(event.target,element.find(event.target.tagName))){return}guestbookService.closeCommentForm();scope.$apply()})}}}]);angular.module("pixGuestbook").directive("windowOpener",["$window",function($window){return{scope:{link:"@",width:"@",height:"@"},link:function postLink(scope,element,attrs){element.on("click",function(){$window.open(scope.link,"login","height="+scope.height+",width="+scope.width+",scrollbars=1,resizable=0")})}}}]);angular.module("pixGuestbook").directive("loadMore",["$window",function($window){return{scope:{loadMore:"&"},link:function postLink(scope,element,attrs){var div=element.parent().parent();var inView=function(element){var docViewTop=div.scrollTop(),docViewBottom=docViewTop+div.height();var elemTop=element.offset().top,elemBottom=elemTop+element.height();return elemBottom<=docViewBottom&&elemTop>=docViewTop};div.scroll(function(){if(inView(element)&&element.is(":visible")){scope.$apply(function(){scope.loadMore()})}})}}}]);angular.module("pixGuestbookPanel",["pixGlobalValue"]);angular.module("pixGuestbookPanel").service("GuestBookPanelService",["$http","pix",function($http,pix){var service=this;service.getArticles=function(page){return $http.get("/blog/guestbook?page="+page)};service.deleteArticle=function(id){var data={id:id,sToken:pix.sToken};return $http.post("/blog/deleteguestbookarticle",jQuery.param(data),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})};return this}]);angular.module("pixGuestbookPanel").controller("GuestbookSidebarCtrl",["$scope","$timeout","GuestBookPanelService","pix",function($scope,$timeout,GuestBookPanelService,pix){$scope.isOwner=pix.is_owner;$scope.articles=[];$scope.hideLoadMore=true;$scope.page=1;$scope.getArticles=function(){$scope.hideLoadMore=true;GuestBookPanelService.getArticles($scope.page).then(function(ret){var data=ret.data;if(data.error){$scope.hideLoadMore=true;throw new Error("GuestBookPanelService getArticles error")}$scope.articles=$scope.articles.concat(data.rows);$scope.hideLoadMore=$scope.page>=data.total_page;$scope.page++})};$scope.$on("sendGuestbookArticle",function(event,data){$timeout(function(){$scope.articles.unshift(data)})});$scope.deleteArticle=function(article,$index){GuestBookPanelService.deleteArticle(article.id).then(function(ret){var data=ret.data;if(data.error){throw new Error("GuestBookPanelService.deleteArticle failed")}$scope.articles.splice($index,1)})};$scope.openCommentForm=function(){guestbookElement.scope().$emit("open comment form")};$scope.getArticles()}]);angular.element(document).ready(function(){angular.bootstrap(guestbookElement,["pixGuestbook"]);angular.bootstrap(sideGbElement,["pixGuestbookPanel"])})})(angular,window,jQuery,location,alert,document);

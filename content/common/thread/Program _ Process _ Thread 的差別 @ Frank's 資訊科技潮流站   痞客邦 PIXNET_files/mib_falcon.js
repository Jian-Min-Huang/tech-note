(function(window,$,undefined){var document=window.document,pix=window.pix||{};window.requestAnimFrame=window.requestAnimFrame||function(){"use strict";return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}();var playSecondsTotal=0,playSecondsMeter,videoPositionId=3,unfoldPositionId=8,unfoldPositionSize="300x250",videoPositionSize="384x288",sidebarPositionSize="180x280",mibVideoPlayerId="mib-video-player",payThreshold=10,isArrivedThreshold=false,isArrivedThreshold2=false,videoDuration=0,arrivedDurationPercentFlags=[],currentVideoAdResource,hasCheckedBackupSidebarAd=false,demoQueryMap={"384x288":"preview_mib_video_ad","180x280":"demo_ad_no","300x250":"preview_mib_sidebar_ad"};pix.MIB=pix.MIB||{};pix.MIB.util=pix.MIB.util||{};pix.MIB.util.Dom={_reClassNameCache:{},_getClassRegEx:function(className){var re=pix.MIB.util.Dom._reClassNameCache[className];if(!re){re=new RegExp("(?:^|\\s+)"+className+"(?:\\s+|$)");pix.MIB.util.Dom._reClassNameCache[className]=re}return re},hasClass:function(obj,className){if(typeof obj=="undefined"||null===obj||!RegExp){return false}var re=new RegExp("(^|\\s)"+className+"(\\s|$)");if(typeof obj=="string"){return re.test(obj)}else if(typeof obj=="object"&&obj.className){return re.test(obj.className)}return false},getElementsByClassName:function(className,tag,root,apply){tag=tag||"*";root=root||document;var nodes=[],elements=root.getElementsByTagName(tag),re=pix.MIB.util.Dom._getClassRegEx(className);for(var i=0,len=elements.length;i<len;i++){if(re.test(elements[i].className)){nodes[nodes.length]=elements[i];if(apply){apply.call(elements[i],elements[i])}}}return nodes}};pix.MIB.util.createJsElement=function(sUrl,sCharset){var dNode=document.createElement("script");dNode.src=sUrl;dNode.type="text/javascript";var dHead=document.getElementsByTagName("head")[0]||document.body;dHead.appendChild(dNode);if(sCharset){dNode.setAttribute("charset",sCharset)}return dNode};pix.MIB.unfold={getHTML:function(adResource,positionStr){var positionClass="show-"+positionStr;return'<div id="pix-mib-unfold-ad" class="mib-unfold--ad-box '+positionClass+'">'+'<a href="'+decodeURIComponent(adResource.ad_purl)+'" target="_blank" ">'+'<img src="'+decodeURIComponent(adResource.ad_img)+'" alt="falcon ad" class="ad-img"></a>'+'<div class="cancel-btn">X</div>'+pix.MIB.build.adIconHTML()+"</div>"},getAdElement:function(adResource,positionDirection){var div=document.createElement("div");div.innerHTML=pix.MIB.unfold.getHTML(adResource,positionDirection)||"";return div.childNodes},showAd:function(adResource){var position=pix.MIB.config.demo.demoOption||6,positionDirection=4===position?"left":"right",animateStyle={},adElem=pix.MIB.unfold.getAdElement(adResource,positionDirection),$adElem=$(adElem);$("body").append(adElem);animateStyle[positionDirection]=0;$adElem.animate(animateStyle,1e3);$adElem.on("click",".cancel-btn",function(){$adElem.remove()})},getAdCallback:function(oData){var unfoldPos=oData["s"+unfoldPositionSize];if(unfoldPos&&unfoldPos.ad_list&&unfoldPos.ad_list.length){var adResource=unfoldPos.ad_list[0];pix.MIB.unfold.showAd(adResource);pix.MIB.build.showAdiUrlImage(adResource,unfoldPositionSize)}},init:function(){if(!getAvailablePositionById(pix.MIB.config.availablePositions,unfoldPositionId).enable){return}var sUrl=getDefaultFalconSiteUrl("ada","8x1","pix.MIB.unfold.getAdCallback")+"&articleurl="+encodeURIComponent(location.href);pix.MIB.util.createJsElement(sUrl)}};pix.MIB.videoad={logPercent:function(t,param){if(!arrivedDurationPercentFlags[t]){arrivedDurationPercentFlags[t]=true;var imgPercent=new Image;imgPercent.src=pix.MIB.config.percentSite+"?id="+currentVideoAdResource.ad_hash+"&u="+pix.MIB.config.uniq+"&t="+t+(param&&param.cs?"&cs="+param.cs:"")}},triggerAdUrl:function(param){if(!isArrivedThreshold){isArrivedThreshold=true;var imgau=new Image;imgau.src=currentVideoAdResource.ad_url+(param&&param.cs?"&cs="+param.cs:"")+(param&&param.vs?"&vs="+param.vs:"")}},triggerAdPurl:function(param){if(!isArrivedThreshold2){isArrivedThreshold2=true;var imgap=new Image;imgap.src=currentVideoAdResource.ad_purl+(param&&param.cs?"&cs="+param.cs:"")+(param&&param.vs?"&vs="+param.vs:"")}},onPlay:function(){playSecondsMeter=setTimeout(function(){playSecondsTotal+=1;if(videoDuration>0){if(playSecondsTotal>=payThreshold&&!isArrivedThreshold){pix.MIB.videoad.triggerAdUrl({vs:playSecondsTotal});pix.MIB.videoad.logPercent(10)}if(playSecondsTotal>=10){$(".mib-video-close").show();pix.MIB.videoad.logPercent(10)}if(playSecondsTotal>=Math.floor(videoDuration*.5)){pix.MIB.videoad.logPercent(50);pix.MIB.videoad.triggerAdPurl({vs:playSecondsTotal})}if(playSecondsTotal>=Math.floor(videoDuration*.7)){pix.MIB.videoad.logPercent(70)}if(playSecondsTotal>=Math.floor(videoDuration*.97)){pix.MIB.videoad.logPercent(100)}}playSecondsMeter=setTimeout(arguments.callee,1e3)},1e3)}},pix.MIB.build={buildUnfoldAd:function(oData){var adData=oData["s"+unfoldPositionSize];if(adData&&adData.ad_num&&adData.ad_list&&0<adData.ad_list.length){for(var i=0;i<adData.ad_list.length;i++){pix.MIB.unfold.showAd(adData.ad_list[i])}}},getAd:function(oData){var goldAds=pix.MIB.config.goldAds;for(var i=0,len=goldAds.length;i<len;i++){var sHtml="",goldAd=goldAds[i],iValue=goldAd.getAttribute("model")?goldAd.getAttribute("model"):"300x250",sSize="s"+iValue,adData=oData[sSize],aSize=iValue.split("x"),sWidth=aSize[0]?aSize[0]:"300",sHeight=aSize[1]?aSize[1]:"200";if(!adData){continue}if(pix.MIB.build.isShowingSidebarBackupAd(adData)){pix.MIB.build.initSidebarBackupAd();continue}if(0===adData.ad_num&&videoPositionSize===adData.ad_size){$("body").removeClass("freeze-video-ad");$("#mib-video-expander").remove()}else if(videoPositionSize===iValue){$("#mib-video-expander").delay(500).animate({height:"320px"},1e3,function(){$(".mib-video-container").animate({opacity:"toggle"},2e3,function(){});$(".mib-video-background").css({height:"320px"})})}if(adData.ad_size!==iValue||!adData.ad_list||!adData.ad_list[0]){continue}var adResource=adData.ad_list[0],adType=adResource.ad_type||"";if(!adType){continue}pix.MIB.build.showAdiUrlImage(adResource,iValue);if("movie"===adType&&isVideoPositionEnable()){pix.MIB.build.initVideoAdPlayer(goldAd,adResource);continue}if(("img"===adType||"swf"===adType)&&videoPositionSize===iValue){var imgDisplayDiv=goldAd.parentNode.parentNode,imgUrl=decodeURIComponent(adResource.ad_img),$mibADIcon=$(pix.MIB.build.adIconHTML());if("img"===adType){var imgUrl=decodeURIComponent(adResource.ad_img);imgDisplayDiv.setAttribute("style","background: url("+imgUrl+") no-repeat center top");$(imgDisplayDiv).on("click",function(event){var $target=$(event.target);if($target.is($mibADIcon)||0<$target.closest($mibADIcon).length){event.stopPropagation();return}window.open(decodeURIComponent(adResource.ad_purl))})}else if("swf"===adType){imgDisplayDiv.innerHTML=pix.MIB.build.swfHTML(imgUrl,1024,320)}imgDisplayDiv.style.boxShadow="none";$(imgDisplayDiv).append($mibADIcon);if(!adResource.ad_bg_img){$("#mib-video-expander").css("background","url("+decodeURIComponent(adResource.ad_bg_img)+") repeat-x")}$(".mib-video-container").remove()}else if("img"===adType){if(-1!=="s590x90,s300x250".indexOf(sSize)){goldAd.style.display="inline-block"}sHtml=pix.MIB.build.defaultImgHTML(adResource,sWidth,sHeight)}else if("html5"===adType){sHtml=pix.MIB.build.html5(decodeURIComponent(adResource.ad_img),sWidth,sHeight)}else if("swf"===adType){sHtml=pix.MIB.build.swfHTML(decodeURIComponent(adResource.ad_img),sWidth,sHeight)}$(goldAd).html(sHtml+pix.MIB.build.adIconHTML());adData.ad_list.shift()}},showAdiUrlImage:function(adResource,size){if(adResource.ad_iurl&&!hasDemoQuery(size)){var imgi=new Image;imgi.src=adResource.ad_iurl}},isShowingSidebarBackupAd:function(adData){return sidebarPositionSize===adData.ad_size&&(0===adData.ad_num||0===adData.ad_list.length||""!==getQueryValue("demo_ad_no"))},initSidebarBackupAd:function(){if(hasCheckedBackupSidebarAd){return}hasCheckedBackupSidebarAd=true;var adQueryNo=getQueryValue("demo_ad_no"),adId=getQueryValue("ad_num")||(pix.MIB.config.hasMIB?835:1080),currentSidebarAds=pix.MIB.build.getSidebarGoldAds(),adIdStr=getRepeatJoinStr(currentSidebarAds.length,adId),url=pix.MIB.config.falconSite+"/ad/json/"+adIdStr+"?version=2"+"&demo_ad_no="+adQueryNo;$.get(url,function(data){var adSlots=data.ad_slots||[];for(var i=0;i<adSlots.length;i++){var adList=adSlots[i].ad_list,adType=$.isArray(adList)&&adList.length&&adList[0].type,html=adSlots[i].html+("image"===adType?pix.MIB.build.adIconHTML():"");$(currentSidebarAds[i]).html(html)}},"jsonp")},getSidebarGoldAds:function(){var temp=[],goldAd,goldAds=pix.MIB.config.goldAds||[];for(var i=0,len=goldAds.length;i<len;i++){goldAd=goldAds[i];if(sidebarPositionSize===goldAd.getAttribute("model")&&!goldAd.innerHTML.trim()){temp.push(goldAds[i])}}return temp},adgen:function(){var sQuery=getPositionsSizeQuery(pix.MIB.config.availablePositions),sUrl=getDefaultFalconSiteUrl("ada",sQuery,"pix.MIB.build.getAd")+"&articleurl="+encodeURIComponent(location.href);pix.MIB.util.createJsElement(sUrl)},videoadgen:function(){if(0===pix.MIB.config.goldAds.length||!isVideoPositionEnable()){return}var sUrl=getDefaultFalconSiteUrl("vaa","3x1","pix.MIB.build.getAd")+"&ref="+pix.MIB.config.ref;pix.MIB.util.createJsElement(sUrl)},detectPageScrollPlayback:function(){if(!isVideoPositionEnable()){return}var $window=$(window),$videoContainer=$("#mib-video-expander"),player,scrollTop,videoVisionHeight;if(!$videoContainer.hasClass("freeze")){$window.scroll(function(){window.requestAnimFrame(playback)})}$(".mib-video-close a").on("click",function(){$("#mib-video-expander").animate({height:"toggle"},500,function(){player=videojs(mibVideoPlayerId);if(player){$window.off("scroll",playback);player.pause();clearTimeout(playSecondsMeter);player.off("play",pix.MIB.videoad.onPlay);player.dispose();player=null}$("body").removeClass("freeze-video-ad")})});function playback(){try{player=videojs(mibVideoPlayerId);scrollTop=document.body.scrollTop||document.documentElement.scrollTop||window.pageYOffset;videoVisionHeight=$videoContainer.height()*.85;if(scrollTop>=videoVisionHeight){player.pause()}else{if(player.paused()&&player.currentTime()<player.duration()&&scrollTop<=Math.floor(videoVisionHeight)){player.play()}}}catch(ex){}}},initVideoAdPlayer:function(goldAd,adResource){var player=videojs(mibVideoPlayerId),videoBackgroundDiv=goldAd.parentNode.parentNode,$videoContainer=$(goldAd.parentNode),$videoControllerBar=$videoContainer.find(".vjs-control-bar"),videoCloseBtn=$(".mib-video-close"),$mibADIcon=$(pix.MIB.build.adIconHTML());currentVideoAdResource=adResource;videoCloseBtn.hide().addClass("mib-video-close-"+(adResource.ad_close_align||"bottom-right"));$(videoBackgroundDiv).css("background","url("+decodeURIComponent(adResource.ad_bg_img)+") no-repeat center top").append($mibADIcon).on("click",function(){var $target=$(event.target);if($target.is(videoCloseBtn)||$target.is($videoControllerBar)||0<$target.closest(videoCloseBtn).length||0<$target.closest($videoControllerBar).length||$target.is($mibADIcon)||0<$target.closest($mibADIcon).length){event.stopPropagation();return}window.open(decodeURIComponent(adResource.ad_dlink))});$($videoContainer.find("video")).on("click",function(event){if(payThreshold>playSecondsTotal){pix.MIB.videoad.triggerAdUrl({cs:playSecondsTotal,vs:playSecondsTotal})}pix.MIB.videoad.triggerAdPurl({cs:playSecondsTotal,vs:playSecondsTotal});pix.MIB.videoad.logPercent(101,{cs:playSecondsTotal});window.open(decodeURIComponent(adResource.ad_purl));event.stopPropagation()});if("center"!==adResource.ad_align){$videoContainer.removeClass("mib-centered")}if("right"===adResource.ad_align){$videoContainer.addClass("mib-right")}else if("left"===adResource.ad_align){$videoContainer.addClass("mib-left")}player.src([{type:"video/webm",src:decodeURIComponent(adResource.ad_img3)},{type:"video/mp4",src:decodeURIComponent(adResource.ad_img)}]);var player_html5=$("#mib-video-player_html5_api");if(player_html5){player_html5.append('<source src="'+decodeURIComponent(adResource.ad_img)+'" type="video/mp4" />');if(""!==adResource.ad_img3){player_html5.append('<source src="'+decodeURIComponent(adResource.ad_img3)+'" type="video/webm" />')}}player.volume(0);player.on("loadeddata",function(){videoDuration=this.duration()});player.on("play",pix.MIB.videoad.onPlay);player.on("ended",function(){player.currentTime(1);if(videoDuration<=0){return}if(playSecondsTotal+1>=Math.floor(videoDuration)){pix.MIB.videoad.logPercent(100)}});player.on("pause",function(){clearTimeout(playSecondsMeter)})},defaultImgHTML:function(adResource,width,height){return'<a href="'+adResource.ad_url+'" target="_blank"><img style="margin:0 auto;display:block;min-width:'+width+"px;min-height:"+height+'px;" src="'+decodeURIComponent(adResource.ad_img)+'"></a>'},swfHTML:function(sAdUrl,width,height){return'<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="'+width+'" height="'+height+'"><param name="movie" value="'+decodeURIComponent(sAdUrl)+'"><param name="allowScriptAccess" value="always"><embed src="'+decodeURIComponent(sAdUrl)+'" width="'+width+'" height="'+height+'" allowscriptaccess="always"></embed></object>'},html5:function(sAdUrl,width,height){return'<iframe src="'+decodeURIComponent(sAdUrl)+'" width="'+width+'" height="'+height+'" frameborder="0" marginwidth="0" marginheight="0" framespacing="0" scrolling="no" allowtransparency="true"></iframe>'},adIconHTML:function(){return'<span class="mib--ad-box__icon"><a href="#">痞客邦廣告聯播網</a></span>'}};function getRepeatJoinStr(adNum,adId){var str="";for(var i=0;i<adNum;i++){str=str+adId+(i!==adNum-1?",":"")}return str}function getDefaultFalconSiteUrl(uri,sQuery,callbackName){return pix.MIB.config.falconSite+"/mib/"+uri+"?size="+sQuery+"&hosthash="+pix.MIB.config.hosthash+"&cate="+pix.MIB.config.cate+"&acate="+pix.MIB.config.article_cate_id+(pix.MIB.config.demo.hash?"&ad="+pix.MIB.config.demo.hash:"")+"&callback="+callbackName}function getQueryValue(key){if(!key){return""}var query=window.location.search.substring(1),vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(pair[0]===key){return decodeURIComponent(pair[1].replace(/\+/g," "))}}return""}function hasDemoQuery(size){if(!size){return false}return""!==getQueryValue("demo_ad_no")||""!==getQueryValue(demoQueryMap[size])}function getAvailablePositionById(availablePositions,id){if(!availablePositions||0===availablePositions.length){return{}}for(var i=0,len=availablePositions.length;i<len;i++){if(id===availablePositions[i].id){return availablePositions[i]}}return{}}function isVideoPositionEnable(){return getAvailablePositionById(pix.MIB.config.availablePositions,videoPositionId).enable}function getPositionsSizeQuery(availablePositions){var adObj={},sQuery="",adPosition;if(!availablePositions||0===availablePositions.length){return""}for(var i=0,len=availablePositions.length;i<len;i++){adPosition=availablePositions[i];if(!adPosition.enable||videoPositionId===adPosition.id||unfoldPositionId===adPosition.id){continue}var count=adPosition.enable?1:0;adObj[adPosition.id]=adObj[adPosition.id]?adObj[adPosition.id]+count:count}for(var key in adObj){if(!adObj.hasOwnProperty(key)){continue}if(!adObj[key]){continue}sQuery=sQuery+key+"x"+adObj[key]+","}return sQuery.replace(new RegExp(",$","g"),"")||""}})(window,jQuery);

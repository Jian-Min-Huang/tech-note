// API callback
related_results_labels_thumbs({"version":"1.0","encoding":"UTF-8","feed":{"xmlns":"http://www.w3.org/2005/Atom","xmlns$openSearch":"http://a9.com/-/spec/opensearchrss/1.0/","xmlns$blogger":"http://schemas.google.com/blogger/2008","xmlns$georss":"http://www.georss.org/georss","xmlns$gd":"http://schemas.google.com/g/2005","xmlns$thr":"http://purl.org/syndication/thread/1.0","id":{"$t":"tag:blogger.com,1999:blog-37997006600210175"},"updated":{"$t":"2017-12-23T20:26:26.693+08:00"},"category":[{"term":"軟體"},{"term":"閒聊"},{"term":"硬體"},{"term":"node"},{"term":"IoT"},{"term":"電子電路"},{"term":"MT7688"},{"term":"RF"},{"term":"Qt"},{"term":"npm"},{"term":"嵌入式"},{"term":"韌體"},{"term":"EE人專欄"},{"term":"頻率響應"},{"term":"Linux"},{"term":"LoRa"},{"term":"crosstool"},{"term":"量測"},{"term":"Beaglebone"},{"term":"PLC"},{"term":"ST"},{"term":"ZigBee"},{"term":"esp8266"},{"term":"nodemcu"}],"title":{"type":"text","$t":"E.E.RHAPSODY"},"subtitle":{"type":"html","$t":"E. E. 狂想曲"},"link":[{"rel":"http://schemas.google.com/g/2005#feed","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/posts\/default"},{"rel":"self","type":"application/atom+xml","href":"https:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/-\/%E8%BB%9F%E9%AB%94?alt=json-in-script\u0026max-results=8"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/search\/label\/%E8%BB%9F%E9%AB%94"},{"rel":"hub","href":"http://pubsubhubbub.appspot.com/"},{"rel":"next","type":"application/atom+xml","href":"https:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/-\/%E8%BB%9F%E9%AB%94\/-\/%E8%BB%9F%E9%AB%94?alt=json-in-script\u0026start-index=9\u0026max-results=8"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"generator":{"version":"7.00","uri":"http://www.blogger.com","$t":"Blogger"},"openSearch$totalResults":{"$t":"27"},"openSearch$startIndex":{"$t":"1"},"openSearch$itemsPerPage":{"$t":"8"},"entry":[{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-8888621653834895185"},"published":{"$t":"2017-03-30T21:08:00.003+08:00"},"updated":{"$t":"2017-03-30T22:57:08.345+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"IoT"},{"scheme":"http://www.blogger.com/atom/ns#","term":"ZigBee"},{"scheme":"http://www.blogger.com/atom/ns#","term":"嵌入式"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"}],"title":{"type":"text","$t":"ZigBee 這樣玩？有意思！用 LinkIt Smart 7688 打造超迷你 ZigBee 機器網路！"},"content":{"type":"html","$t":"\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E　　本週超有意思的投稿！是我的同事、也是我的學生 \u003Ca href=\"https:\/\/www.facebook.com\/profile.php?id=100000245049219\" target=\"_blank\"\u003EJack \u003C\/a\u003E\u0026nbsp;所開發的 \u003Ca href=\"https:\/\/github.com\/zigbeer\/zigbee-shepherd\" target=\"_blank\"\u003Ezigbee 開源專案\u003C\/a\u003E！為什麼這個專案有意思呢？因為 ZigBee 這個討人厭的東西，向來都是大家認為開發門檻比較高的傢伙，光是把 spec 搞懂就不知道得花上多少精神跟時間（當然 spec 訂的細，換到的就是各家產品的相容性囉）。\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E　　雖然現在 IoT 通訊協定還是戰的一踏糊塗，但大家有沒有發現，ZigBee 系列產品在消費型市場已經悄悄地出現在我們身邊了呢！在智慧家庭的應用上，藍牙系列商品還沒辦法做到這樣子呀！既然 ZigBee 商用產品已經越來越容易買到，於是引發了 Jack 的想法：\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E「\u003Cspan style=\"color: #3d85c6;\"\u003E是不是可以做一個讓 WebApp 和 Mobile App 開發者可以立馬投入物聯網應用設計的東西呢？反正周邊產品都這麼容易買到了！完全可以利用這些東西，快速地兜出應用來啊！」\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E「\u003C\/span\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E價值並不在於周邊電路跟韌體的設計，反而是如何能很快地把心中所想的應用打造出來才是重點吧！然後也要能夠很容易地把 ZigBee 接到雲端，嘿嘿，搞不好可以多\u003C\/span\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E幹些好玩的事！\u003C\/span\u003E」\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: left;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-22EdbO6YMes\/WNz43s78vJI\/AAAAAAAACFg\/hxO12eLAZ0ceYi_0ChC7CaDx4I0ebk24QCLcB\/s1600\/header.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"386\" src=\"https:\/\/3.bp.blogspot.com\/-22EdbO6YMes\/WNz43s78vJI\/AAAAAAAACFg\/hxO12eLAZ0ceYi_0ChC7CaDx4I0ebk24QCLcB\/s640\/header.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both;\"\u003E當然！Jack 花了一段蠻長的時間一直在搞這個鬼東西，很高興最近看到他的專案漸漸穩定下來，也開始有歐美、台灣公司以及 web 開發者在使用這個超有意思的東西囉！以下就讓我們來看看 Jack 的介紹吧！\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both;\"\u003E（因為用了 7688，所以它除了是 ZigBee Coordinator 之外，同時也是一台 Gateway，而且又是一台 WebApp 服務器，然後超迷你，7688 又便宜 XDDD \u003Cb\u003E\u003Cspan style=\"color: #cc0000;\"\u003E簡直是 CP 值大破表呀\u003C\/span\u003E\u003C\/b\u003E！）\u003C\/div\u003E\u003Chr \/\u003E\u003Cbr \/\u003E哈囉～大家好，我是 Jack，今天想跟大家分享怎麼樣把 LinkIt Smart 7688 拿來當作 ZigBee 的閘道器！要組織出一個 ZigBee 機器網路，當然除了 7688 之外，還需要準備一支 TI 的 CC2531 USB Dongle 來負責興起網路，然後跟周邊的 ZigBee 節點做通訊啦！有了與裝置溝通的橋樑，就只缺一個給使用者的前端介面啦～所以閘道器上也有 WebApp 的 Server，以下是簡單的 Demo ～～\u003Cbr \/\u003E\u003Cbr \/\u003E（我做的前端介面沒有很優，不過只是個小小的 demo 啦！請大家不要介意呀～　我相信有超多厲害的前端開發者，隨便都可以弄出個比我這漂亮幾萬倍的介面 =.=，所以我就不要硬跟大家比賽 GUI 的事啦，因為我一定輸的啊！哈哈哈～）\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003E一、準備材料\u003C\/h3\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-LRjc65VlS3k\/WNz5B7VnGyI\/AAAAAAAACF4\/ibCvp0jozMIPcIhLgm5ILypYQE1xoi6iQCEw\/s1600\/zb2.jpg\" imageanchor=\"1\" style=\"clear: right; float: right; margin-bottom: 1em; margin-left: 1em;\"\u003E\u003Cimg border=\"0\" height=\"258\" src=\"https:\/\/2.bp.blogspot.com\/-LRjc65VlS3k\/WNz5B7VnGyI\/AAAAAAAACF4\/ibCvp0jozMIPcIhLgm5ILypYQE1xoi6iQCEw\/s400\/zb2.jpg\" width=\"400\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cul\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/labs.mediatek.com\/zh-tw\/platform\/linkit-smart-7688\" target=\"_blank\"\u003ELinkIt Smart 7688\u003C\/a\u003E\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"http:\/\/www.ti.com\/tool\/cc2531emk\" target=\"_blank\"\u003ETI CC2531 USB Dongle\u003C\/a\u003E\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"http:\/\/www2.meethue.com\/zh-tw\/productdetail\/philips-hue-go\" target=\"_blank\"\u003EPhilips Hue Go\u003C\/a\u003E 情境燈\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.asus.com\/tw\/Internet-of-Things\/ASUS-SmartHome-Meter-Plug-MW100\/\" target=\"_blank\"\u003EASUS 智慧插座\u003C\/a\u003E\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.asus.com\/tw\/Internet-of-Things\/ASUS-SmartHome-Temperature-Humidity-Sensor-TS101\/overview\/\" target=\"_blank\"\u003EASUS 溫溼度感測器\u003C\/a\u003E\u003C\/li\u003E\u003C\/ul\u003E\u003Cbr \/\u003E\u003Ch3\u003E二、軟體工具\u003C\/h3\u003E\u003Cdiv\u003E\u003Cdiv\u003E\u003Cul\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/nodejs.org\/en\/\" target=\"_blank\"\u003Enode.js (v0.12.7)\u003C\/a\u003E\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/github.com\/zigbeer\/zigbee-shepherd\" target=\"_blank\"\u003Ezigbee-shepherd\u003C\/a\u003E\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"http:\/\/expressjs.com\/\" target=\"_blank\"\u003Eexpress.js\u003C\/a\u003E\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"http:\/\/socket.io\/\" target=\"_blank\"\u003Esocket.io\u003C\/a\u003E\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/github.com\/simenkid\/mt7688-cross\" target=\"_blank\"\u003Emt7688-cross\u003C\/a\u003E\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Ch3\u003E三、WebApp Demo\u003C\/h3\u003E\u003Cdiv\u003E\u003Ch4\u003E1. 啟動閘道器\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cspan class=\"Apple-tab-span\" style=\"white-space: pre;\"\u003E \u003C\/span\u003Essh 進入 LinkIt Smart 7688，在專案資料夾下執行 npm start 後，可以在 server 端的 console 看到 ZigBee 網路目前的基本訊息(上圖)，另外再透過瀏覽器連到 http 的伺服器，可看到 WebApp 的介面與運作情況(下圖)。\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-uRWoXzITVng\/WNz5JOjlIAI\/AAAAAAAACFo\/n0jV0n9bqA8bxj_EayahAV3FKKV5nqyJACLcB\/s1600\/zb31.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"432\" src=\"https:\/\/4.bp.blogspot.com\/-uRWoXzITVng\/WNz5JOjlIAI\/AAAAAAAACFo\/n0jV0n9bqA8bxj_EayahAV3FKKV5nqyJACLcB\/s640\/zb31.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-ECz1jkPN61s\/WNz5JnOgNVI\/AAAAAAAACFs\/aqfTxDG1frs6uYkNKIYpZxPH1HAs9dYSQCLcB\/s1600\/zb32.jpg\" imageanchor=\"1\" style=\"display: inline !important; margin-left: 1em; margin-right: 1em; text-align: center;\"\u003E\u003Cimg border=\"0\" height=\"470\" src=\"https:\/\/1.bp.blogspot.com\/-ECz1jkPN61s\/WNz5JnOgNVI\/AAAAAAAACFs\/aqfTxDG1frs6uYkNKIYpZxPH1HAs9dYSQCLcB\/s640\/zb32.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Ch4\u003E2. 開放裝置入網\u003C\/h4\u003E\u003Cdiv\u003E\u003Cspan class=\"Apple-tab-span\" style=\"white-space: pre;\"\u003E \u003C\/span\u003E一切就緒後，點擊網頁右上角的 PERMIT JOIN 按鈕，讓周邊 ZigBee 節點可以加入網路。當裝置入網時，server 端會顯示入網裝置的長位址 (IEEE Address)，網頁上也會出現相對應的圖案。\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-8j3S8wtJWrk\/WNz5n5tvq-I\/AAAAAAAACFw\/YZwynQKixjYBjiVJmHwe---mYFY6HP4YwCLcB\/s1600\/zb41.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"438\" src=\"https:\/\/4.bp.blogspot.com\/-8j3S8wtJWrk\/WNz5n5tvq-I\/AAAAAAAACFw\/YZwynQKixjYBjiVJmHwe---mYFY6HP4YwCLcB\/s640\/zb41.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-bzmIkzDEVgM\/WNz5oiPFpaI\/AAAAAAAACF0\/ErP4O1HFDe8Jt2mSfBVGQaH9e0A41RapgCLcB\/s1600\/zb42.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"468\" src=\"https:\/\/3.bp.blogspot.com\/-bzmIkzDEVgM\/WNz5oiPFpaI\/AAAAAAAACF0\/ErP4O1HFDe8Jt2mSfBVGQaH9e0A41RapgCLcB\/s640\/zb42.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Ch4\u003E3. 遠端控制周邊裝置\u003C\/h4\u003E\u003Cdiv\u003E\u003Cspan class=\"Apple-tab-span\" style=\"white-space: pre;\"\u003E \u003C\/span\u003E點擊插座的圖案，即可控制智慧插座開啟或關閉。控制電燈的方法也相同。\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-iHlxR2j_1VY\/WNz5vOlSyFI\/AAAAAAAACF8\/oOJW-kmn0fAbLpLKbIivRSaFxGignNBJgCLcB\/s1600\/zb51.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"430\" src=\"https:\/\/2.bp.blogspot.com\/-iHlxR2j_1VY\/WNz5vOlSyFI\/AAAAAAAACF8\/oOJW-kmn0fAbLpLKbIivRSaFxGignNBJgCLcB\/s640\/zb51.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-KuYGsiawa5g\/WNz5v9VoonI\/AAAAAAAACGA\/Dh-4-mg8PcQobW74ft9RXqWgOSC7HoTAQCLcB\/s1600\/zb52.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"468\" src=\"https:\/\/2.bp.blogspot.com\/-KuYGsiawa5g\/WNz5v9VoonI\/AAAAAAAACGA\/Dh-4-mg8PcQobW74ft9RXqWgOSC7HoTAQCLcB\/s640\/zb52.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Ch4\u003E4. 周邊裝置當前狀態\u003C\/h4\u003E\u003Cdiv\u003E\u003Cspan class=\"Apple-tab-span\" style=\"white-space: pre;\"\u003E \u003C\/span\u003E閘道器接收到最新感測到的溫溼度值時，會即時更新至網頁上。其他周邊裝置狀態發生改變，也一併會顯示在網頁上。\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-nAqLUqbBUMw\/WNz51Abn8qI\/AAAAAAAACGE\/zvyqzob3Su8v61nB515sYx_QIRwtF4VeACLcB\/s1600\/zb61.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"432\" src=\"https:\/\/4.bp.blogspot.com\/-nAqLUqbBUMw\/WNz51Abn8qI\/AAAAAAAACGE\/zvyqzob3Su8v61nB515sYx_QIRwtF4VeACLcB\/s640\/zb61.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-oj6RnjZttlk\/WN0SyQLlCJI\/AAAAAAAACHM\/V1kSkLbXbtgqPFCIyQMbFbj4vJfhKtfLgCLcB\/s1600\/zb62.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"466\" src=\"https:\/\/4.bp.blogspot.com\/-oj6RnjZttlk\/WN0SyQLlCJI\/AAAAAAAACHM\/V1kSkLbXbtgqPFCIyQMbFbj4vJfhKtfLgCLcB\/s640\/zb62.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E最後附上 Demo 影片，以上就是我小小的分享，謝謝大家～\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ciframe allowfullscreen=\"\" class=\"YOUTUBE-iframe-video\" data-thumbnail-src=\"https:\/\/i.ytimg.com\/vi\/XKznO8em_hA\/0.jpg\" frameborder=\"0\" height=\"266\" src=\"https:\/\/www.youtube.com\/embed\/XKznO8em_hA?feature=player_embedded\" width=\"320\"\u003E\u003C\/iframe\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003Chr \/\u003E\u003Ch3\u003E後記：\u003C\/h3\u003E以往大家覺得開發難度較高的 ZigBee，現在 Jack 確實把門檻給降低了不少。當一堆公司還在煎熬著開發 ZigBee 家用伺服中心的時候，Jack 用 node.js 幫 Web 工程師們打開了一道門，我想這對於一個年輕的小伙子來說，也算是做了一件蠻有工程價值的事情吧！\u003Cbr \/\u003E　\u003Cbr \/\u003E能夠把整個 idea 實現，然後又開源出來，我覺得還蠻搖滾的！ XD\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003C\/div\u003E"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/8888621653834895185\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2017\/03\/zigbee-linkit-smart-7688-zigbee.html#comment-form","title":"4 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/8888621653834895185"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/8888621653834895185"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2017\/03\/zigbee-linkit-smart-7688-zigbee.html","title":"ZigBee 這樣玩？有意思！用 LinkIt Smart 7688 打造超迷你 ZigBee 機器網路！"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/3.bp.blogspot.com\/-22EdbO6YMes\/WNz43s78vJI\/AAAAAAAACFg\/hxO12eLAZ0ceYi_0ChC7CaDx4I0ebk24QCLcB\/s72-c\/header.png","height":"72","width":"72"},"thr$total":{"$t":"4"}},{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-8267133439721654532"},"published":{"$t":"2017-03-24T20:24:00.001+08:00"},"updated":{"$t":"2017-03-24T23:27:10.359+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"MT7688"},{"scheme":"http://www.blogger.com/atom/ns#","term":"嵌入式"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"},{"scheme":"http://www.blogger.com/atom/ns#","term":"韌體"}],"title":{"type":"text","$t":"LinkIt Smart 7688 (Duo) - 韌體與Bootloader更新\/建置步驟"},"content":{"type":"html","$t":"　\u003Cbr \/\u003E手癢，又把比較煩人的東西整理起來一下。我是不是有強迫症.... \u0026nbsp;XDDD\u003Cbr \/\u003E如果有發現任何問題，請隨時讓我知道，以保資料正確呀！\u003Cbr \/\u003E\u003Cbr \/\u003E1. PDF 檔請\u003Ca href=\"https:\/\/drive.google.com\/file\/d\/0ByhyzaG37j--RWtIS0hGdjRPR1k\/view?usp=sharing\" target=\"_blank\"\u003E在此下載\u003C\/a\u003E\u003Cbr \/\u003E2. 底下是 PNG 圖檔\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003EFirmware 與 Bootloader 更新步驟\u003C\/h3\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-sFjlOK_pmXo\/WNUPqTfGy8I\/AAAAAAAACEo\/9OK0yu7s_eUNV-LSHrWg3D6fSTz5i23LQCLcB\/s1600\/LinkItSmart7688_fwm_bootloader_upgrade.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/1.bp.blogspot.com\/-sFjlOK_pmXo\/WNUPqTfGy8I\/AAAAAAAACEo\/9OK0yu7s_eUNV-LSHrWg3D6fSTz5i23LQCLcB\/s1600\/LinkItSmart7688_fwm_bootloader_upgrade.png\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E　\u003Cbr \/\u003E\u003Ch3\u003EFirmware 建置步驟\u003C\/h3\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-cqm9semOmEs\/WNUP0DNIniI\/AAAAAAAACEs\/wjkUI9TPWK02vHq8IWrFN_EcTZWDibTcgCLcB\/s1600\/LinkItSmart7688_fwm_build.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/2.bp.blogspot.com\/-cqm9semOmEs\/WNUP0DNIniI\/AAAAAAAACEs\/wjkUI9TPWK02vHq8IWrFN_EcTZWDibTcgCLcB\/s1600\/LinkItSmart7688_fwm_build.png\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E　\u003C\/div\u003E\u003Cdiv\u003E\u003Ch3\u003EBootloader 建置步驟\u003C\/h3\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-67xdJCwbmyo\/WNUP3j0vxlI\/AAAAAAAACEw\/n48D6xDlJuAcBXfPywFYIRJg-GjDKtm0ACLcB\/s1600\/LinkItSmart7688_bootloader_build.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/1.bp.blogspot.com\/-67xdJCwbmyo\/WNUP3j0vxlI\/AAAAAAAACEw\/n48D6xDlJuAcBXfPywFYIRJg-GjDKtm0ACLcB\/s1600\/LinkItSmart7688_bootloader_build.png\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003C\/div\u003E"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/8267133439721654532\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2017\/03\/linkit-smart-7688-duo-bootloader.html#comment-form","title":"0 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/8267133439721654532"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/8267133439721654532"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2017\/03\/linkit-smart-7688-duo-bootloader.html","title":"LinkIt Smart 7688 (Duo) - 韌體與Bootloader更新\/建置步驟"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/1.bp.blogspot.com\/-sFjlOK_pmXo\/WNUPqTfGy8I\/AAAAAAAACEo\/9OK0yu7s_eUNV-LSHrWg3D6fSTz5i23LQCLcB\/s72-c\/LinkItSmart7688_fwm_bootloader_upgrade.png","height":"72","width":"72"},"thr$total":{"$t":"0"}},{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-6809425231170245808"},"published":{"$t":"2017-03-10T20:32:00.002+08:00"},"updated":{"$t":"2017-04-30T02:14:08.016+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"MT7688"},{"scheme":"http://www.blogger.com/atom/ns#","term":"嵌入式"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"},{"scheme":"http://www.blogger.com/atom/ns#","term":"韌體"}],"title":{"type":"text","$t":"LinkIt Smart 7688 (Duo) - Reset 按鈕與狀態燈號參照表"},"content":{"type":"html","$t":"最近在弄 7688 時，發現一件事情很煩，就是我老記不住 Reset 按鈕和 LED 狀態燈號的意思，所以都要稍微翻一下官方的文件 (寫得超詳細)。不過，我還是手癢，自己做了一張參照表 XDD \u0026nbsp;科科....　有需要的朋友請自己取用吧！雖然，這個平常不太會用到，但是突然要用的時候就會整個覺得很煩躁....(應該只有我這樣覺得吧~~~哈哈哈)\u003Cbr \/\u003E\u003Cbr \/\u003E最近因為在做 sensor nodes，我會陸續把一些整理起來的東西跟大家分享！之後也打算把一些有趣的東西 post 在 \u003Ca href=\"https:\/\/www.facebook.com\/groups\/1830279053911904\" target=\"_blank\"\u003ENode.IoT 社團\u003C\/a\u003E裡哦！\u003Cbr \/\u003E\u003Cbr \/\u003E1. PDF 檔請\u003Ca href=\"https:\/\/drive.google.com\/open?id=0ByhyzaG37j--VE5MXzAwM0E1Mm8\" target=\"_blank\"\u003E在此\u003C\/a\u003E下載。\u003Cbr \/\u003E2. 底下是 PNG 圖檔。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-NyvwM9USAFc\/WQTX5PTOP2I\/AAAAAAAACJE\/0Onmmi2w13sGa4h447-C1sCu6ilf-IBQACLcB\/s1600\/LinkItSmart7688_RESET_LED2.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/1.bp.blogspot.com\/-NyvwM9USAFc\/WQTX5PTOP2I\/AAAAAAAACJE\/0Onmmi2w13sGa4h447-C1sCu6ilf-IBQACLcB\/s1600\/LinkItSmart7688_RESET_LED2.png\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/6809425231170245808\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2017\/03\/linkit-smart-7688-duo-reset.html#comment-form","title":"2 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/6809425231170245808"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/6809425231170245808"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2017\/03\/linkit-smart-7688-duo-reset.html","title":"LinkIt Smart 7688 (Duo) - Reset 按鈕與狀態燈號參照表"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/1.bp.blogspot.com\/-NyvwM9USAFc\/WQTX5PTOP2I\/AAAAAAAACJE\/0Onmmi2w13sGa4h447-C1sCu6ilf-IBQACLcB\/s72-c\/LinkItSmart7688_RESET_LED2.png","height":"72","width":"72"},"thr$total":{"$t":"2"}},{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-5466069941000596365"},"published":{"$t":"2016-11-12T12:14:00.003+08:00"},"updated":{"$t":"2016-11-12T12:32:52.529+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"node"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"}],"title":{"type":"text","$t":"Node.js fs 模組  APIs 的三種類型"},"content":{"type":"html","$t":"\u003Cbr \/\u003E前陣子，我在「\u003Ca href=\"https:\/\/simeneer.blogspot.tw\/2016\/10\/nodejs-streams.html\" target=\"_blank\"\u003E海納百川：Node.js Streams\u003C\/a\u003E」這篇文章的範例中，在使用了 \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003Efs.readFile()\u003C\/span\u003E\u003C\/b\u003E 這支 API 時，有提到它是 Bulk I\/O 這件事，然後再跟\u003Cb\u003E\u003Cspan style=\"color: #6fa8dc;\"\u003E \u003C\/span\u003E\u003Cspan style=\"color: #3d85c6;\"\u003Efs.createReadStream() \u003C\/span\u003E\u003C\/b\u003E來比較兩者之間的差異。為了讓你不用再回去那篇文章重看一次，我這裡把程式碼貼過來再稍微整理一下\u003Cbr \/\u003E\u003Cbr \/\u003E我們當時是為了讀取一支 2 GB 這麼大的影音檔：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[使用 fs.readFile() 來實作 ]\u003C\/span\u003E\u003C\/b\u003E\u003Cbr \/\u003E　　我們建立一個 http 伺服器 server.js，它使用 fs.readFile() 來讀檔，當有 request 進來的時候，我們把檔案送過去給瀏覽器。我們順便檢測一下錯誤，若有錯誤就把它印出來。當執行 server.js 並開啟瀏覽器到 http:\/\/locahost:3000 來下載檔案時，我們的 server \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E可能\u003C\/span\u003E\u003C\/b\u003E會因此爆炸。 (可能爆炸的原因詳見 \u003Ca href=\"https:\/\/simeneer.blogspot.tw\/2016\/10\/nodejs-streams.html\" target=\"_blank\"\u003E海納百川：Node.js Streams\u003C\/a\u003E 內文說明)\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E http \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Ehttp\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E fs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E \u0026nbsp; \u0026nbsp;\u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 利用 fs.readFile() 來讀取 xxx.avi 這支大檔案\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EreadFile\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Exxx.avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eerr\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (err) {\u003Cbr \/\u003E            \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 如果發生錯誤就把它列印在 console, 並傳回失敗響應給 Client 端\u003C\/span\u003E\u003Cbr \/\u003E            \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(err);\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E500\u003C\/span\u003E);\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eerr\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Emessage\u003C\/span\u003E);\u003Cbr \/\u003E        } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E            \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 如果成功, 就使用 res.end() 將檔案資料送給 Client 端\u003C\/span\u003E\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Evideo\/avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(data);\u003Cbr \/\u003E        }\u003Cbr \/\u003E    });\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eserver\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Elisten\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E3000\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003ESecret server is up\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cbr \/\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[ 改用 Stream 來實作 ]\u003C\/span\u003E\u003C\/b\u003E\u003Cbr \/\u003E同樣的讀檔功能，改用 Stream 的方式來實作，一切都沒問題！\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Evideo\/avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 將數據來源變成 ReadableStream, 然後 pipe 給 res\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateReadStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Exxx.avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(res)  \u003Cbr \/\u003E        .\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efinish\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E            \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003ESending done.\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E        });\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cbr \/\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E上面兩種作法的差異\u003C\/span\u003E\u003C\/h4\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003C\/b\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E\u003Cb\u003E[使用 fs.readFile()]\u003C\/b\u003E\u003C\/span\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-XpN1XUWulyU\/WABgjrdF5jI\/AAAAAAAAB4w\/eE-JHfBRuncbLclAuKQ0tw8Ol3gnsx1MACPcB\/s1600\/dump.jpg\" imageanchor=\"1\" style=\"border: 0px; clear: right; color: #333333; float: right; font-family: inherit; font-size: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin-bottom: 1em; margin-left: 1em; margin-top: 0px; outline: none; padding: 0px; text-align: center; text-decoration: none; transition: all 0.25s; vertical-align: baseline;\"\u003E\u003Cimg border=\"0\" height=\"240\" src=\"https:\/\/1.bp.blogspot.com\/-XpN1XUWulyU\/WABgjrdF5jI\/AAAAAAAAB4w\/eE-JHfBRuncbLclAuKQ0tw8Ol3gnsx1MACPcB\/s320\/dump.jpg\" style=\"border: 0px none; font-family: inherit; font-size: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; height: auto; line-height: inherit; margin: 0px; max-width: 100%; outline: none; padding: 0px; position: relative; vertical-align: baseline;\" width=\"320\" \/\u003E\u003C\/a\u003E使用\u003Cspan style=\"background-color: #fff2cc;\"\u003E \u003C\/span\u003E\u003Cspan style=\"background-color: #fff2cc;\"\u003E\u003Cspan style=\"color: #3d85c6; font-weight: bold;\"\u003Efs.readFile(\u003C\/span\u003E\u003Cspan style=\"color: #999999;\"\u003EpathToFile\u003C\/span\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E, \u003C\/span\u003E\u003Cspan style=\"color: #999999;\"\u003Efunction (err, \u003C\/span\u003E\u003Cspan style=\"color: #e06666;\"\u003Edata\u003C\/span\u003E\u003Cspan style=\"color: #999999;\"\u003E) {}\u003C\/span\u003E\u003Cspan style=\"color: #3d85c6; font-weight: bold;\"\u003E)\u003C\/span\u003E\u003C\/span\u003E 這支 Bulk I\/O API (Bulk 是一大坨的意思)，底層會將檔案內容先讀進系統緩衝之中，然後在 callback 透過 data 一次給你一大包，就像右邊這張圖的感覺。\u003Cbr \/\u003E　　這意味著，當你使用這樣的 API 存取 I\/O 時，你的 memory footprint 將有那麼一時半刻會衝到很高。如果剛剛好你的系統記憶體負載很繁重，那就只好眼睜睜看著它爆炸了 XDDD....\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E\u003Cb\u003E[使用 fs.createStream()]\u003C\/b\u003E\u003C\/span\u003E\u003Cbr \/\u003E\u003Cdiv style=\"-webkit-text-stroke-width: 0px; color: black; font-family: \u0026quot;Times New Roman\u0026quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; margin: 0px; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;\"\u003E\u003C\/div\u003E\u003Cdiv style=\"-webkit-text-stroke-width: 0px; color: black; font-family: \u0026quot;Times New Roman\u0026quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; margin: 0px; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-Q0H33m42wQ0\/WABYxbogNgI\/AAAAAAAAB4w\/x6mjkSgk55s2r7n7C-5LUh-z45XxBFcPQCPcB\/s1600\/phoca_thumb_l_PP_SUMR2013_ParkPicnic_IDEA_WaterRelay.jpg\" imageanchor=\"1\" style=\"border: 0px; clear: right; color: #333333; float: right; font-family: inherit; font-size: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin-bottom: 1em; margin-left: 1em; margin-top: 0px; outline: none; padding: 0px; text-align: center; text-decoration: none; transition: all 0.25s; vertical-align: baseline;\"\u003E\u003Cimg border=\"0\" height=\"200\" src=\"https:\/\/1.bp.blogspot.com\/-Q0H33m42wQ0\/WABYxbogNgI\/AAAAAAAAB4w\/x6mjkSgk55s2r7n7C-5LUh-z45XxBFcPQCPcB\/s320\/phoca_thumb_l_PP_SUMR2013_ParkPicnic_IDEA_WaterRelay.jpg\" style=\"border: 0px none; font-family: inherit; font-size: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; height: auto; line-height: inherit; margin: 0px; max-width: 100%; outline: none; padding: 0px; position: relative; vertical-align: baseline;\" width=\"320\" \/\u003E\u003C\/a\u003E那如果我們使用 fs 的 Readable Stream 工廠方法\u003Cspan style=\"background-color: #fff2cc;\"\u003E\u0026nbsp;\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003Efs.\u003C\/span\u003E\u003C\/b\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E\u003Cb\u003EcreateReadStream()\u003C\/b\u003E\u003C\/span\u003E\u003C\/span\u003E，將數據來源(檔案) 變成是一個 ReadableStream 呢？現在的感覺會像旁邊這張圖，數據將會是一個 chunk 一個 chunk 地傳送給消耗者，原本一大坨的數據將被切成一小塊一小塊來傳送，這每一小塊的最大容量則是由 Stream 內部緩衝區的最大容量所決定 (預設為 16 kB)。如此，我們就不必等所有數據都到達，然後才一股腦地丟出一大包。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003ENode.js API 手冊\u003C\/h3\u003E以上是一點簡單的回顧，接下來我們稍微來看一下\u003Ca href=\"https:\/\/nodejs.org\/dist\/latest-v4.x\/docs\/api\/fs.html\" target=\"_blank\"\u003E官方 API 手冊\u003C\/a\u003E的說明，這裡做一下摘要： \u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003Efs 模組幫你把標準 \u003Ca href=\"https:\/\/zh.wikipedia.org\/wiki\/POSIX\" target=\"_blank\"\u003EPOSIX\u003C\/a\u003E 的 File I\/O 操作包裝成一支支的方法\u003C\/li\u003E\u003Cli\u003EFile I\/O 的方法有 asynchronous 與 synchronous 兩種形式\u003C\/li\u003E\u003Cli\u003EAsynchronous 方法的 callback，一律遵照 Node.js 的 err-back style 慣例 (callback 函式簽署的第一個參數為 error 物件)\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-RQHGyBHPZnw\/WAw61gY9GUI\/AAAAAAAAB8Y\/PBwFcJmrkU8ezOZpDkIa76395ZiMoarwACPcB\/s1600\/fs_intrdo.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/2.bp.blogspot.com\/-RQHGyBHPZnw\/WAw61gY9GUI\/AAAAAAAAB8Y\/PBwFcJmrkU8ezOZpDkIa76395ZiMoarwACPcB\/s1600\/fs_intrdo.png\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3\u003EAsynchronous 與 Synchronous APIs\u003C\/h3\u003E以 chmod 為例，fs 提供了非同步的 fs.chmod() 與同步的 fs.chmodSync() 兩種形式：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-T7V-4HQuRqk\/WAw9HO2AOBI\/AAAAAAAAB80\/RmkQ1fPvm_AtvXcKoVgivQ4_o6J3czBHQCPcB\/s1600\/fs_chmod.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/4.bp.blogspot.com\/-T7V-4HQuRqk\/WAw9HO2AOBI\/AAAAAAAAB80\/RmkQ1fPvm_AtvXcKoVgivQ4_o6J3czBHQCPcB\/s1600\/fs_chmod.png\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E在 API 說明中的 \u003Ca href=\"http:\/\/man7.org\/linux\/man-pages\/man2\/chmod.2.html\" target=\"_blank\"\u003Echmod(2)\u003C\/a\u003E 連結會指向 Linux Programmer's Manual，你可以在那裡閱讀關於此操作的功能說明。另外，chmod\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E(2) \u003C\/span\u003E\u003C\/b\u003E中的 (2) 用於說明該方法的分類，我們可以看一下 man 的說明如下圖，(2) 是屬於 System Calls。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-BL2deRHD_w4\/WAw-EhPl6OI\/AAAAAAAAB80\/GG71sHZbmagpr2e1Sxc1IYA7Rr9KNvxpwCPcB\/s1600\/man.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/1.bp.blogspot.com\/-BL2deRHD_w4\/WAw-EhPl6OI\/AAAAAAAAB80\/GG71sHZbmagpr2e1Sxc1IYA7Rr9KNvxpwCPcB\/s1600\/man.png\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E我們在 fs 模組的手冊中，會看到很多檔案操作的方法都有非同步與同步兩種版本：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-bdJDlMRi7J4\/WAw7VJn8XEI\/AAAAAAAAB8c\/nctz22-gX3AnJkPcYUrlJvr6KUVueYMlwCPcB\/s1600\/fs_syn_async_api.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"247\" src=\"https:\/\/3.bp.blogspot.com\/-bdJDlMRi7J4\/WAw7VJn8XEI\/AAAAAAAAB8c\/nctz22-gX3AnJkPcYUrlJvr6KUVueYMlwCPcB\/s400\/fs_syn_async_api.png\" width=\"400\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E這裡附帶說明一下，\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E同步 API \u003C\/span\u003E\u003C\/b\u003E大多為 Node 內部使用，另一種情況則是在我們自己的初始化程式碼中會使用到他們。當我們的程式完成初始化，運行起來之後，整個程式就進到了事件迴圈的模式，除了有特殊需求之外，我們大部分會使用到的都是 fs 提供的非同步 APIs。\u003Cbr \/\u003E\u003Ch3\u003EStreams\u003C\/h3\u003E除了上面看到的兩種 API 的形式之外，fs 還有兩個 Stream Class：ReadStream 與 WriteStream。在實作上會更常使用 createReadStream() 與 createWriteStream() 這兩支工廠方法來將目標檔案實例化為 Streams，這在我們最上面提供的範例就有看到 createReadStream() 的用法。當然，Stream 也是屬於「非同步」的介面。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-MF1c4c_fwuk\/WAw6Be7NHWI\/AAAAAAAAB8Y\/90XzsVW6U-cAMHqfTs7Joduz4QF0_75mQCPcB\/s1600\/fs_stream_api.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"310\" src=\"https:\/\/1.bp.blogspot.com\/-MF1c4c_fwuk\/WAw6Be7NHWI\/AAAAAAAAB8Y\/90XzsVW6U-cAMHqfTs7Joduz4QF0_75mQCPcB\/s640\/fs_stream_api.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Ch3\u003E結語\u003C\/h3\u003E這邊多補充兩個小點子。如果覺得 fs 的 mkdir 不好用，推薦大家使用 substack 寫的 \u003Ca href=\"https:\/\/www.npmjs.com\/package\/mkdirp\" target=\"_blank\"\u003Emkdirp\u003C\/a\u003E，它也是一個被爆量使用的小模組。然後，我常看到有些範例在讀取 json 檔時，會使用 readFile() 或 readFileSync() 將資料讀入後，再 JSON.parse() 來產生 JS 物件。對於 json 檔，在 Node.js 中只要用\u0026nbsp;\u003Cspan style=\"background-color: #fff2cc;\"\u003E\u003Cspan style=\"color: #444444; font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace; text-align: center;\"\u003Evar\u0026nbsp;\u003C\/span\u003E\u003Cspan style=\"color: #3d85c6; font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace; text-align: center;\"\u003Efoo\u0026nbsp;\u003C\/span\u003E\u003Cspan style=\"color: #444444; font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace; text-align: center;\"\u003E= require(\u003C\/span\u003E\u003Cspan style=\"color: #3d85c6; font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace; text-align: center;\"\u003E'path\/to\/xxx\/json'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #444444; font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace; text-align: center;\"\u003E\u003Cspan style=\"background-color: #fff2cc;\"\u003E)\u003C\/span\u003E\u0026nbsp;\u003C\/span\u003E就可以將 json 讀入成為物件了(這應該蠻多人都知道啦)，這是因為 Node 的 require 系統\u003Ca href=\"https:\/\/github.com\/nodejs\/node\/blob\/master\/lib\/module.js#L586-L595\" target=\"_blank\"\u003E原始碼\u003C\/a\u003E很佛心幫我們處理掉了。\u003Cbr \/\u003E　\u003Cbr \/\u003E　　最後來個總結，Node.js 的 fs 模組提供給我們的三種不同類型的 APIs 有：\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E同步的：結果(或資料) 以 return 傳回\u003C\/li\u003E\u003Cli\u003E非同步的：結果(或資料) 傳回給 callback，或說我們使用 callback 來接回結果\u003C\/li\u003E\u003Cli\u003EStream：結果(或資料) 以事件的方式傳回，或說我們使用 event handler 來接回結果\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/5466069941000596365\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/11\/nodejs-fs-apis_12.html#comment-form","title":"0 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/5466069941000596365"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/5466069941000596365"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/11\/nodejs-fs-apis_12.html","title":"Node.js fs 模組  APIs 的三種類型"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/1.bp.blogspot.com\/-XpN1XUWulyU\/WABgjrdF5jI\/AAAAAAAAB4w\/eE-JHfBRuncbLclAuKQ0tw8Ol3gnsx1MACPcB\/s72-c\/dump.jpg","height":"72","width":"72"},"thr$total":{"$t":"0"}},{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-8021532719657076239"},"published":{"$t":"2016-10-15T17:45:00.001+08:00"},"updated":{"$t":"2016-10-18T22:39:54.006+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"node"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"}],"title":{"type":"text","$t":"海納百川：Node.js Streams"},"content":{"type":"html","$t":"\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E一、前言\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E前些日子，我發表了一篇「\u003Ca href=\"https:\/\/simeneer.blogspot.tw\/2016\/09\/nodejs-eventemitter.html\" target=\"_blank\"\u003E非同步程式碼之霧：Node.js 的事件迴圈與 EventEmitter\u003C\/a\u003E」，受到社群很大的迴響，謝謝的大家對它的喜歡。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　我心中主觀地認為，只要搞懂非同步程式碼、事件迴圈、EventEmitter 以及 \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003EStream\u003C\/span\u003E\u003C\/b\u003E，對於 Node.js 的基本認識就應該有 6 ~ 7 成左右了，不僅 Node 核心程式碼實作，包含我們的開發工作，幾乎無時無刻都圍繞在這些概念之上。我相信對這些基礎的認識，能有助於開發者提升 Node.js 程式碼的撰寫品質，同時我也非常鼓勵新手在早期就能夠以偏向基礎的角度來認識 Node.js (我知道新手在越閱讀這些東西時，可能會有一點障礙。但是沒關係，多聽多看總是好的。體悟總有一天會降臨。)\u003Cbr \/\u003E　\u003Cbr \/\u003E　　因為 Streams 的原始碼很多，所以我盡量把它們的理念用畫圖的方式給表現出來，然後再以看圖說故事的方式，試著將 Streams 的內部運作給整理出來。原本還有放一些例如 read()、write() 與 push() 等等的原始碼，但後來覺得似乎沒必要，因為覺得看圖說故事就可以表達的不錯了。然後，假使你沒有時間閱讀這篇文章，可以直接跳到\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E「以使用者角度看 Stream」\u003C\/span\u003E\u003C\/b\u003E一節，那裡整理的內容極簡，應該\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E\u0026nbsp;2 分鐘\u003C\/span\u003E\u003C\/b\u003E就可以看完，純然只是如何使用標準介面而已，其實對普通的開發工作應該也算夠了。\u003Cbr \/\u003E\u003Cbr \/\u003E　　然後，建議開始閱讀前，先深呼吸一下，因為這篇內容也蠻長的。但有靜下心來看，應該也是 20 ~ 25 分鐘左右可以搞定。如果你也看過「非同步程式碼之霧」，這篇長度有稍短一些，但也沒差多少。看這兩篇花不到 1 個小時，我個人其實覺得很划算。如果你現在還沒下定決心要看，我是建議就先不要看，等到靜下心時再看比較好，吸收的 CP值比較高。 (不覺得我有病嗎？連要人看一篇文章，都還要有工程師思維。是的我有病。)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　由於這些技術內容並沒有人幫我校稿，內容難免有誤。在此要謝謝社群朋友們對「非同步程式碼之霧」一文的提醒、糾正以及幫忙測試，本篇同樣還是得請大家多多幫忙，讓我們能夠一起將文章的內容做到最正確。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cspan style=\"font-size: x-small;\"\u003E(原本有計畫寫一系列如何撰寫 module 的文章，但我發現那類型的文章太多了，好像不差我那幾篇 XDD～ 所以只寫了\u003Ca href=\"https:\/\/simeneer.blogspot.tw\/2016\/09\/npm-node-i.html\" target=\"_blank\"\u003E第一篇\u003C\/a\u003E我就決定先暫停，我真的不是故意找藉口不寫哦！好啦！如果真的有人想看，再請告訴我囉～)\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E二、為什麼要談 Stream\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E與 Unix 有著同樣的信仰，Node.js 同樣信奉「Small Modules」以及「\u003Ca href=\"https:\/\/en.wikipedia.org\/wiki\/Unix_philosophy#Doug_McIlroy_on_Unix_programming\" target=\"_blank\"\u003EDo One Thing and Do It Well\u003C\/a\u003E」的哲學：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Cspan style=\"font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003EWrite programs that do one thing and do it well. Write programs to work together. Write programs to handle text streams, because that is a universal interface. - D. McIlroy\u003C\/span\u003E\u003C\/blockquote\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　在類 Unix 的系統，有個東西叫 pipe (在命令行的符號是 | )，讓我們看看 \u003Ca href=\"https:\/\/zh.wikipedia.org\/wiki\/%E7%AE%A1%E9%81%93_(Unix)\" target=\"_blank\"\u003Ewiki 怎麼說\u003C\/a\u003E\u0026nbsp;(我不會說的比較好)，這裡隨便寫一個範例吧！我們把對根目錄 \/ 給 ls 出來的結果，當成 sort 工具的輸入，做完反序後的輸出，當成 grep 的輸入，然後找出含有 e 字母的字串：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E~\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E$ ls \/ \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E|\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E sort -r \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E|\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E grep  e\u003Cbr \/\u003Em\u003C\/span\u003E\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003Ee\u003C\/span\u003E\u003C\/b\u003E\u003Cspan style=\"color: #333333;\"\u003Edia\u003Cbr \/\u003Ehom\u003C\/span\u003E\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003Ee\u003C\/span\u003E\u003C\/b\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003Ee\u003C\/span\u003E\u003C\/b\u003E\u003Cspan style=\"color: #333333;\"\u003Etc\u003Cbr \/\u003Ed\u003C\/span\u003E\u003Cspan style=\"color: #e06666;\"\u003Ee\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003Ev\u003C\/span\u003E\u003C\/pre\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E總之，因為 Stream 是一種標準介面，我們可以使用 pipe 輕易地將各種小工作給串聯起來，組合成更大的功能(或工作)。\u003Cbr \/\u003E\u003Cbr \/\u003E　　Node.js 也 in-program 實現了這樣的哲學，名字正是 Stream，它不單單只是文字流(或數據流)，也支援物件流。同時，它一樣是一種「Universal Interface」。在 Node 中，你可以寫出類似這樣的程式碼：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EA\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EB\u003C\/span\u003E).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EC\u003C\/span\u003E).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003ED\u003C\/span\u003E);\u003C\/pre\u003E例如 Node 官網上的檔案壓縮範例：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Egzip\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ezlib\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateGzip\u003C\/span\u003E();\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Efs\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Einp\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateReadStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Einput.txt\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eout\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateWriteStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Einput.txt.gz\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Einp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(gzip).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(out);\u003C\/pre\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E　　由於小模組的理念，再加上 Node.js 核心以及大量第三方函式庫皆以 Stream 實作，又或者提供有 Stream 的介面，以及 Node.js 在 Networking 的強項更是與 Stream 密不可分。這使得 Stream \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E幾乎是公認 Node.js 開發者必不可少的基礎知識之一\u003C\/span\u003E\u003C\/b\u003E。這正是為什麼我想要寫一篇文章來聊一下 Stream，而更重要的是巨人 \u003Ca href=\"https:\/\/github.com\/dominictarr\" target=\"_blank\"\u003EDominic Tarr\u003C\/a\u003E\u0026nbsp;說的一句話：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Cspan style=\"font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003EStreams are node's best and most misunderstood idea, ... - D. Tarr, EventStream\u003C\/span\u003E\u003C\/blockquote\u003E驅使著我想要好好搞懂 Node Streams。我將自己的學習過程以及理解整理起來，希望能為再為台灣 Node.js 開發者們帶來一篇值得一讀的文章。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E三、console.log\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E每天苦惱的 Node 工程師總是會在程式裡寫上這麼一兩句：\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E \u0026nbsp;\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EFuxking explode here, go die fuxk face\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E); \/\/ 幹嘛跟電腦生氣呢！奇怪ㄋㄟ\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E我們到 \/lib\/console.js 看一下，疑？在 new 的時候傳了 process.stdout 跟 process.stderr 給它\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Emodule\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eexports\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EConsole\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprocess\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Estdout\u003C\/span\u003E, \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprocess\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Estderr\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EConsole\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Estdout\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Estderr\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eprop\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Evalue\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E stdout;\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EObject\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EdefineProperty\u003C\/span\u003E(\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E, \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E_stdout\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, prop);\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eprop\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Evalue\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E stderr;\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EObject\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EdefineProperty\u003C\/span\u003E(\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E, \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E_stderr\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, prop);\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E}\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E當你呼叫 console.log 時，其實只是使用了 process.stdout.write() 啊!! 不過 console.log() 比較好心，會幫你換行 XDDD \u0026nbsp;(最後有個 '\\n')\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EConsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprototype\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Elog\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E() {\u003Cbr \/\u003E  \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_stdout\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ewrite\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eutil\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eformat\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eapply\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Enull\u003C\/span\u003E, \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Earguments\u003C\/span\u003E) \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E+\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003Cspan class=\"pl-cce\" style=\"box-sizing: border-box;\"\u003E\\n\u003C\/span\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E};\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　那麼 process.stdout 跟 process.stderr 又在哪裡？這個我就不要列太多程式碼，你可以在 \/src\/node.js 的核心初始化程式碼的 stratup() =\u0026gt; startup.processStdio() 找到它們。比較重要的就以下這 4 行：\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E   \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E   stdout \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateWritableStdioStream\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1\u003C\/span\u003E);\u003Cbr \/\u003E   \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E   stderr \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateWritableStdioStream\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E2\u003C\/span\u003E);\u003Cbr \/\u003E   \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E   \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E fd \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E;\u003Cbr \/\u003E   stdin \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Etty.ReadStream\u003C\/span\u003E(fd, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E...\u003C\/span\u003E);\u003Cbr \/\u003E   \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　你可以知道 stdin, stdout, 與 stderr 即對應到作業系統的標準輸入串流 (fd =0, \/dev\/stdin)、標準輸出串流 (fd=1, \/dev\/stdout) 以及標準錯誤輸出串流 (fd=2, \/dev\/stderr)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　會以 console.log() 出發的用意是想告訴你，其實你一天到晚都在用 Stream，所以不要怕他啊！會使用 console.log() debug 的人一定是全天下使用 Stream 最多的人！哈哈哈... (我本人是也～)　所以不要再說你不會用 Stream 啦～(裝死...)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E四、Stream 的結構\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003EStream 除了是資料的來源 (source) 或終點 (sink) 之外，它還是一種「資料流控制」的單元，由於牽涉到資料的控制、存取、流動與暫存，Stream 的每個實例內部都有維護有自己的狀態，每個 Stream 實例都是一個狀態機，這些狀態用於指明 Stream 目前是處在 Flowing 還是 Paused 模式等，Stream 於不同的模式有不同的行為。\u003Cbr \/\u003E\u003Cbr \/\u003E　　由於它有點複雜，所以接下來我所引用的程式碼，只會剪出比較重要的片段，有達到我想表達的意思就好。Steam 的實作落在 Node 原始碼 \/lib 目錄底下的 \u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E_stream_readable.js\u003C\/li\u003E\u003Cli\u003E_stream_writable.js\u003C\/li\u003E\u003Cli\u003E_stream_transform.js\u003C\/li\u003E\u003Cli\u003E_stream_duplex.js\u003C\/li\u003E\u003Cli\u003Estream.js (以上四個都繼承了這個 Base Class)\u003C\/li\u003E\u003C\/ul\u003E我們從 stream.js 開始看起 (以 4.5.0 原始碼為例)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[ stream.js ]\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003EStream 這個 Class 以靜態屬性 export 出了 Readable、Writable、Duplex、Transform 以及 PassThrough 這幾個 Classes。\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Emodule\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eexports\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E Stream;\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EEE\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevents\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);    \/\/ \u0026lt;--- EventEmitter\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eutil\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eutil\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eutil\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Einherits\u003C\/span\u003E(Stream, \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EEE\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EStream\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EReadable\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E_stream_readable\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EStream\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EWritable\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E_stream_writable\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EStream\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EDuplex\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E_stream_duplex\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EStream\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003ETransform\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E_stream_transform\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EStream\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EPassThrough\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E_stream_passthrough\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EStream\u003C\/span\u003E() {\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EEE\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ecall\u003C\/span\u003E(\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E);\u003Cbr \/\u003E}\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E然後你應該也發現到了，Stream 繼承了 EventEmitter！所以它可以發射事件、你也可以監聽它身上的事件。很重要，再複誦一遍：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Cspan style=\"background-color: #ffe599; color: #e06666; font-size: x-large;\"\u003E\u003Cb\u003E　Stream 是 EventEmitter　\u003C\/b\u003E\u003C\/span\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[ _stream_readable.js ]\u003C\/span\u003E\u003C\/b\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003EReadable() 是一個 Constructor，它的每個實例都擁有自己的狀態 this._readableState，另外，還有一支必須由 ReadableStream 實作者所提供的 template method \u003Cb style=\"background-color: #fce5cd;\"\u003Ethis._read()\u003C\/b\u003E。\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EReadable\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eoptions\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_readableState\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EReadableState\u003C\/span\u003E(options, \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E);  \/\/ \u0026lt;-- 狀態物件\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (options \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026amp;\u0026amp;\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Etypeof\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eoptions\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eread\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efunction\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E)\u003Cbr \/\u003E    \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_read\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eoptions\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eread\u003C\/span\u003E;  \/\/ \u0026lt;-- template method, 由 Stream 實作者提供\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EStream\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ecall\u003C\/span\u003E(\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E);\u003Cbr \/\u003E}\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E我們來看一下狀態物件的建構子，它裡面的狀態非常的多，但是我這裡就剪出它最重要的一個：內部緩衝區\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EReadableState\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eoptions\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Estream\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ebuffer\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E [];  \/\/ \u0026lt;-- 緩衝區僅僅是一個陣列\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E}\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　嘿！注意到了嗎？內部緩衝區只是一個陣列，剛初始化時它空空的。由於 Stream 有一個稱為 highWaterMark (HWM) 的屬性，用來限制緩衝區最大可容納的 bytes 數，它的預設值是 16 kB，最大值不可超過 8 MB。這邊我們引出了第二個重點，我們再複誦一遍：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Cspan style=\"background-color: #ffe599; color: #e06666; font-size: x-large;\"\u003E\u003Cb\u003E　Stream 是 EventEmitter 與 Buffer 的組合　\u003C\/b\u003E\u003C\/span\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E這我們後面看到「圖」的時候，會更有感覺！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[ _stream_xxx.js ]\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E雖然 Readable、Writable、Duplex、Transform 有不同的實作內容，但是關於 Stream 是 EventEmitter 與 Buffer 的組合，我們上面已經看過一個 Readable，其它的也具有相同性質，所以程式碼我想就不用再貼上來了啦。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E五、Stream 的大意\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003EStream 的實作是單純的 JavaScript，它繼承自 EventEmitter，而且內部擁有一個緩衝區。緩衝區直接的目的是為了做流速控制，間接的好處是能夠使你的程式維持較精省的 memory footprint。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　現在想像一個場景，你有一個數據來源，也有一個數據消耗者。若數據來源與消耗者都是 Stream 的實作，我們可以這樣說：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cblockquote class=\"tr_bq\"\u003E一個 ReadableStream 是數據產生者 (source)\u003Cbr \/\u003E一個 WritableStream 是數據消耗者 (sink)\u003C\/blockquote\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E流速控制 (Backpressure 與 Throttling)\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E當 sink 消耗速度慢，但 source 的產生速度快，這時候該怎麼辦？\u003Cbr \/\u003E\u003Cbr \/\u003E　　如果是由我們自己來蠻幹，首先想到的辦法，大概也就是先將「速度快」的來源數據先「暫存(緩衝)」起來，然後再慢慢地消耗掉。(嘿！Stream 已經有緩衝區了呀！)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　那麼，我怎麼會知道「消耗者」的速度比較慢？沒問題！一個 WritableStream \u0026nbsp;具有 Backpressure (背壓) 機制，當它的消耗速度跟不上輸入時，它會發事件通知你(在內部緩衝區溢出時)，此時你有責任先暫停輸入數據。我們後面會把 Backpressure 講清楚。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　另外一種情況，如果我想要將數據來源的速度調慢，調成我想要的速度呢？當成也可以！這樣的變速 (節流, throttling) 機制，也是靠一個緩衝區先將數據收集下來，再以我們想要的速度來輸出即可 (例如從 100 kB\/s 降成 50 kB\/s 的資料率)。當然，實作者有時候還得搭配 Backpressure 機制來做流量控制。(那能不能調快速度？當然可以，不過這取決於你到底想要什麼樣的數據。調快調慢，都可以靠 Transform 來完成。)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E節省 Memory Footprint\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E這裡給個大家都很喜歡使用的範例，一看你就懂什麼意思了。假設我現在有一個「史詩級的大\u003Cstrike\u003E謎片\u003C\/strike\u003E檔案 xxx.avi」，它的大小有 2 GB (高畫質的喲!!)。我想要寫個 http server 來分享給我的朋友，以顯示我與眾不同的宅：\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E~\u003C\/span\u003E$ ll xxx.avi\u003Cbr \/\u003E-rw-rw-r-- 1 simen simen \u003C\/span\u003E\u003Cspan style=\"color: #674ea7;\"\u003E2097152000 \u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003EOct 14 11:13 xxx.avi\u003C\/span\u003E\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E什麼？？！！你沒有謎片可以測試 (睜眼說瞎話就對了)... 那用 dd 產生一個：\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E~\u003C\/span\u003E$ dd if=\/dev\/zero of=xxx.avi bs=2097152000 count=1\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0; font-size: large;\"\u003E[使用 fs.readFile() 來實作 ]\u003C\/span\u003E\u003C\/b\u003E\u003Cbr \/\u003E　　下面我們的祕密伺服器 server.js，它使用 fs.readFile() 來讀檔，當有 request 進來的時候，我們把檔案送過去給瀏覽器。我們順便檢測一下錯誤，若有錯誤就把它印出來：\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E http \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Ehttp\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E fs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EreadFile\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Exxx.avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eerr\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E) {    \/\/ \u0026lt;-- 讀檔\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (err) {\u003Cbr \/\u003E            \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(err);\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E500\u003C\/span\u003E);\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eerr\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Emessage\u003C\/span\u003E);\u003Cbr \/\u003E        } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Evideo\/avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(data);\u003Cbr \/\u003E        }\u003Cbr \/\u003E    });\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eserver\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Elisten\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E3000\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003ESecret server is up\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E執行 server.js 並開啟瀏覽器到 http:\/\/locahost:300 來下載檔案。結果令人失望，它爆炸了：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-T8xFexdixBI\/WABaIwBKL5I\/AAAAAAAAB4w\/3FM0qpe1ndUY60EKPlFo3y36LME1R-XEgCPcB\/s1600\/buffer_explosion.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"206\" src=\"https:\/\/2.bp.blogspot.com\/-T8xFexdixBI\/WABaIwBKL5I\/AAAAAAAAB4w\/3FM0qpe1ndUY60EKPlFo3y36LME1R-XEgCPcB\/s640\/buffer_explosion.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cspan style=\"color: #999999;\"\u003E\u003Cb\u003E註\u003C\/b\u003E：在你的環境測試這個例子可能不會爆炸，但瀏覽器在準備收檔前等待的時間會卡的有點久，檔案越大，會卡越久。又或者你得到的錯誤可能跟我不同，例如你的物理記憶體根本不夠塞不下這麼大的檔案之類的，也會引發 create buffer 的錯誤。\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　為了讓這個錯誤出現，我有刻意退回較舊版本的 Node 來執行，原因是舊版本的 kMaxLength 是直接寫死為 0x3ffffff (1023 MB)，新版本的 Node 會依據系統的整數指標長度來切換不同的 kMaxLength。你可以在 \/src\/node_buffer.h 看到 kMaxLength 這個參數：\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Estatic\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eunsigned\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eint\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EkMaxLength\u003C\/span\u003E =\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Esizeof\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eint32_t\u003C\/span\u003E) == \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Esizeof\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eintptr_t\u003C\/span\u003E) ? 0x3fffffff : 0x7fffffff;\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E會不會爆炸反映在 \/lib\/fs.js：\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (size \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026gt;\u003C\/span\u003E kMaxLength) {\u003Cbr \/\u003E    err \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003ERangeError\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EFile size is greater than possible Buffer: \u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E+\u003C\/span\u003E\u003Cbr \/\u003E                         \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E`\u003C\/span\u003E0x\u003Cspan class=\"pl-s1\" style=\"box-sizing: border-box; color: #333333;\"\u003E\u003Cspan class=\"pl-pse\" style=\"box-sizing: border-box;\"\u003E${\u003C\/span\u003E\u003Cspan class=\"pl-smi\" style=\"box-sizing: border-box;\"\u003EkMaxLength\u003C\/span\u003E.\u003Cspan class=\"pl-c1\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EtoString\u003C\/span\u003E(\u003Cspan class=\"pl-c1\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E16\u003C\/span\u003E)\u003Cspan class=\"pl-pse\" style=\"box-sizing: border-box;\"\u003E}\u003C\/span\u003E\u003C\/span\u003E bytes\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E`\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econtext\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eclose\u003C\/span\u003E(err);\u003Cbr \/\u003E  }\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003C\/b\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0; font-size: large;\"\u003E[ 改用 Stream 來實作 ]\u003C\/span\u003E\u003C\/b\u003E\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: justify; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Evideo\/avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateReadStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Exxx.avi\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(res)  \/\/ \u0026lt;-- 將數據來源變成 ReadableStream\u003Cbr \/\u003E        .\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efinish\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E            \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003ESending done.\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E        });\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cdiv style=\"text-align: justify;\"\u003E上面的程式碼看不到懂沒關係，等到這篇文章讀完，你一定能瞭若指掌！總之，我們再次執行看看，然後用瀏覽器下載。看！成功了！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-z05SrcjXhAU\/WAHwHVbyXuI\/AAAAAAAAB7M\/5i4Vih9wCQI7D67zxtxHE-hDaU4jm1LewCLcB\/s1600\/download_ok.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/3.bp.blogspot.com\/-z05SrcjXhAU\/WAHwHVbyXuI\/AAAAAAAAB7M\/5i4Vih9wCQI7D67zxtxHE-hDaU4jm1LewCLcB\/s1600\/download_ok.jpg\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E上面兩種作法的差異\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E使用 \u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003Efs.readFile(pathToFile, function (err, \u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003Edata\u003C\/span\u003E\u003C\/b\u003E) {})\u003C\/span\u003E 這支 API，\u003Cb\u003E底層會將檔案內容先讀進系統緩衝之中，然後在 callback 透過 data 一次給你一大包\u003C\/b\u003E，就像下面這張圖的感覺。\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-XpN1XUWulyU\/WABgjrdF5jI\/AAAAAAAAB4w\/eE-JHfBRuncbLclAuKQ0tw8Ol3gnsx1MACPcB\/s1600\/dump.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"300\" src=\"https:\/\/1.bp.blogspot.com\/-XpN1XUWulyU\/WABgjrdF5jI\/AAAAAAAAB4w\/eE-JHfBRuncbLclAuKQ0tw8Ol3gnsx1MACPcB\/s400\/dump.jpg\" width=\"400\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Ca href=\"https:\/\/i.ytimg.com\/vi\/gq5eQeFj4-8\/hqdefault.jpg\" target=\"_blank\"\u003E\u003Cspan style=\"font-size: x-small;\"\u003E圖片來源\u003C\/span\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　這樣的 API 也稱為 Bulk I\/O，Bulk 是一大坨的意思。這意味著，當你使用這樣的 API 存取 I\/O 時，你的 memory footprint 將有那麼一時半刻會衝到很高。如果剛剛好你的系統記憶體負載很繁重，那就只好眼睜睜看著它爆炸了 XDDD....\u003Cbr \/\u003E　　\u003Cbr \/\u003E　　那如果我們使用 fs 的 Stream 工廠方法 createReadStream()，將數據來源(檔案) 變成是一個 ReadableStream 呢？現在的感覺會像下面這張圖，數據將會是一個 chunk 一個 chunk 地傳送給消耗者，原本一大坨的數據將被切成一小塊一小塊來傳送，這每一小塊的最大容量則是由 Stream 內部緩衝區的最大容量所決定 (預設為 16 kB)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-Q0H33m42wQ0\/WABYxbogNgI\/AAAAAAAAB4w\/x6mjkSgk55s2r7n7C-5LUh-z45XxBFcPQCPcB\/s1600\/phoca_thumb_l_PP_SUMR2013_ParkPicnic_IDEA_WaterRelay.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"250\" src=\"https:\/\/1.bp.blogspot.com\/-Q0H33m42wQ0\/WABYxbogNgI\/AAAAAAAAB4w\/x6mjkSgk55s2r7n7C-5LUh-z45XxBFcPQCPcB\/s400\/phoca_thumb_l_PP_SUMR2013_ParkPicnic_IDEA_WaterRelay.jpg\" width=\"400\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Ca href=\"http:\/\/www.honeybearlane.com\/wp-content\/uploads\/2013\/05\/phoca_thumb_l_PP_SUMR2013_ParkPicnic_IDEA_WaterRelay.jpg\" target=\"_blank\"\u003E\u003Cspan style=\"font-size: x-small;\"\u003E圖片來源\u003C\/span\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　又或者說，Stream 可以是動態的，\u003Cb\u003E數據來就送、來就送，不必等所有數據都到達，然後才一股腦地丟出一大包\u003C\/b\u003E。因此，在使用 Stream 的情況下，就不會有 memory footprint 瞬間飆很高的情況發生。如此一來，網路中 client\/server 之間的互動反應就能更加即時 (只要一收到 request，第一個 chunk 就能透過 response 馬上飛奔出去)。\u003Cbr \/\u003E\u003Cbr \/\u003E　　相信現在您對「Stream 的大意與好處」應該已經稍稍有概念了，接下來，我們就要進入更深一層的解析了。不過別擔心，更深一層也沒多深啦... XDDD (不要嗆我啊!!)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E六、Stream1、Stream2、Stream3 與相關函式庫\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E在開始偷窺 Stream 的內褲 (內部啦!) 之前，先很簡單摘要一下 Stream 的版本變化。這裡大家先很約略看一就好，等稍後從內褲鑽出來之後，再回來看這裡，你就會發現有點臭臭的～ (靠夭啊....)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　Node.js 的 Stream 自第一版的 Stream1 (Node v0.8) 演化至今，已經歷經 Stream2 (\u0026gt; \u0026nbsp;v0.10) 而來到 Stream3 (\u0026gt; v0.12)。這裡我先很簡單地作一下摘要：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E\u003Cb\u003E[ Stream1 ]\u003C\/b\u003E\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cul\u003E\u003Cli\u003E使用 Push Model，即\u003Cb\u003E有資料來，Stream 自動發射 'data' 事件伴隨 data chunk 以將資料推出去\u003C\/b\u003E，這稱為 \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003EFlowing Mode (流動模式)\u003C\/span\u003E\u003C\/b\u003E。\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E\u003Cb\u003E[ Stream2 ]\u003C\/b\u003E\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cul\u003E\u003Cli\u003E預設為 Pull Model，即\u003Cb\u003E有資料來時，Stream 將資料累積於內部緩衝區中，並同時發射一個 'readable' 事件來通知 Stream 的使用者\u003C\/b\u003E，將資料取走 (使用 read() 方法)。若使用者沒有取走，資料將繼續累積於內部緩衝區。\u003C\/li\u003E\u003Cli\u003EStream2 的預設模式也稱為 \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003EPaused Mode\u003C\/span\u003E\u003C\/b\u003E 或 \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003ENon-Flowing Mode (非流動模式)\u003C\/span\u003E\u003C\/b\u003E。\u003C\/li\u003E\u003Cli\u003E當 Stream 不再自動將資料推出來、使用者可以自己決定要不要拉出資料，意味著使用者控制「資料流動」的彈性增加了。\u003C\/li\u003E\u003Cli\u003E使用者仍可以將 Stream 轉回 Flowing Mode 來使用，只要掛上 'data' 事件的監聽器或呼叫 resume() 即可。\u003C\/li\u003E\u003Cli\u003E\u003Cb\u003EFlowing\/Non-flowing 模式只能擇一使用\u003C\/b\u003E，即你的程式碼中不可以同時有 'data' 的監聽器以及 'readable' 的監聽器。若兩者兼有之，程式不會當掉，但是你可能會得到非預期的 Stream 行為。\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E\u003Cb\u003E[ Stream3 ]\u003C\/b\u003E\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cul\u003E\u003Cli\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E\u003Cb\u003E混合模式(Mixed mode)\u003C\/b\u003E\u003C\/span\u003E，推拉模型混在一起，程式碼中\u003Cb\u003E可以同時有 'data' 的監聽器以及 'readable' 的監聽器\u003C\/b\u003E，行為容我後面再說明。\u003C\/li\u003E\u003Cli\u003E一般還是建議維持 Flowing \/ Non-Flowing 模式擇一使用的習慣，通常混著用的機會可能也不大 (或許是有很棒的使用時機？這要請高手指點一下～)。\u003C\/li\u003E\u003Cli\u003EStream3 開始，幾乎都是 performance 調整與 bug 的修正，Stream 的介面與行為看起來目前是穩定下來了。\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E\u003Cb\u003E[ 相關函式庫 ]\u003C\/b\u003E\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cul\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.npmjs.com\/package\/readable-stream\" target=\"_blank\"\u003Ereadable-stream\u003C\/a\u003E：Node Stream2 與 Stream3 實作的獨立抽離版本，有了它，你就能在瀏覽器端擁有 Stream 啦！\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.npmjs.com\/package\/mississippi\" target=\"_blank\"\u003Emississippi\u003C\/a\u003E：Stream 的輔助工具集合，可協助你快速實作 ReadableStream、WritableStream 等等(主要是擺脫一些 boilerplate code)，當然你也能直接使用 \u003Ca href=\"https:\/\/www.npmjs.com\/package\/from2\" target=\"_blank\"\u003Efrom2\u003C\/a\u003E、\u003Ca href=\"https:\/\/www.npmjs.com\/package\/through2\" target=\"_blank\"\u003Ethrough2\u003C\/a\u003E、\u003Ca href=\"https:\/\/www.npmjs.com\/package\/duplexer2\" target=\"_blank\"\u003Eduplexer2\u003C\/a\u003E 這些工具來協助你\u003C\/li\u003E\u003Cli\u003E如果要做 Stream 的合併、串連等工作，可以使用 \u003Ca href=\"https:\/\/www.npmjs.com\/package\/multipipe\" target=\"_blank\"\u003Emutilpipe\u003C\/a\u003E 或 \u003Ca href=\"https:\/\/www.npmjs.com\/package\/pumpify\" target=\"_blank\"\u003Epumpify\u003C\/a\u003E 等工具\u003C\/li\u003E\u003Cli\u003E以上介紹的都是使用量破表的函式庫，另外還有一個我覺得超威的，就是 \u003Ca href=\"https:\/\/www.npmjs.com\/package\/highland\" target=\"_blank\"\u003Ehighland.js\u003C\/a\u003E，它的夢想是將一切給 Stream 化，夠瘋狂吧！\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　接下來，我們終於可以開始來看 Stream 內部的運作機制了！因為數據就是從來源流向消耗者，所以一開始我們會花點篇幅在 ReadableStream 上面，接著 WritableStream 就快了，然後 Transform 跟 Duplex 就只是短短幾句話的事情而已！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　我們會先從「\u003Cb\u003E內部原理與 Stream 實作者\u003C\/b\u003E」的角度切入，先把各類 Streams 跑過一遍。隨後再以「\u003Cb\u003EStream 使用者\u003C\/b\u003E」的角度來看 Stream，這也是大部分開發者的角度，大多時候我們都是 Stream 的使用者！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E(礙於篇幅，我們不談如何實作自己的 Stream，但是你了解原理之後，會發現要利用 Stream 的基礎建設來設計自己的 Stream 就不會太難了。)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E七、Readable Stream\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E我們先從 Readable Stream 的 Flowing Mode 看起 (掛上 'data' 事件監聽器來接收數據)，我相信這也是很多人喜歡的方式。然後，我們再看 Non-flowing Mode (掛上 'readable' 監聽器來獲取數據到來的通知)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003EReadable Stream：Flowing Mode\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E下面這張圖，藍色布景內的東西是 Stream 內部示意圖，它設有緩衝區水桶一個；鐵灰色的部分是 Stream 要求「Stream 實作者」應該要提供實作的部分。而藍色布景的外面，事件 'error' 以及 方法 pause() 這種東西，\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E它們是 Readable Stream 的標準介面\u003C\/span\u003E\u003C\/b\u003E。之後我們遇到的圖，都是以這樣的方式來佈局。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　接下來，依照圖中標示的 (1), (2), ... (6) 一個個看起，看看狀態處在 Flowing Mode 的 ReadStream 是如何工作的：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-Hp9obkaqAo0\/WACiTJUneYI\/AAAAAAAAB44\/7nz04OZVZHAdE-u9h2B_RZAfYF4okt8WwCPcB\/s1600\/readable2.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"350\" src=\"https:\/\/4.bp.blogspot.com\/-Hp9obkaqAo0\/WACiTJUneYI\/AAAAAAAAB44\/7nz04OZVZHAdE-u9h2B_RZAfYF4okt8WwCPcB\/s640\/readable2.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Col\u003E\u003Cli\u003E\u003Cb\u003EResource 是數據來源\u003C\/b\u003E，例如一支檔案、一個 socket、或某種數據產生源。這包含在「實作者提供的實作」中，Stream Class 是基礎建設，數據源得由實作者決定呀！\u003C\/li\u003E\u003Cli\u003E\u003Cb\u003E_read() 這支 template method 由 ReadableStream 實作者提供\u003C\/b\u003E，實作內容正是鐵灰色區塊的部分。\u003C\/li\u003E\u003Cli\u003E當實作者從 Resource 拿到一些數據後，他必須\u003Cb\u003E使用 \u003Cspan style=\"background-color: #fce5cd;\"\u003Ethis.push(chunk)\u003C\/span\u003E 將資料塊推入內部緩衝區\u003C\/b\u003E。注意圖中有兩處 (3)，上者表示數據推入緩衝區，下則對應到 _read() 的實作在某處一定會呼叫 this.push()。當水桶滿了 (達到 highWaterMark)，呼叫 push() 將傳回 \u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003Efalse\u003C\/span\u003E\u003C\/b\u003E，讓實作者知道水桶已經滿了，此時實作者必須暫時停止再從 Resource 讀資料出來。此機制稱為 \u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003EBackpressure\u003C\/span\u003E\u003C\/b\u003E，不過這裡是實作者要去照顧的事情。我們在後面以「Stream 使用者」角度切入時，我們使用者需要照顧的是 WritableStream 的 Backpressure。\u003C\/li\u003E\u003Cli\u003E在 Flowing Mode，如果 ReadableStream 沒有被 pause() 住，\u003Cb\u003E那麼由 (3) push 進來的 chunk 就會馬上從白色 (4) 的水管噴出去，不會累積在緩衝區，因此稱為流動模式\u003C\/b\u003E。噴出去的東西預設是 binaries (型別為 Buffer)，如果有設定 encoding，也可以直接噴出字串。黑色 (4) 是指 ReadableStream 的使用者可以呼叫 \u0026nbsp;resume() 或 pause() 來開關資料流動，水管不是 ON 就是 OFF。當 pause() 後，由 (3) 所推入的資料塊，就會在緩衝器中累積起來。由於 Stream2 開始，Stream 的預設模式就是 paused mode，因此我們會常常看到一些程式碼在一開頭都會先呼叫 readable.resume()。在 Stream2\/3，其實你只要在 ReadableStream 掛上 'data' 事件監聽器，Stream 就會以 Flowing Mode 操作了，除非你有刻意呼叫 pause() 關閉水管。\u003C\/li\u003E\u003Cli\u003E當每次 push 資料進水桶時，Stream 都會檢查目前水位是否已經達到 highWaterMark (HWM)，如果已滿，呼叫 push() 將傳回 false。highWaterMark 是可以自己設定的， 預設是 16 kB，最高可以設到 8 MB。注意，\u003Cb\u003Epush() 方法是給「實作者」用的 API\u003C\/b\u003E，而不是給「使用者」用的。\u003C\/li\u003E\u003Cli\u003E\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E在 Flowing Mode「使用者」監聽 'data' 事件就可以拿到從 source 流過來的資料。\u003C\/span\u003E\u003C\/b\u003E\u003C\/li\u003E\u003Cli\u003E'error' 跟 'close' 是所有類型 Streams 都有的標準事件，'error' 通知錯誤，而 'close' 通知底層 Resource 的關閉，並不是所有的 ReadableStream 都有 'close' 事件，因為數據來源不一定總是 I\/O 之類的資源。\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E'end' 是 ReadableStream 的專屬事件，它用來通知「使用者」本次的這一大坨數據已經傳輸完畢\u003C\/span\u003E\u003C\/b\u003E (一大坨是被拆成一小塊一小塊，所以全部傳完要通知一下啊！)。對於「實作者」而言，必須在最後一個 chunk 傳完之後，呼叫 \u003Cb style=\"background-color: #fce5cd;\"\u003Ethis.push(\u003Cspan style=\"color: #e06666;\"\u003Enull\u003C\/span\u003E)\u003C\/b\u003E，這會讓 ReadableStream 知道應該引發 'end' 事件了！\u003C\/li\u003E\u003C\/ol\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003EReadable Stream：Non-flowing Mode\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E接下來我們來看 Non-flowing mode (paused mode)，這是 ReadableStream 在 Stream2\/Stream3 的預設模式。現在解釋起來就簡單了，我們一樣按照圖中僅有的 (1)、(2)、(3) 來說明：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-NrZFVeyM8P0\/WAGxXzIGftI\/AAAAAAAAB6k\/muNp5IetYAocWk9Py1SqFN0Qg5jC7kSGgCLcB\/s1600\/readable_pause.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"330\" src=\"https:\/\/1.bp.blogspot.com\/-NrZFVeyM8P0\/WAGxXzIGftI\/AAAAAAAAB6k\/muNp5IetYAocWk9Py1SqFN0Qg5jC7kSGgCLcB\/s640\/readable_pause.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Col\u003E\u003Cli\u003E因為預設是 Non-flowing 的，所以\u003Cb\u003E this.push() 進來的 chunk 都會被累積在緩衝區\u003C\/b\u003E。\u003C\/li\u003E\u003Cli\u003E每當 this.push() 被實作者呼叫時，ReadableStream 就會\u003Cspan style=\"color: #3d85c6;\"\u003E\u003Cb\u003E引發 'readable' 事件但是不挾帶數據\u003C\/b\u003E\u003C\/span\u003E，目的是通知「使用者」，快來哦！有資料來了哦！當然，「使用者」必須監聽這個事件，才收的到通知嘛～\u003C\/li\u003E\u003Cli\u003E當收到通知後，\u003Cb\u003E使用者在它的 'readable' 監聽器中，呼叫 \u003Cspan style=\"background-color: #fce5cd;\"\u003Ereadable.read([size])\u003C\/span\u003E 來把資料挖走\u003C\/b\u003E。注意到了嗎？在挖資料的時候，可以用 size 參數來指定一次要挖「多少」， read() 這支 API 就如可調鬆緊的水龍頭，可以控制每次想取回的數據量啊！超讚！(封包剖析就很需要這種功能)。平常的使用大多不會指定 size，而是盡可能地一直呼叫 read() 把緩衝區現有的數據都給挖回來，反正遇到 read() 傳回 null 時，就知道緩衝區空了、挖光了。這我們在以「使用者角度」切入時，再來看！\u003Cb\u003E如果外面沒有人呼叫 read() 說要吸，那麼數據就會在緩衝區內累積下去\u003C\/b\u003E。\u003C\/li\u003E\u003C\/ol\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E關於 Stream3 的行為\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cul\u003E\u003Cli\u003E此時此刻，我覺得我們只要看 Stream3 就可以了。 (Node 都已經到 v7.0 了啊!!!)\u003C\/li\u003E\u003Cli\u003E使用者可以同時掛上 'data' 與 'readable' 監聽器。\u003C\/li\u003E\u003Cli\u003E只要掛上 'data' 監聽器，ReadableStream 就會進入 Flowing mode，此時就算呼叫 pause() 把水管關閉，並不會使其回到 Non-flowing mode。\u003C\/li\u003E\u003Cli\u003E在 Flowing mode，不只 'data' 事件，同時 'readable' 事件一樣會發射，但呼叫 read() 會挖不到東西，因為數據已經伴隨 'data' 事件拋出去了。\u003C\/li\u003E\u003Cli\u003E在 Non-flowing mode，每一次 push(chunk) 都會引發一次 'readable' 事件，但是如果 ReadableStream 內部 source 產生的速度很快 (推入緩衝區的速度也很快)，此時外部在聽到較早發生的 'readable' 事件時，用 read() 就會撈到「現在這當下」緩衝區內擁有的東西，然後你又撈光它的話，這會造成聽到較晚的 'readable' 事件時，使用 read() 反而挖不出東西來。這是正常的行為，不要以為有問題啊！因為你還是一樣拿到完整的數據了啊，對吧？\u003C\/li\u003E\u003Cli\u003E如果你想使用 Non-flowing mode，但又掛了 'data' 監聽器，你必須在 ReadableStream 造出來後立即顯式地呼叫 pause() 讓它進入非流動模式，之後當你呼叫 read() 時，'data' 事件會順便被引發，然後你在 'data' 監聽器會得到跟 read() 一樣的數據，也就是說你在 'readable' 與 'data' 兩個監聽器內都有辦法拿到同一份數據，YA~~\u003C\/li\u003E\u003Cli\u003E關於 Stream3 更細緻的行為，請參考\u003Ca href=\"https:\/\/nodejs.org\/dist\/latest-v4.x\/docs\/api\/stream.html\" target=\"_blank\"\u003E官方手冊\u003C\/a\u003E最準確！但我認為有上述的認識，就差不多了！\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　呼～ Readable Stream 說了很長，但這是必經之途呀！接下來，Writable Stream 就好講了。請再忍忍！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E八、Writable Stream\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E一樣，看圖說故事！我們有 (1) ~ (6) 共六個號碼：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-AqZ4ur1SJ8Q\/WACxDpgNNpI\/AAAAAAAAB5I\/eK-HU73aFa8Dq5FbtC9lj9JWIb1j6snDACPcB\/s1600\/writable2.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"316\" src=\"https:\/\/2.bp.blogspot.com\/-AqZ4ur1SJ8Q\/WACxDpgNNpI\/AAAAAAAAB5I\/eK-HU73aFa8Dq5FbtC9lj9JWIb1j6snDACPcB\/s640\/writable2.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Col\u003E\u003Cli\u003E\u003Cb\u003EResource 是數據終點\u003C\/b\u003E，例如一支檔案，一個 socket、或某種數據收取裝置，到底如何往 Resource 寫數據是實作者的事情。\u003C\/li\u003E\u003Cli\u003E\u003Cb\u003E_write() 這支 template method 由這個 WritableStream 的實作者提供\u003C\/b\u003E，這支方法主要是要告訴 Stream 如何將數據寫入 Resource。這裡範例的程式碼是用 fs.writeFile() 將數據寫進一個檔案。\u003C\/li\u003E\u003Cli\u003E「使用者」可以\u003Cb\u003E呼叫 \u003Cspan style=\"background-color: #fce5cd;\"\u003Ewrite(chunk)\u003C\/span\u003E 或 \u003Cspan style=\"background-color: #fce5cd;\"\u003Eend(chunk)\u003C\/span\u003E 往 WritableStream 寫入數據，end() 可在結束時順便寫入最後一筆 chunk\u003C\/b\u003E。接著看 (4)\u003C\/li\u003E\u003Cli\u003E內部會先判斷緩衝區是否為空，如果是空的，那就直接往 Resource 寫去即可。\u003C\/li\u003E\u003Cli\u003E如果緩衝區不為空，那就進去跟大家一起排隊吧 (lastBufferRequest 是紀錄物件)！WritableStream 內部會在往 Resource 寫東西之後，回頭去檢查緩衝區內是否還有數據，試圖清空緩衝區 (clearBuffer())，直到消耗完畢。\u003C\/li\u003E\u003Cli\u003E\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E當外部使用者呼叫 end() 之後\u003C\/span\u003E\u003C\/b\u003E，WritableStream 在來來回回從緩衝區拿出數據往 Resource 寫入，直到緩衝區空了，它知道你已經告訴它 end() 啦，所以\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E在最後一次往 Resource 寫完資料之後，將引發 'finish' 事件通知你\u003C\/span\u003E\u003C\/b\u003E，終於寫完啦！爽！哈哈哈！那麼 'drain' 事件又是怎麼回事？這時就可以來聊聊 Backpressure 了！\u003C\/li\u003E\u003C\/ol\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003EBackpressure (背壓)\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003EBackpressure 機制作圖如下，當外部呼叫 write(chunk) 或 end(chunk) 往 WritableStream 寫入數據，\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E若內部緩衝區已經滿了則傳回 false\u003C\/span\u003E，這個時候「你這個使用者」就必須暫停再往它身上寫東西\u003C\/b\u003E，因為進不去了，不要硬塞！那什麼時候可以再寫東西進去？\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E當 WritableStream 把它的緩衝區消耗完畢後，會引發 'drain' 通知使用者\u003C\/span\u003E\u003C\/b\u003E，來吧！Come On Baby！write() 回傳的 false 以及 'drain' 事件通知，它們一起構成了 Backpressure 的機制！\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-wQRy_16S04Q\/WAG4CJrs5eI\/AAAAAAAAB64\/CcSvllXyt4cnGWLDlsH326nSP_mNWD3JwCLcB\/s1600\/backpressure21.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"326\" src=\"https:\/\/2.bp.blogspot.com\/-wQRy_16S04Q\/WAG4CJrs5eI\/AAAAAAAAB64\/CcSvllXyt4cnGWLDlsH326nSP_mNWD3JwCLcB\/s640\/backpressure21.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E這裡我們要注意的是：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Cspan style=\"background-color: #ffe599; color: #e06666; font-size: x-large;\"\u003E\u003Cb\u003E　照顧 Writable Stream 的 Backpressure 是使用者的責任　\u003C\/b\u003E\u003C\/span\u003E\u003C\/div\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E蛤？～～責任？那是甚麼？這讓我想李敖大師說施明德先生的三不主義：「不主動、不拒絕、不負責」 XDDD....\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　接下來我們來看一下 pipe()，它除了可以幫你把一個 ReadableStream 的輸出水管給接到 WritableStream 的輸入之外，還會幫你扛起處理 Backpressure 的責任哦！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003Epipe\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003Epipe() 的用途就是將一個 Readable Stream (source) 接給 Writable Stream、Transform Stream 或 DuplexStream 等 sink。pipe() 會再傳出一個 Readable Stream，以致於 pipe() 能夠一直串連下去，就好像我們在文章一開頭看到的 UNIX 命令範例：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E$ ls \/ \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E|\u003C\/span\u003E sort -r \u003Cspan style=\"color: #a71d5d; font-size: 13.6px;\"\u003E| \u003C\/span\u003E\u003Cspan style=\"font-size: 13.6px;\"\u003Egrep e\u003C\/span\u003E\u003C\/pre\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　一個純然的 Writable Stream 因為沒有 Readable 介面，所以 pipe() 接到純 Writable Stream 就是終點了，無法再 pipe() 下去。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　現在，我們來看一下 \/lib\/stream.js 中，pipe() 方法的實作。\u003Cu\u003E請注意，底下的程式碼我有將原始碼做了一點調整，為了是方便說明它的理念，原始碼並非如此\u003C\/u\u003E。當我們使用 A.pipe(B) 時，A 是 source，B 是 destination (sink)。就看以下這三點：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cul\u003E\u003Cli\u003Epipe() 幫你監聽了 source 的 'data' 事件，然後將收下來的 chunk 用 dest.write() 寫到 dest 去！同時它若檢測到 backpressure，會使用 source.pause() 自動將 source 暫停下來！\u003C\/li\u003E\u003Cli\u003E它也幫你監聽了 dest 的 'drain' 事件，當 dest 的緩衝區消耗完畢，它又幫你恢復 source 的資料流動！它幫你自動照顧 backpressure，根本超佛.... \u0026nbsp;XDDD (pipe 裡面還有幫你照顧 'end' 跟 'close' 事件，我就不列啦！)\u003C\/li\u003E\u003Cli\u003Epipe() 最後傳出 destination，若\u0026nbsp;destination 是純\u0026nbsp;Writable Stream，那就無法再串 pipe 下去。因為自 Stream2 起，已經嚴格限制必須要是 Readable 才能 pipe 給 Writable Stream。\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EStream\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprototype\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edest\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eoptions\u003C\/span\u003E) {\u003Cbr \/\u003E  var source = this;\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Esource\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edata\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Echunk\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edest\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ewritable\u003C\/span\u003E) {\u003Cbr \/\u003E      \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Efalse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edest\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ewrite\u003C\/span\u003E(chunk) \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026amp;\u0026amp;\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Esource\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Epause\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Esource\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Epause\u003C\/span\u003E();\u003Cbr \/\u003E      }\u003Cbr \/\u003E    }\u003Cbr \/\u003E  });\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edest\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edrain\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E,   \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Esource\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereadable\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026amp;\u0026amp;\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Esource\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eresume\u003C\/span\u003E) {\u003Cbr \/\u003E      \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Esource\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eresume\u003C\/span\u003E();\u003Cbr \/\u003E    }\u003Cbr \/\u003E  });\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edest\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Epipe\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, source);\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ Allow for unix-like usage: A.pipe(B).pipe(C)\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E dest;\u003Cbr \/\u003E};\u003C\/pre\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E如果以撰寫應用程式的觀點來看，原本像以下的寫法：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E fs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E sourceStream \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateReadStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Esource.txt\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E sinkStream \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateWriteStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Esink.txt\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EsourceStream\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edata\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Echunk\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EsinkStream\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ewrite\u003C\/span\u003E(chunk);\u003Cbr \/\u003E}).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eend\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EsinkStream\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E();\u003Cbr \/\u003E});\u003C\/pre\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E使用 pipe() 來寫，將變成這樣：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E fs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateReadStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Esource.txt\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Epipe\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateWriteStream\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Esink.txt\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E));\u003C\/pre\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E真的超酷的啊！不覺得嗎？還有一點，我就把它總結成下面這句話吧：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cblockquote class=\"tr_bq\"\u003Epipe() 幫你串連數據來源與消耗者，同時會自動控制它們之間的 Backpressure，因此，\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E整條 Streams Pipeline 的速度將受限於其中最低速的那一個\u003C\/span\u003E\u003C\/b\u003E\u003C\/blockquote\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E好的！有了以上的概念，接下來我們再看 Transform 與 Duplex，真的超簡單！隨便講個幾句你就能理解了！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E九、Transform Stream\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003ETransform 擁有 \u0026nbsp;Writable (圖左側) 與 Readable (圖右側) 的標準介面，\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E輸入與輸出彼此間的數據存在有轉換關係，且轉換前後的數據長度可以不一樣\u003C\/span\u003E\u003C\/b\u003E沒關係。例如壓縮，轉換後的長度變短；又如解壓縮，轉換後的長度變長。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-vgVO0Q-YrDQ\/WAEFavi3pGI\/AAAAAAAAB5s\/mxVUNQC9Ikc8jriL8nwVxuRT3iVc1a_XQCPcB\/s1600\/transform.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"244\" src=\"https:\/\/1.bp.blogspot.com\/-vgVO0Q-YrDQ\/WAEFavi3pGI\/AAAAAAAAB5s\/mxVUNQC9Ikc8jriL8nwVxuRT3iVc1a_XQCPcB\/s640\/transform.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　TransformStream 的實作者必須提供 \u003Cb style=\"background-color: #fce5cd;\"\u003E_transform()\u003C\/b\u003E 與 \u003Cb style=\"background-color: #fce5cd;\"\u003E_flush()\u003C\/b\u003E 的內容，_transform() 告訴 TransformStream 如何轉換來源數據(例如壓縮)，_transform() 的函式簽署與 _write() 一樣，只不過實作者在內部會呼叫 this.push() 將轉換後的數據推入內部緩衝區，這反而像 _read() 對吧！這是因為\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E轉換後，將形成一個新的數據源\u003C\/span\u003E\u003C\/b\u003E，而非寫入某個 Resource。_flush() 則是用於讓 TransformStream 在 Readable side 要發射 'end' 之前，有最後一次機會將一些殘餘數據推入緩衝區 (這點對於「使用者」其實不用太在意，若你是實作者，當你試著實作一個 Transform Stream 碰到時，就知道這什麼意思了)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E因為遵循著 Readable 與 Writable 的標準介面，所以，就如同使用 Readable Stream 與 Writable Stream 般地大膽地使用它吧！\u003C\/span\u003E\u003C\/b\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003ETransform 完！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E十、Duplex Stream\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003EDuplex 擁有 \u0026nbsp;Writable (圖左側) 與 Readable (圖右側) 的標準介面，\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E輸入與輸出彼此間的數據可以毫無關係\u003C\/span\u003E\u003C\/b\u003E，例如一個 socket，寫出跟讀入可以完全沒關係，你可以將它的內部視為，由獨立的 Readable Stream 與 Writable Stream 所組合而成，各自使用的 Resource 可以是同一個、也可以不一樣。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-3eVJHcDJX_w\/WAEIqyQuqyI\/AAAAAAAAB54\/9BA3qp-LLGAu9VLEUJYqvewjHa9Ro7RZgCPcB\/s1600\/duplex.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"246\" src=\"https:\/\/2.bp.blogspot.com\/-3eVJHcDJX_w\/WAEIqyQuqyI\/AAAAAAAAB54\/9BA3qp-LLGAu9VLEUJYqvewjHa9Ro7RZgCPcB\/s640\/duplex.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E因為遵循著 Readable 與 Writable 的標準介面，所以，就如同使用 Readable Stream 與 Writable Stream 般地大膽地使用它吧！\u003C\/span\u003E\u003C\/b\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E這就是 Duplex，打完收工！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch3\u003E十一、以使用者角度看 Stream\u003C\/h3\u003E\u003Chr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E當你已經理解各種 Streams 的運作原理，站在使用者的角度，你會發現這根本沒什麼了啊！不過我們還是把它給總結一下：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E使用 Readable Stream\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E介面事件：'error', 'close', 'end', 'data' (Flowing mode), 'readable' (Non-flowing mode)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E介面方法：resume(), pause(), read()\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E\u003Cbr \/\u003E\u003C\/b\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[ 流動模式 ]\u003C\/span\u003E\u0026nbsp;\u003C\/b\u003E聽 'data' 事件，由 handler 收取 chunk\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-UhdsU1E2aWU\/WAGYhfnHFBI\/AAAAAAAAB6I\/ac4H51uqAxos0avZaKAn5j5nxQaKVpJvwCPcB\/s1600\/readable_user_flow.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"214\" src=\"https:\/\/1.bp.blogspot.com\/-UhdsU1E2aWU\/WAGYhfnHFBI\/AAAAAAAAB6I\/ac4H51uqAxos0avZaKAn5j5nxQaKVpJvwCPcB\/s640\/readable_user_flow.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[ 非流動模式]\u003C\/span\u003E\u0026nbsp;\u003C\/b\u003E聽 'readable' 事件，在 handler 中使用 read() 方法收取 chunk，讀到 null 即內部緩衝區已空。平常用法就如綠色區塊內的範例，會使用 while() 直到把緩衝區掏光為止。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-vfRgYLxruC4\/WAGY4LGxJqI\/AAAAAAAAB6Q\/xCRzWtMsReMKX3WhHuF2q7dVXtcAuovCgCPcB\/s1600\/readable_user_nonflow.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"214\" src=\"https:\/\/3.bp.blogspot.com\/-vfRgYLxruC4\/WAGY4LGxJqI\/AAAAAAAAB6Q\/xCRzWtMsReMKX3WhHuF2q7dVXtcAuovCgCPcB\/s640\/readable_user_nonflow.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E使用 Writable Stream\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E介面事件：'error', 'close', 'finish', 'drain'\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E介面方法：write(), end()\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E\u003Cspan style=\"color: #c27ba0;\"\u003E[使用模式] \u003C\/span\u003E\u003C\/b\u003E檢查 write() 回傳值，backpressure 發生時要暫停寫入。監聽 'drain' 事件以繼續寫入數據。呼叫 end() 告訴 WritableStream 這一坨數據的最後一個 chunk 已經來了，接著當 'finish' 發生時，代表 WritableStream 已經將所有數據都往 Resource 寫入完畢。圖中綠色區塊範例的 fooWrite() 是經過包裝的 writer，它帶有照顧好 backpressure 的機制，你可以實作自己的處理方式。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-gIvGdlFczlU\/WAGayginIqI\/AAAAAAAAB6c\/6SQzVW69NUoSS5InBGV7i5QW_aql5XGCwCPcB\/s1600\/writable_user.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"260\" src=\"https:\/\/2.bp.blogspot.com\/-gIvGdlFczlU\/WAGayginIqI\/AAAAAAAAB6c\/6SQzVW69NUoSS5InBGV7i5QW_aql5XGCwCPcB\/s640\/writable_user.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E使用 Transform、Duplex 與 PassThrough\u003C\/span\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E這個我們就不用再畫圖了！因為遵循著 Readable 與 Writable 的標準介面，所以同樣再唱一次國歌：「\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E就如同使用 Readable Stream 與 Writable Stream 般地大膽地使用它們吧！\u003C\/span\u003E\u003C\/b\u003E」\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u0026nbsp;　\u003Cbr \/\u003E\u003Ch4\u003E\u003Cspan style=\"color: #8e7cc3;\"\u003E怎麼看都很眼熟？\u003C\/span\u003E\u003C\/h4\u003E如果你使用 Node 開發網路程式，你可能會常寫出類似以下的程式碼，你知道多數時候你一直在使用著 Stream 的標準介面嗎？\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E( (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u0026gt;\u003C\/span\u003E {\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, {\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Etext\/plain\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E});  \/\/ \u0026lt;- 註: writeHead 不是標準介面哦\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ewrite\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EHello\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EWorld!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; text-align: start; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eclient\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edata\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E) \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u0026gt;\u003C\/span\u003E {\u003Cbr \/\u003E  \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EtoString\u003C\/span\u003E());\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eclient\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E();\u003Cbr \/\u003E});\u003C\/pre\u003ENode 核心的許多模組，例如 fs, net, http, dgram, zlib, cryto 大多使用了 Stream 的實作，或提供有 Stream 的介面，所以你可能在很多地方多多少少都會遇見 Stream 的蹤影。當然，Stream 本身是 EventEmitter，因此你當然可以在它身上發射自己的事件，許多核心模組或第三方模組也規劃有自己特化後的事件、方法或者屬性，以符合模組的目的 (可能語意也會比較清晰，畢竟 Stream 的介面是很通用化的)。\u003Cbr \/\u003E　\u003Cbr \/\u003E　　再者，由於 Stream 的介面是 Universal 的，這帶給開發者最大的好處就是：\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E只要搞懂 Stream 的介面，就可以在「不太需要詳閱文件」的情況下，自由運用許多基於 Stream 的工具！\u003C\/span\u003E\u003C\/b\u003E\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E(需要了解目的，而不需要花太多時間再了解介面)\u003C\/span\u003E\u003C\/b\u003E\u003Cbr \/\u003E　\u003Cbr \/\u003E現在弄清楚 Stream 的介面了，準備好對你的 http server 進行惡搞了嗎？ XDDD....\u003Cbr \/\u003E　\u003Cbr \/\u003E\u003Ch3\u003E十二、我們沒有講的\u003C\/h3\u003E\u003Chr \/\u003E你知道，光是要把 Stream 的運作機制給講清楚就已經要花這麼大篇幅了，因此恕我沒辦法再說更多了！這裡提幾點我們沒談到的，我相信只要您已經理解以上內容，自己去探索剩下的東西也就不那麼困難了。我們沒談到的有：\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E如何設定 encoding \u0026nbsp;(存在內部緩衝區內的東西，預設一定是 Buffer 類型，當你塞字串進去時可設定編碼，預設是當成 utf8 將字串編成 binaries。當數據被挖出來的時候，也能設定編碼類型以噴出字串，而不是噴出 binaries)\u003C\/li\u003E\u003Cli\u003EStream 的 Object Mode (還記得 this.buffer = [] 嗎？它其實存的都是一個個 Buffer 類型的實例，也都是物件。但開啟 Object Mode 後，這個陣列就能塞一般物件啦)\u003C\/li\u003E\u003Cli\u003EWritable Stream 的 'pipe' 及 'unpipe' 事件，這個我不知道怎麼講。太直覺簡單反而講不出所以然阿 XDDD\u003C\/li\u003E\u003Cli\u003EWritable Stream 的 cork() 與 uncork() 方法，其實就是讓你有機會去堵住 Writable Stream\u0026nbsp;「內部緩衝區」，把它們當成\u0026nbsp;Readable Stream\u0026nbsp;的 pause() 與 resume() 你就瞭了\u003C\/li\u003E\u003Cli\u003EWritable Stream 什麼時候會被 'unpipe'？例如有 error 發生時。請參閱官方文件\u003C\/li\u003E\u003Cli\u003E捕捉 pipeline 中的 error 以及如何 combine 與 merge streams 等 (前面有列一些輔助工具，請參閱那些工具的文件)\u003C\/li\u003E\u003Cli\u003E如何利用 Stream Classes 來實作自己的 streams\u003C\/li\u003E\u003Cli\u003EStream 更細緻的行為，也請參閱官方文件\u003C\/li\u003E\u003C\/ul\u003E\u003Cbr \/\u003E這裡有一些很棒的文章\/影片，有空可以看一看：\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.youtube.com\/watch?v=g5ewQEuXjsQ\" target=\"_blank\"\u003EThe History of Node.js Streams\u003C\/a\u003E\u0026nbsp;-\u0026nbsp;\u003Ca href=\"https:\/\/github.com\/dominictarr\" target=\"_blank\"\u003EDominic Tarr\u003C\/a\u003E (Node 核心開發者)\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.youtube.com\/watch?v=IuMHaONGAmc\" target=\"_blank\"\u003EStreams\u003C\/a\u003E\u0026nbsp;- \u003Ca href=\"https:\/\/github.com\/isaacs\" target=\"_blank\"\u003EIsaac Schlueter\u003C\/a\u003E (npm 創辦人\/Node 核心與 Stream 的主要貢獻者)\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.youtube.com\/watch?v=UD2dZw9iHCc\" target=\"_blank\"\u003EStreams\u003C\/a\u003E\u0026nbsp;- Mattias P. Johansson\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.sitepoint.com\/basics-node-js-streams\" target=\"_blank\"\u003EThe Basics of Node.js Streams\u003C\/a\u003E\u0026nbsp;-\u0026nbsp;Sandeep Panda\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"http:\/\/dry.ly\/full-streams-ahead\" target=\"_blank\"\u003EFull Streams Ahead\u003C\/a\u003E - David Guttman\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.youtube.com\/watch?v=lQAV3bPOYHo\" target=\"_blank\"\u003EHarnessing The Awesome Power Of Streams\u003C\/a\u003E -\u0026nbsp;\u003Ca href=\"https:\/\/github.com\/substack\" target=\"_blank\"\u003EJames Halliday\u003C\/a\u003E (瘋瘋的 substack)\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.youtube.com\/watch?v=mlNUxIUS-0Q\" target=\"_blank\"\u003ENode.js Streams\u003C\/a\u003E - David Gonzalez 與 \u003Ca href=\"https:\/\/github.com\/mcollina\" target=\"_blank\"\u003EMatteo Collina\u003C\/a\u003E\u003C\/li\u003E\u003C\/ul\u003E\u003Cbr \/\u003E　　這邊再次說一下，作文的目的是希望：對跟我一樣熱愛 JS 與 Node.js 的開發者有所啟發，然後繼續寫出更棒的程式碼。本文非常歡迎各界拿去分享、修修改改當教材，但我最在乎的是，希望大家有發現錯誤的話，能告訴我，讓我們一起把它修改得更好、更正確！\u003Cbr \/\u003E\u003Cbr \/\u003E這次不打粉絲專頁的廣告了，其實根據經驗，往往沒什麼效果，哈哈哈～\u003Cbr \/\u003E　　\u003Cbr \/\u003E這個小節就當成我們的結語吧！寫了 N 天。終於，完了！呼....\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan style=\"color: #3d85c6; font-size: x-small;\"\u003E(如果你有要使用、或修改本文章的圖，以轉化成另一種材料。如果不想浪費時間畫那些圖，可跟我索取原始檔)\u003C\/span\u003E\u003Cbr \/\u003E\u003Cspan style=\"color: #3d85c6; font-size: x-small;\"\u003E　\u003C\/span\u003E\u003Cbr \/\u003E\u003Cspan style=\"color: #3d85c6; font-size: x-small;\"\u003E　\u003C\/span\u003E\u003Cbr \/\u003E\u003Cspan style=\"color: #3d85c6; font-size: x-small;\"\u003E　\u003C\/span\u003E\u003Cbr \/\u003E\u003Cspan style=\"color: #3d85c6; font-size: x-small;\"\u003E　\u003C\/span\u003E\u003Cbr \/\u003E\u003Cspan style=\"color: #3d85c6; font-size: x-small;\"\u003E　\u003C\/span\u003E\u003C\/div\u003E"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/8021532719657076239\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/10\/nodejs-streams.html#comment-form","title":"8 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/8021532719657076239"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/8021532719657076239"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/10\/nodejs-streams.html","title":"海納百川：Node.js Streams"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/2.bp.blogspot.com\/-T8xFexdixBI\/WABaIwBKL5I\/AAAAAAAAB4w\/3FM0qpe1ndUY60EKPlFo3y36LME1R-XEgCPcB\/s72-c\/buffer_explosion.jpg","height":"72","width":"72"},"thr$total":{"$t":"8"}},{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-6987500741924024409"},"published":{"$t":"2016-10-11T19:29:00.002+08:00"},"updated":{"$t":"2016-10-11T19:29:36.569+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"node"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"}],"title":{"type":"text","$t":"使用 curl 工具進行簡單的 http 測試"},"content":{"type":"html","$t":"　\u003Cbr \/\u003E很常看見大家用 curl 在測試 http 伺服器或一些 REST API endpoints，這篇廢文的重點就小小地來介紹一下 curl 這個工具，順便用 node 的 http server 做一些廢廢的範例來測試一下。\u003Cbr \/\u003E\u003Ch3\u003Ecurl\u003C\/h3\u003E\u003Ca href=\"https:\/\/curl.haxx.se\/\" target=\"_blank\"\u003E官網\u003C\/a\u003E這麼說：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003Ecurl is used in command lines or scripts to transfer data.\u003C\/blockquote\u003E\u003Cbr \/\u003E它支援很多協定，包含 FTP, HTTPS, HTTP, Telnet, TFTP 等，官網列出了很詳細的清單，有興趣者可到官網給它瞄個幾眼～　然後 \u003Ca href=\"https:\/\/curl.haxx.se\/docs\/manual.html\" target=\"_blank\"\u003Emanual 在這裡\u003C\/a\u003E，挑一下常用的使用方式來看看：\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E發 request 到 http 或 ftp 伺服器\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"-webkit-text-stroke-width: 0px; background: rgb(242, 242, 242); border: 0px; color: black; font-family: inherit; font-size: medium; font-stretch: inherit; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 1em; orphans: 2; overflow: auto; padding: 1em; text-align: start; text-indent: 0px; text-transform: none; vertical-align: top; widows: 2; word-spacing: 0px; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; color: #444444; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl http:\/\/www.example.com:port\u003Cbr \/\u003E$ curl ftp:\/\/www.example.com:port\u003Cbr \/\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Cul\u003E\u003C\/ul\u003E\u003Cul\u003E\u003Cli\u003E如果要帳號密碼 (-u)\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; color: #444444; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl -u name:passwd http:\/\/xxx.xxx.xxx:port\/path\/to\/endpoint\u003Cbr \/\u003E$ curl -u name:passwd ftp:\/\/xxx.xxx.xxx:port\/path\/to\/file\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E取回來的東西存成檔案 (-o)\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv\u003E\u003Cpre class=\"sh_sourceCode\" style=\"-webkit-text-stroke-width: 0px; background: rgb(242, 242, 242); border: 0px; color: black; font-family: inherit; font-size: medium; font-stretch: inherit; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 1em; orphans: 2; overflow: auto; padding: 1em; text-align: start; text-indent: 0px; text-transform: none; vertical-align: top; widows: 2; word-spacing: 0px; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; color: #444444; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl -o filename http:\/\/xxx.xxx.xxx:port\/path\/to\/endpoint\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003C\/div\u003E\u003Cul\u003E\u003Cli\u003E以 server 端檔案名稱作為檔名儲存下來 (-O)\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv style=\"-webkit-text-stroke-width: 0px; color: black; font-family: \u0026quot;Times New Roman\u0026quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;\"\u003E\u003Cpre class=\"sh_sourceCode\" style=\"-webkit-text-stroke-width: 0px; background: rgb(242, 242, 242); border: 0px; color: black; font-family: inherit; font-size: medium; font-stretch: inherit; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 1em; orphans: 2; overflow: auto; padding: 1em; text-align: start; text-indent: 0px; text-transform: none; vertical-align: top; widows: 2; word-spacing: 0px; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; color: #444444; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl -O http:\/\/xxx.xxx.xxx:port\/path\/to\/filename\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003C\/div\u003E\u003Cbr \/\u003E如果你的系統沒有 curl，記得安裝一下\u003Cbr \/\u003E\u003Cdiv\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; color: #444444; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ sudo apt-get install curl\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003C\/div\u003E\u003Ch3\u003E\u003C\/h3\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3\u003E簡單的 http server\u003C\/h3\u003E\u003Cdiv\u003E\u003Cul\u003E\u003Cli\u003E又是 Hello World!：這個 server 開在 port 3000\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E http \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Ehttp\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Etext\/plain\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EHello from node.js\u003Cspan class=\"pl-cce\" style=\"box-sizing: border-box;\"\u003E\\n\u003C\/span\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eserver\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Elisten\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E3000\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EServer for curl testing\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E開一個 terminal 跑 server.js\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; font-variant-numeric: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; color: #444444; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ node server.js\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E用瀏覽器開啟 http:\/\/localhost:3000 看看\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/1.bp.blogspot.com\/-pBKKqvQFyAs\/V_yJm7u0WHI\/AAAAAAAAB2c\/j3hr_gzlmKsUzthIg38XmTi2TU3W60qrACEw\/s1600\/01.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/1.bp.blogspot.com\/-pBKKqvQFyAs\/V_yJm7u0WHI\/AAAAAAAAB2c\/j3hr_gzlmKsUzthIg38XmTi2TU3W60qrACEw\/s1600\/01.jpg\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cul\u003E\u003Cli\u003E開另一個 terminal 用 curl 試試看\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv style=\"-webkit-text-stroke-width: 0px; color: black; font-family: \u0026quot;Times New Roman\u0026quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; margin: 0px; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;\"\u003E\u003C\/div\u003E\u003Cul style=\"-webkit-text-stroke-width: 0px; color: black; font-family: \u0026quot;Times New Roman\u0026quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;\"\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"-webkit-text-stroke-width: 0px; background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-size: medium; font-stretch: inherit; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; line-height: normal; margin: 1em; orphans: 2; overflow: auto; padding: 1em; text-align: start; text-indent: 0px; text-transform: none; vertical-align: top; widows: 2; word-spacing: 0px; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl http:\/\/localhost:3000\u003Cbr \/\u003E\u003Cspan style=\"color: #999999;\"\u003EHello from node.js\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E用 curl 並將回傳資料存成檔案 msg.txt\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl -o msg.txt http:\/\/localhost:3000\u003Cbr \/\u003E$ cat msg.txt\u003Cbr \/\u003E\u003Cspan style=\"color: #999999;\"\u003EHello from node.js\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Cbr \/\u003E\u003Ch3\u003E測試首頁 index.html\u003C\/h3\u003E\u003Cul\u003E\u003Cli\u003E準備一下檔案 index.html，內容如下\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u0026lt;!DOCTYPE html\u0026gt;\u003Cbr \/\u003E\u0026lt;\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ehtml\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E\u0026lt;\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ehead\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E    \u0026lt;\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Etitle\u003C\/span\u003E\u0026gt;Curl Testing\u0026lt;\/\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Etitle\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E\u0026lt;\/\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ehead\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E\u0026lt;\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ebody\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E    \u0026lt;\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Eh1\u003C\/span\u003E\u0026gt;Hello World from Node.js\u0026lt;\/\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Eh1\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E    \u0026lt;\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ediv\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E        \u0026lt;\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ep\u003C\/span\u003E\u0026gt;Have Fun!\u0026lt;\/\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ep\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E    \u0026lt;\/\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ediv\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E\u0026lt;\/\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ebody\u003C\/span\u003E\u0026gt;\u003Cbr \/\u003E\u0026lt;\/\u003Cspan class=\"pl-ent rich-diff-level-one\" style=\"box-sizing: border-box; color: #63a35c;\"\u003Ehtml\u003C\/span\u003E\u0026gt;\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E當 client 端進來後，回傳 index.html 的內容\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E http \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Ehttp\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E),\u003Cbr \/\u003E    fs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EreadFile\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eindex.html\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eerr\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Etext\/html\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(data);\u003Cbr \/\u003E    });\u003Cbr \/\u003E\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eserver\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Elisten\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E3000\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EServer for curl testing\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E重新啟動 server.js，並用瀏覽器開看看\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-oa2Os-vDybY\/V_yJm1cjm-I\/AAAAAAAAB2c\/c_9tfAIMf5g7cHv1cEZ8BX-_RbGwk9dTQCEw\/s1600\/02.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"161\" src=\"https:\/\/4.bp.blogspot.com\/-oa2Os-vDybY\/V_yJm1cjm-I\/AAAAAAAAB2c\/c_9tfAIMf5g7cHv1cEZ8BX-_RbGwk9dTQCEw\/s320\/02.jpg\" width=\"320\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cul\u003E\u003Cli\u003E用 curl 試試看\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl http:\/\/localhost:3000\u003Cbr \/\u003E\u003Cspan style=\"color: #999999;\"\u003E\u0026lt;!DOCTYPE html\u0026gt;\u0026lt;html\u0026gt; ...\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Ch3\u003E\u003C\/h3\u003E\u003Ch3\u003E\u003C\/h3\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3\u003E路由測試\u003C\/h3\u003E這裡的路由測試很簡單，如果你想要建立完整的路由或 REST endpoints，建議使用 express 或 hapi 這一類的框架來協助你。因為只是要測一下 curl，我就不裝 express 啦～\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E兩個路由，一個是網站的根 '\/'，另一個是 '\/greeting'\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EreadFile\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eindex.html\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eerr\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E) {\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Etext\/html\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(data);\u003Cbr \/\u003E        });\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/greeting\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Etext\/html\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;h1\u0026gt;Hello my friend!\u0026lt;\/h1\u0026gt;\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E404\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Etext\/html\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;h1\u0026gt;404 Not Found\u0026lt;\/h1\u0026gt;\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    }\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E測試 http:\/\/localhost:3000\/greeting，得到 Hello my friend!\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-L-frLw-9eLg\/V_yJnBfx0vI\/AAAAAAAAB2c\/4pWiizmcR6Axi_kkO-kSRG0TORHz6ymgQCEw\/s1600\/03.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"145\" src=\"https:\/\/3.bp.blogspot.com\/-L-frLw-9eLg\/V_yJnBfx0vI\/AAAAAAAAB2c\/4pWiizmcR6Axi_kkO-kSRG0TORHz6ymgQCEw\/s320\/03.jpg\" width=\"320\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cul\u003E\u003Cli\u003E用 curl\u003C\/li\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003C\/div\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl http:\/\/localhost:3000\/greeting\u003Cbr \/\u003E\u003Cspan style=\"color: #999999;\"\u003E\u0026lt;h1\u0026gt;Hello my friend!\u0026lt;\/h1\u0026gt;\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Ch3\u003E\u003C\/h3\u003E\u003Ch3\u003E\u003C\/h3\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3\u003E測試 Query String\u003C\/h3\u003E這是用 http GET 方法來搭 REST APIs 的方式之一，後面會再測一下 POST。我這裡 query 參數給了一個 name，參數值你可以填你的名字試試看\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E這裡會用到核心模組 url 及它的 parse 方法，將 query string 解析成為物件。因為等一下\/greeting 後面會加上 ?name=simen 這樣的查詢字串，所以在路由解析上，我就很簡單的使用字串的 startsWith() 方法做一下判斷，你或許可以試一下用 regex。這個在 express 的路由系統裡面會很好處理。\u003C\/li\u003E\u003Cli\u003E這裡把 name=simen 剖析成為一個物件 { name: 'simen' }，然後回應 Hello simen! 給 client 端\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E http \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Ehttp\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E),\u003Cbr \/\u003E    url \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eurl\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E),    \/\/ \u0026lt;-- url module\u003Cbr \/\u003E    fs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E        \/\/ ... 略\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EstartsWith\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/greeting\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E)) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E query \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eparse\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E, \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Etrue\u003C\/span\u003E).\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Equery\u003C\/span\u003E,\u003Cbr \/\u003E            greet \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E query.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ename\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E?\u003C\/span\u003E (\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;h1\u0026gt;Hello \u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E+\u003C\/span\u003E query.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ename\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E+\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E!\u0026lt;\/h1\u0026gt;\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E\u003Cbr \/\u003E                                  (\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;h1\u0026gt;Hello my friend!\u0026lt;\/h1\u0026gt;\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Etext\/html\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(greet);\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E        \/\/ ... 略\u003Cbr \/\u003E    }\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E測試 http:\/\/localhost:3000\/greeting?name=simen，得到 Hello simen!\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-ZW7PguRYSx0\/V_yJnRfssRI\/AAAAAAAAB2c\/G9YmfG9DSqcKe6bVN6RIWDyVXv-6lz2VgCEw\/s1600\/04.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"113\" src=\"https:\/\/2.bp.blogspot.com\/-ZW7PguRYSx0\/V_yJnRfssRI\/AAAAAAAAB2c\/G9YmfG9DSqcKe6bVN6RIWDyVXv-6lz2VgCEw\/s320\/04.jpg\" width=\"320\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cul\u003E\u003Cli\u003E改用 curl\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl http:\/\/localhost:3000\/greeting?name=simen\u003Cbr \/\u003E\u003Cspan style=\"color: #999999;\"\u003E\u0026lt;h1\u0026gt;Hello my simen!\u0026lt;\/h1\u0026gt;\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003E傳 json 字串看看\u003C\/h3\u003EJSON 資料也是很常見的 Client\/Server 互動的數據格式，這邊我也來測試一下下。這裡的 URI 端點名稱就叫 \/endpoint 好了。\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E傳出的 MIME type 設定為 application\/json\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E        \/\/ ... 略\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EstartsWith\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/greeting\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E)) {\u003Cbr \/\u003E        \/\/ ... 略\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/endpoint\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E data \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E {\u003Cbr \/\u003E            name\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Esimen\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E,\u003Cbr \/\u003E            age\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E38\u003C\/span\u003E\u003Cbr \/\u003E        };\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eapplication\/json\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EJSON\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Estringify\u003C\/span\u003E(data));\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E        \/\/ ... 略\u003Cbr \/\u003E    }\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E測試 http:\/\/localhost:3000\/endpoint\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-hGWbTYyHXHg\/V_yJnfbnamI\/AAAAAAAAB2c\/qgQ-zVaWtdM6z7OfKI1RVZ39JTbl7i9zwCEw\/s1600\/05.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"121\" src=\"https:\/\/2.bp.blogspot.com\/-hGWbTYyHXHg\/V_yJnfbnamI\/AAAAAAAAB2c\/qgQ-zVaWtdM6z7OfKI1RVZ39JTbl7i9zwCEw\/s320\/05.jpg\" width=\"320\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cul\u003E\u003Cli\u003E用 curl\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl http:\/\/localhost:3000\/endpoint\u003Cbr \/\u003E\u003Cspan style=\"color: #999999;\"\u003E{\"name\":\"simen\",\"age\":38}\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003E測試 POST\u0026nbsp;\u003C\/h3\u003E我們等一下要用 curl -d 以 POST 發 request 到 server 端。我要拿 POST 過來的數據，讓我年輕 20 歲 XDDD\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E這裡會用到 querystring 這個模組來幫忙，先 npm install 一下。因為 POST 發過來的資料會在 body 而不是在 http header 中，而 req 本身是 stream，所以我們要監聽 'data' 事件把資料都收下來。在 'end' 事件發生時，表示資料都收完了，我們再請 querystring 這個模組幫我們剖析一下 body。 (如果你是用 express，那麼 body-parser 這個 middleware 會是你的好朋友！)\u003C\/li\u003E\u003Cli\u003E我會從 client 端用 POST 發一個 minus 的參數，給它的值是 20，然後在 server 端把我的年紀減掉 20 歲再發回 client 端 (很蠢的範例我知道....)\u003C\/li\u003E\u003Cli\u003E程式裡面走到 '\/endpoint' 這裡路由中，再判斷一下發過來的 request 是 GET 還是 POST，如果是 post 就把 body 剖析一下\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E http \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Ehttp\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E),\u003Cbr \/\u003E    url \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eurl\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E),\u003Cbr \/\u003E    fs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E qs \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Equerystring\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehttp\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EcreateServer\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E        \/\/ ... 略\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EstartsWith\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/greeting\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E)) {\u003Cbr \/\u003E        \/\/ ... 略\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eurl\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/endpoint\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E data \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E {\u003Cbr \/\u003E                method\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eunknown\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E,\u003Cbr \/\u003E                name\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Esimen\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E,\u003Cbr \/\u003E                age\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E38\u003C\/span\u003E\u003Cbr \/\u003E            },\u003Cbr \/\u003E            receivedData \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E;\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Emethod\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EGET\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Emethod\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EGET\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E;\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eapplication\/json\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EJSON\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Estringify\u003C\/span\u003E(data));\u003Cbr \/\u003E        } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Emethod\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EPOST\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Emethod\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EPOST\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E;\u003Cbr \/\u003E\u003Cbr \/\u003E            \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereq\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edata\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Echunk\u003C\/span\u003E) {\u003Cbr \/\u003E                receivedData \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E+=\u003C\/span\u003E chunk;\u003Cbr \/\u003E            }).\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eend\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E                \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E body \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eqs\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eparse\u003C\/span\u003E(receivedData);\u003Cbr \/\u003E                \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eage\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E-=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ebody\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eminus\u003C\/span\u003E;\u003Cbr \/\u003E                \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EwriteHead\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E200\u003C\/span\u003E, { \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EContent-Type\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E:\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eapplication\/json\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E });\u003Cbr \/\u003E                \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eres\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eend\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EJSON\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Estringify\u003C\/span\u003E(data));\u003Cbr \/\u003E            });\u003Cbr \/\u003E        }\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E        \/\/ ...\u003Cbr \/\u003E    }\u003Cbr \/\u003E});\u003C\/pre\u003E\u003Cul\u003E\u003Cli\u003E這裡我直接用 curl，懶得在 client 端畫表單了。POST 資料必須是 \u003Ca href=\"http:\/\/www.w3schools.com\/tags\/ref_urlencode.asp\" target=\"_blank\"\u003Eurlencoded\u003C\/a\u003E 的字串，我這裡的字串很簡單 \"minus=20\"。試一下，YA～ 我變 18 歲了 (眾毆....)\u003C\/li\u003E\u003C\/ul\u003E\u003Cpre class=\"sh_sourceCode\" style=\"background: rgb(242, 242, 242); border: 0px; font-family: inherit; font-stretch: inherit; line-height: normal; margin: 1em; overflow: auto; padding: 1em; vertical-align: top; word-wrap: normal;\"\u003E\u003Cspan style=\"background-color: transparent; border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: \u0026quot;monaco\u0026quot; , \u0026quot;consolas\u0026quot; , \u0026quot;lucida console\u0026quot; , monospace; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-weight: inherit; line-height: 21.6px; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E\u003Cspan style=\"border: 0px; font-family: inherit; font-stretch: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit; margin: 0px; padding: 0px; vertical-align: baseline;\"\u003E$ curl -d \"minus=20\" http:\/\/localhost:3000\/endpoint\u003Cbr \/\u003E\u003Cspan style=\"color: #999999;\"\u003E{\"method\":\"POST\",\"name\":\"simen\",\"age\":18}\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/span\u003E\u003C\/pre\u003E\u003Ch3\u003E\u003C\/h3\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3\u003E結語\u003C\/h3\u003E好啦！終於結束這篇廢廢的文章了....　chrome 也有 postman 的外掛可以用啦～ 哈哈哈....　\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-6tJ2wgjFJ1M\/V_y1jkNB9pI\/AAAAAAAAB2o\/LuRkTgh3bfsiECfiScPEb5kVtJteUCxUgCLcB\/s1600\/06.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"179\" src=\"https:\/\/3.bp.blogspot.com\/-6tJ2wgjFJ1M\/V_y1jkNB9pI\/AAAAAAAAB2o\/LuRkTgh3bfsiECfiScPEb5kVtJteUCxUgCLcB\/s640\/06.jpg\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E　\u003Cbr \/\u003E　\u003Cbr \/\u003E　"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/6987500741924024409\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/10\/curl-http.html#comment-form","title":"1 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/6987500741924024409"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/6987500741924024409"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/10\/curl-http.html","title":"使用 curl 工具進行簡單的 http 測試"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/1.bp.blogspot.com\/-pBKKqvQFyAs\/V_yJm7u0WHI\/AAAAAAAAB2c\/j3hr_gzlmKsUzthIg38XmTi2TU3W60qrACEw\/s72-c\/01.jpg","height":"72","width":"72"},"thr$total":{"$t":"1"}},{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-5366450543765706186"},"published":{"$t":"2016-10-06T20:07:00.001+08:00"},"updated":{"$t":"2016-10-06T21:55:21.953+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"IoT"},{"scheme":"http://www.blogger.com/atom/ns#","term":"node"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"},{"scheme":"http://www.blogger.com/atom/ns#","term":"閒聊"}],"title":{"type":"text","$t":"準備跟 Smart Phone 說分手？淺談 BLE 開發模式"},"content":{"type":"html","$t":"\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cdiv style=\"text-align: right;\"\u003E作者：Hedy\u003C\/div\u003E\u003C\/div\u003E\u003Ch3 style=\"text-align: justify;\"\u003E一、\u003Cspan class=\"Apple-tab-span\" style=\"white-space: pre;\"\u003E \u003C\/span\u003E前言\u003C\/h3\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　在這個大家都說物聯網即將爆發的時代，Bluetooth Low Energy (BLE) 在眾多的通訊協定中，無疑也是很重要的一環，特別因為它的低功耗特性以及可以很容易跟手機、平板搭配的緣故，始終讓它在眾多近距離無線通訊技術中佔有一席之地。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　就我自己的觀察，目前市面上的 BLE 裝置普及率並不如我想像中的高，比較常看到或聽到的就是一些穿戴式裝置，像是運動手環或智慧手錶等等，而且現在看來，這些穿戴式裝置也並不如預期那樣熱銷 \u003Cspan style=\"font-size: x-small;\"\u003E(新聞：\u003Ca href=\"https:\/\/buzzorange.com\/techorange\/2016\/05\/30\/smartbracelet-recession-market\/\" target=\"_blank\"\u003EJawbone 宣布退出市場\u003C\/a\u003E)\u003C\/span\u003E。其他像智慧家庭那類的應用，在這個講求生態系的時代，BLE 極具彈性的資料模型卻傷害了產品間的相容性，各家的產品幾乎都是各玩各的，這間接導致 BLE 在智慧家庭應用中逐漸走入困境。接下來，我想要從 BLE 開發模式切入，來探討 BLE 想要進入物聯網需跨越的門檻。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3 style=\"text-align: justify;\"\u003E二、\u003Cspan class=\"Apple-tab-span\" style=\"white-space: pre;\"\u003E \u003C\/span\u003E淺談 BLE 開發模式\u003C\/h3\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　在開始之前，我先粗淺地介紹 BLE 的連線架構。在 BLE 協定中，一個 connection 有兩種角色，分別是 central 和 peripheral。一般 BLE peripheral 經常作為周邊裝置，像智慧手環、手錶或各類 sensor 等，而 BLE central 則是負責管理、控制連入的 peripheral 裝置。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　這裡我簡略地將 BLE 的開發方式區分成以下三種模式。不同的開發方式，有著不同的應用適用類型：\u003C\/div\u003E\u003Cbr \/\u003E\u003Cul\u003E\u003Cli style=\"text-align: justify;\"\u003E純嵌入式開發\u003C\/li\u003E\u003Cul\u003E\u003Cli style=\"text-align: justify;\"\u003E通常用於周邊節點開發，或是單純點對點(例如開關對電燈的應用：\u003Ca href=\"https:\/\/www.geckoswitch.com\/\" target=\"_blank\"\u003Egecko switch\u003C\/a\u003E)\u003C\/li\u003E\u003C\/ul\u003E\u003Cli style=\"text-align: justify;\"\u003E手機 App 開發\u003C\/li\u003E\u003Cul\u003E\u003Cli style=\"text-align: justify;\"\u003E適合以個人為中心的應用，像是智慧手環、手錶、運動配件等等，這例子就太多了。另外，以手機控制智慧插座、電燈這一類的應用，也不算少見\u003C\/li\u003E\u003C\/ul\u003E\u003Cli style=\"text-align: justify;\"\u003E以 BLE gateway 為中心的應用開發\u003C\/li\u003E\u003Cul\u003E\u003Cli style=\"text-align: justify;\"\u003E適合小型區域網路，像是智慧家庭、工廠自動化。此種模式通常是將 BLE 轉換為 RS485 或 WiFi，再轉進另一頭的服務器，這種情況下 gateway 其實就是很單純的 bridge 而已。另一種可以跑應用的，就如 「XX 盒子」 那一類的東西，或許把它們稱為 gateway 也可以，畢竟有些可以上雲端或透過 IFTTT 之類的服務來控制。不過，在比較細節上來講，開發手法會比較像手機那種方式(特別是 XX 盒子很多都是基於 Android 下去做修改的阿)\u003C\/li\u003E\u003C\/ul\u003E\u003C\/ul\u003E\u003Cbr \/\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch4 style=\"text-align: justify;\"\u003E1.\u0026nbsp;嵌入式開發\u003C\/h4\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　第一種開發模式，就是將藍芽應用建立於嵌入式板子上面，通常各家 IC vendor 會提供一套完整的 SDK 和開發板，幫助使用者能很快速地開發應用。像\u0026nbsp;\u003Ca href=\"http:\/\/www.ti.com\/tool\/cc2540dk\" target=\"_blank\"\u003ETI CC2540 Development Kit\u003C\/a\u003E 或是 \u003Ca href=\"http:\/\/www.csr.com\/tw\/node\/4479\" target=\"_blank\"\u003ECSR Bluetooth Smart Starter Development Kit\u003C\/a\u003E，都是很完整的開發套件。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　這種開發方式是最底層的一種，在大部分的情況下，你需要用 C\/C++ 語言去改寫 firmware，操作硬體資源，以完成你的應用。通常你的藍芽周邊裝置 (BLE Peripheral) 都是這樣實作出來的。多數情況，周邊裝置不需要太多資源，像是一個溫度感測器，只需要一個很簡單的板子，上面有藍芽晶片和一些 I\/O，可以讀取溫度值，並透過藍芽協定無線傳送出去，工作就完成了。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　當然你也可以用這種方式開發 central 端，但除非是很簡單的應用，否則應該是很少人這樣做，因為 central 端要負責和裝置的連線、讀\/寫等等，若是同時要控制多個裝置，單靠一些簡單的硬體設備(例如以按鈕操作)，使用的難度會比較高，所以多少會搭配比較友善的 GUI 介面來輔助。另一方面，若以前端工程師的角度來看，可能會比較不知道從何下手，這種比較靠近底層的開發模式會大幅增加他們開發的難度。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E註\u003C\/b\u003E：\u003Cspan style=\"color: #674ea7;\"\u003E有一種使用 Arduino\/MCU + 藍芽串列模組(如HC-05\/06\/08)的模式，我並不把它列為 BLE\/Bluetooth 的開發，這只是用「無線」取代了「有線」的 UART，嚴格說起來我不認為這可以算是藍芽的應用開發，因為這中間絲毫沒有用到 GATT 的概念。業界應該是很少看到以這種模式兜出來的藍芽產品，畢竟你把它當 UART 使用，就注定閹割掉 BLE 低耗電的好處了(那還算的上 BLE 嗎？)。我不知道有多少開發者會認同我這樣的想法？\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch4 style=\"text-align: justify;\"\u003E2.\u0026nbsp;手機 App 開發\u003C\/h4\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　第二種模式，是透過手機去開發藍芽應用程式，這種模式是目前最常見也最普遍的一種做法。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　使用手機開發的好處是在於，現在大部分的手機都內建有藍芽晶片，而 Android 或 iOS 作業系統又都有提供和底層藍芽晶片溝通的 Library，因此開發者不用再擔心與藍芽晶片溝通的問題，也可以在手機這個容器裡很快速地開發出一套帶有美美 GUI 的 app。另一方面，開發者透過手機，可以很輕易地將藍芽裝置連上 Internet，以達成物聯網 (或者說「連網物」) 的功能，簡單快速，大多數的開發者都是以這種模式去搭建藍芽應用。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　但是這種模式有一個很大的問題，就是在大部分的情況下，手機無法一直處在周邊裝置旁邊。若是手機必須一直跟藍芽裝置對連才能控制或監測它們，那就會大大限制住藍芽應用的使用範圍。另外，還有一個大家很常問的問題：「我應該如何說服使用者，讓他們把手機的藍芽(一直)打開呢？」。相較於單純的「連網物」，物聯網場景應該是\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E周邊裝置能夠自動上網，然後接受某種形式的管理，並且在一個區域網路內擁有自己的行為，最終以構成服務為目的\u003C\/span\u003E\u003C\/b\u003E。此外，使用者應該要能隨時隨地(從外部)連網進來或透過雲端服務來觀察或控制那些裝置，而不是時時刻刻都必須待在裝置旁邊才能操作它們。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　以上問題大概是要以 BLE 投入物聯網產品體系時，比較令人擔心的點。反過來說，為什麼目前藍芽多見於穿戴式這種可以長時間與手機保持貼近的應用，因為就很適合那樣的情境呀！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch4 style=\"text-align: justify;\"\u003E3. 以 BLE Gateway 為中心的應用開發\u003C\/h4\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　如上述所說，以往 BLE 的使用場景，往往是藍芽設備必須連接手機才能被控制或存取。例如具有 BLE 介面的溫、濕度感測器，多需要搭配安裝在智慧手機上的特定 App，才能將監測資料傳到雲端，這種模式對於 BLE 在物聯網的發展會非常不利。我會在下一節討論產品相容性的問題。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　為了讓遠端使用者可以透過 Internet 連線至本地端藍芽裝置，進行遠端操控或監測，一台 BLE gateway 是不可或缺的，它可以將藍芽智慧設備連接到網際網路而不需要手機的參與，是遠端使用者和本地端藍芽裝置間溝通的橋梁。\u0026nbsp;\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　目前 BLE gateway 的做法大多是將藍芽封包轉換成 Wi-Fi，達成裝置連網的功能。以德州儀器的 \u003Ca href=\"http:\/\/www.ti.com\/tool\/TIDC-BLE-TO-WIFI-IOT-GATEWAY\" target=\"_blank\"\u003EBluetooth Smart-to-Wi-Fi Gateway solution\u003C\/a\u003E 為例，就是採用 Wi-Fi 模組 CC3200 配合 BLE CC2640 組合成一個簡單的 Gateway，這個 Gateway 主要是利用 MQTT 協定去遠端存取 gateway，藉此操作連接到 gateway 的藍芽裝置 (gateway 作為這些裝置們的 reverse proxy)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　透過 gateway，你就可以搭建一個小型的區域網路，並將網內的裝置都接上 Internet，完成物聯網應用。以智慧家庭為例，只要將家裡那些藍芽裝置連上 gateway，像溫溼度、煙霧感測器或電燈開關，使用者便可以在任何位置連線家中的 BLE 裝置，進行遠端控制或獲得資訊。 這不僅提高便利性，也擴展 BLE 在物聯網的應用功能。只不過，雖然在通訊方面已經內外打通了，但這種方式還是沒有解決產品間相容性的問題，每一家公司的產品可能都有自己的做法，整個 BLE 產品生態系同樣還是破碎化的狀態 (整個物聯網已經夠破碎了)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3 style=\"text-align: justify;\"\u003E三、相容性\u003C\/h3\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　BLE 的資料模型是基於 ATT\/GATT 的，簡單來說，就是一個 BLE 裝置所帶有的屬性資料 (attributes) 是一條一條被記錄在一張表當中，資料如何在兩裝置間流動是由 ATT 的 Client\/Server 模型所定義，而 GATT 則是定義了屬性(資料)的組織方式。SIG 定義了許多 UUIDs (Universally Unique Identifiers)，用來表示不同的 Characteristics 與 Services，也提供開發者定義自己私有的 UUID。為了讓文章保持簡單，我在這裡就此打住，先做一個簡單的總結：「\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E開發者可以挑選這些 SIG 所定義好的和私有的 UUIDs，自由混合以組成描述裝置所需要的資料體。這為開發帶來了極高的彈性。\u003C\/span\u003E\u003C\/b\u003E」\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　這樣的彈性是雙面刃，在某些情況用起來確實很棒，但是在某些情況卻因為這樣的彈性而犧牲了產品間的相容性(因為各家公司的做法都不一樣)。就如同 \u003Ca href=\"http:\/\/bluetoother.github.io\/bipso\/#\/\" target=\"_blank\"\u003EBIPSO\u003C\/a\u003E 官網上的例子：\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cblockquote class=\"tr_bq\" style=\"text-align: justify;\"\u003E當你買 A 公司的燈泡，智慧手機也裝了 A 公司提供的 App；哪一天你想換 B 公司的燈泡，結果你還是會被強迫裝 B 公司的 App。因為你不能用 A 公司的軟體去控制 B 公司的電燈。然後一個選擇 BLE 智慧家庭系列產品的消費者，不是被一家公司給綁死，就是被手機裡一堆 Apps 給煩死! XDDD\u003C\/blockquote\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cb\u003E註\u003C\/b\u003E：\u003Cspan style=\"color: #674ea7;\"\u003E雖然 SIG 有定義一些 Public 的 Profiles 給開發者參考，但說實在，它們還是不足以應付物聯網世界中的多樣性 (Profile 是針對很特定應用的規範，內容制定的非常的細，包含裝置行為都囊括在內)。我想沒有人做一個 BLE 智慧插座會去找 SIG Profile 來跟著實作，況且也沒有智慧插座這種 Profile 可以用 XDD。 BLE 在這方面，比起 ZigBee 的 Clusters 或 IPSO 的 Smart Objects，我覺得真的是比較弱。\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　我個人認為，各家想以 BLE 開發產品的公司都必須好好深思相容性這個問題，如果產品的對象是普羅大眾，那麼想要建立自家（私有的）產品系統所帶來的結果可能會很兩極，要嘛就很多人用，要嘛就很少人用，很難均勻地散布於市場之中。當然，如果產品鎖定的是某一類特殊族群，那就另當別論了。說到底，同樣能做好一件事，為何不選擇相容性最好的做法？經過多年的戰爭與對峙，以往壁壘分明的物聯網體系目前也正在朝相容的路線發展。豈能 BLE 產品的世界，自己跟自己就不相容了，那不是很怪嗎？\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　大家可能會認為，因為我是 BIPSO 的作者，所以才會特別鼓吹相容性的重要性。好啦，或許是有一點啦，哈哈。 但不管我有沒有做 BIPSO，相容性本來就是我目前工作需要去解決的問題。BIPSO 因為解決問題而誕生，我就順便把它公開，然後想不到就這樣被 IPSO 官方給收錄了，我也很驚訝，只能說一切都是緣分啦！不過，我相信 BIPSO 應該還算有點價值，不然也不會受到 IPSO 官方青睞。但說真的，大部分的功勞都是制定 IPSO 標準的人，BIPSO 僅僅是踩在巨人的肩膀上，尋求更好的解決方案而已。小妹只是來沾沾光的XDD\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3 style=\"text-align: justify;\"\u003E四、結語\u003C\/h3\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　BLE gateway 雖然可以解決 BLE 要進入物聯網的一些難處，只不過沒有辦法像使用手機開發一樣那麼方便。再說，就算以 gateway 為中心來進行開發，仍然會遇到產品間不相容的問題，BLE 產品自身的破碎化同樣沒有獲得解決。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　另一方面，gateway 的實作大都是將藍芽封包橋接到網際網路，裝置之間無法互相溝通，例如當溫度太高時自動開啟電風扇，都需要外部控制，若是想要在 gateway 上寫一套自動化應用，又需要改寫韌體，對應用開發者來說有一定的門檻。因此，大部分的開發者還是會選擇用手機去開發。不過呢！\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E現在有個好消息，那就是 SIG 今年發表了\u003Ca href=\"https:\/\/www.bluetooth.com\/news\/pressreleases\/2016\/02\/10\/bluetooth-sig-announces-architecture-to-connect-billions-of-devices-to-the-iot\" target=\"_blank\"\u003E基於 Node.js 的 BLE gateway 開發工具\u003C\/a\u003E，我覺得這是 SIG 對 BLE 進入物聯網世界所做出的積極回應，真的很棒～～\u003C\/span\u003E\u003C\/b\u003E 不過，這說起來也有點心酸啊… 因為早在 SIG 發表之前，就已經有這樣的 gateway 開源解決方案 \u003Ca href=\"https:\/\/github.com\/bluetoother\/ble-shepherd\" target=\"_blank\"\u003Eble-shepherd\u003C\/a\u003E 了 (也是不才小妹我的專案，嗚嗚，只是好像都沒被注意到啊!! 算一算也弄了 1 年了說)。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　SIG 的方案跟 ble-shepherd 一樣都是基於 \u003Ca href=\"https:\/\/github.com\/sandeepmistry\/noble\" target=\"_blank\"\u003Enoble\u003C\/a\u003E，不過 ble-shepherd 還額外支援了 TI 的 CC254X 系列晶片(基於 \u003Ca href=\"https:\/\/github.com\/bluetoother\/cc-bnp\" target=\"_blank\"\u003Ecc-bnp\u003C\/a\u003E，應該也是能支援 CC26XX，不過我目前手邊沒有 TI 的板子可以測試)。此外，ble-shepherd 也原生支援 BIPSO 規範！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　SIG 方案的好處是，它有提供 10 幾支 RESTful APIs 跟 Client \u0026nbsp;端的 web 頁面範例給你用，我想這應該是給系統廠使用的懶人包吧！ㄎㄎ 身為一個 full-stack 工程師，那些東西應該會比較想要自己動手弄吧。 哎呀～反正都是基於 Node.js，不管用哪一個我都推薦啦！\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　這篇文章說到這裡，除了分享一點我在 BLE 應用開發的看法之外，最後的結語是想提醒大家，從今年 SIG 官方拋出 gateway solution 開始，BLE 的應用或開發模式在未來兩三年可能會出現很大的變化 \u003Cspan style=\"font-size: x-small;\"\u003E(想當初某組織好像還很不屑需要閘道器的 solution 啊… XDD)\u003C\/span\u003E。還有還有，Node.js 也是很大的重點，不僅是 SIG 官方，連 Intel 的 Home Gateway 也是跑 Node.js 啊。雖然小妹我是 Node的頭號大粉絲，話可能說的有點誇大，不過環顧周遭(包含開發環境、工具、雲端服務等等)，Node 好像是出來普渡眾生的啊。\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　　當然除了上述所說的，還有一些其他的問題要克服，像是連線數的問題(這可能要等到 BLE Mesh 技術正式發布才有解了…)，這部分就等到之後有機會再討論吧！！ 不管如何，希望台灣科技產業在 BLE 與 Node.js 這方面，也能很快嗅到新的機會，當然也很希望能看到比較老字號的公司之類的，能夠大方擁抱 Node.js。(疑？怎麼好像變成一篇在推廣 Node.js 的文章了！？ 哈哈，那就先這樣吧 XDD 下次再聊！)\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Ch4 style=\"text-align: justify;\"\u003E關於作者\u003C\/h4\u003E\u003Cdiv class=\"\" style=\"clear: both; text-align: left;\"\u003E\u003Ca href=\"https:\/\/4.bp.blogspot.com\/-qme_ZctoODU\/V_Y-1itSj3I\/AAAAAAAAB14\/I4BjUbkLZsEi3Sd4rVXwPSrlJ-8vwXHgACLcB\/s1600\/hedy.jpg\" imageanchor=\"1\" style=\"clear: left; float: left; margin-bottom: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"200\" src=\"https:\/\/4.bp.blogspot.com\/-qme_ZctoODU\/V_Y-1itSj3I\/AAAAAAAAB14\/I4BjUbkLZsEi3Sd4rVXwPSrlJ-8vwXHgACLcB\/s200\/hedy.jpg\" width=\"200\" \/\u003E\u003C\/a\u003E\u003Cb\u003E王雅慧\u003C\/b\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ca href=\"https:\/\/www.facebook.com\/h8108170\" target=\"_blank\"\u003EFacebook\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Ca href=\"https:\/\/github.com\/hedywings\" target=\"_blank\"\u003EGitHub\u003C\/a\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E一個 Node.js 的忠實粉絲，台灣若有 Node Girls 的活動拜託一定要找，哈哈哈...\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E　\u003C\/div\u003E\u003Cdiv style=\"text-align: justify;\"\u003E\u003Cbr \/\u003E\u003C\/div\u003E"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/5366450543765706186\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/10\/smart-phone-ble.html#comment-form","title":"11 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/5366450543765706186"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/5366450543765706186"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/10\/smart-phone-ble.html","title":"準備跟 Smart Phone 說分手？淺談 BLE 開發模式"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/4.bp.blogspot.com\/-qme_ZctoODU\/V_Y-1itSj3I\/AAAAAAAAB14\/I4BjUbkLZsEi3Sd4rVXwPSrlJ-8vwXHgACLcB\/s72-c\/hedy.jpg","height":"72","width":"72"},"thr$total":{"$t":"11"}},{"id":{"$t":"tag:blogger.com,1999:blog-37997006600210175.post-3949927765296842465"},"published":{"$t":"2016-09-22T21:12:00.001+08:00"},"updated":{"$t":"2017-05-10T22:43:36.221+08:00"},"category":[{"scheme":"http://www.blogger.com/atom/ns#","term":"node"},{"scheme":"http://www.blogger.com/atom/ns#","term":"軟體"}],"title":{"type":"text","$t":"非同步程式碼之霧：Node.js 的事件迴圈與 EventEmitter"},"content":{"type":"html","$t":"　\u003Cbr \/\u003E身為一個 Node.js 工程師，怎麼可以不夠了解「非同步程式碼」的行為？我希望能綜合自己的一點心得與經驗，寫一篇探討 Node.js Event Loop 與 Event Pattern 的文章，而且還不能只是泛泛之談，必須稍微有點深度，然後還期待大家能夠很容易地讀懂。\u003Cbr \/\u003E\u003Cbr \/\u003E　　這篇文章是我為這個想法所作的努力，它花了我好幾個晚上，寫了將近 20 個小時左右 (天吶～～)。雖然極力想要用更短的篇幅把一切說明清楚，卻發現這實在沒辦法用短短的幾句話就講完。然而，即便寫得夠多了，但難免還是有疏漏之處，也要請大家有發現錯誤之處，踴躍提出糾正！讓這篇文章能夠呈現最正確的內容！\u003Cbr \/\u003E　\u003Cbr \/\u003E\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003E導讀\u003C\/span\u003E\u003C\/b\u003E：您知道現在已經不能再使用 process.nextTick() 來拆分你的 long-running task 了嗎？假使您對 Node.js 的非同步程式行為已經有很好的認識，您可直接跳至本文章的「\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003E警告！\u003C\/span\u003E\u003C\/b\u003E」之處，直接了解 Node.js 官方給開發者的提醒。\u003Cbr \/\u003E　\u003Cbr \/\u003E接下來的文章會有點長，但其實是因為貼上程式碼的關係。在您要閱讀之前，請您先靜下心，請您給我 20 分鐘的耐心與時間，和我一起撥雲見日。\u003Cbr \/\u003E\u003Ch3\u003E先來一段小程式，猜猜看 console.log 的列印順序\u003C\/h3\u003E為了刺激一下你，請先看看底下的程式碼，那些訊息將被列印的順序？測試一下自己對 Node.js 非同步行為的認知。\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;0\u0026gt; schedule with setTimeout in 1-sec\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EsetTimeout\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[0] setTimeout in 1-sec boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E}, \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1000\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;1\u0026gt; schedule with setTimeout in 0-sec\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EsetTimeout\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[1] setTimeout in 0-sec boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E}, \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;2\u0026gt; schedule with setImmediate\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EsetImmediate\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[2] setImmediate boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;3\u0026gt; A immediately resolved promise\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EaPromiseCall\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E().\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Ethen\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[3] promise resolve boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;4\u0026gt; schedule with process.nextTick\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprocess\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EnextTick\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[4] process.nextTick boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EaPromiseCall\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EPromise\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eresolve\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ereject\u003C\/span\u003E) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eresolve\u003C\/span\u003E();\u003Cbr \/\u003E    });\u003Cbr \/\u003E}\u003C\/span\u003E\u003C\/pre\u003E執行結果：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;0\u0026gt;\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E schedule with setTimeout \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ein\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E 1-sec\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;1\u0026gt;\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E schedule with setTimeout \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ein\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E 0-sec\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;2\u0026gt;\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E schedule with setImmediate\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;3\u0026gt;\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E A immediately resolved promise\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;4\u0026gt;\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E schedule with process.nextTick\u003Cbr \/\u003E[4] process.nextTick boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E[3] promise resolve boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cb\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E[1]\u003C\/span\u003E\u003C\/b\u003E\u003Cspan style=\"color: #333333;\"\u003E setTimeout in 0-sec boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E\u003Cb\u003E[2]\u003C\/b\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E setImmediate boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E[0] setTimeout in 1-sec boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003C\/pre\u003E\u003Cdiv style=\"text-align: right;\"\u003E(\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003E注意\u003C\/span\u003E\u003C\/b\u003E：在你的電腦上，\u003Cb\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E[1] \u003C\/span\u003E\u003C\/b\u003E與\u003Cspan style=\"color: #6aa84f;\"\u003E \u003Cb\u003E[2]\u003C\/b\u003E \u003C\/span\u003E發生的順序\u003Cspan style=\"color: #6aa84f;\"\u003E可能會與我的不同\u003C\/span\u003E)\u003C\/div\u003E\u003Cbr \/\u003E好的，如果您猜對了。讓我們再來看看，如果這些事情發生在 I\/O Callback 中又是如何？同樣的程式碼，整包塞進\u0026nbsp;readFile() 這支非同步 I\/O API 的 Callback 中：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E fs \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efs\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box; color: #333333;\"\u003Efs\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EreadFile\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E.\/file.txt\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E, \u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eutf8\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E, \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E (\u003C\/span\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box; color: #333333;\"\u003Eerr\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E, \u003C\/span\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box; color: #333333;\"\u003Edata\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E) {\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E (\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003Eerr) {\u003Cbr \/\u003E       \u003C\/span\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[I\/O Callback get called] \u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E+\u003C\/span\u003E data  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E+\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003Cspan class=\"pl-cce\" style=\"box-sizing: border-box;\"\u003E\\n\u003C\/span\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;0\u0026gt; schedule with setTimeout in 1-sec\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EsetTimeout\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E            \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[0] setTimeout in 1-sec boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E        }, \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1000\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;1\u0026gt; schedule with setTimeout in 0-sec\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EsetTimeout\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E            \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[1] setTimeout in 0-sec boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E        }, \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;2\u0026gt; schedule with setImmediate\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EsetImmediate\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E            \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[2] setImmediate boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E        });\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;3\u0026gt; A immediately resolved promise\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EaPromiseCall\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E().\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Ethen\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E () {\u003Cbr \/\u003E            \u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E.\u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(\u003C\/span\u003E\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[3] promise resolve boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E);\u003Cbr \/\u003E        });\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003C\/span\u003E\u003Cspan style=\"color: #e69138;\"\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u0026lt;4\u0026gt; schedule with process.nextTick\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E        \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprocess\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EnextTick\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E            \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E[4] process.nextTick boom!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E        });\u003Cbr \/\u003E    }\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EaPromiseCall\u003C\/span\u003E () {  \/\/ ... 略\u003C\/span\u003E\u003C\/pre\u003E執行結果\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan style=\"color: #333333;\"\u003E[I\/O Callback get called] \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eread\u003C\/span\u003E file boom\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;0\u0026gt;\u003C\/span\u003E schedule with setTimeout \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ein\u003C\/span\u003E 1-sec\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;1\u0026gt;\u003C\/span\u003E schedule with setTimeout \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ein\u003C\/span\u003E 0-sec\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;2\u0026gt;\u003C\/span\u003E schedule with setImmediate\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;3\u0026gt;\u003C\/span\u003E A immediately resolved promise\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;4\u0026gt;\u003C\/span\u003E schedule with process.nextTick\u003Cbr \/\u003E[4] process.nextTick boom\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cbr \/\u003E[3] promise resolve boom\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E\u003Cb\u003E[2]\u003C\/b\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E setImmediate boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E\u003Cb\u003E[1]\u003C\/b\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E setTimeout in 0-sec boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E[0] setTimeout 1-sec boom\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003C\/pre\u003E\u003Cdiv style=\"text-align: right;\"\u003E(\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003E注意\u003C\/span\u003E\u003C\/b\u003E：在你的電腦上，\u003Cspan style=\"color: #6aa84f;\"\u003E\u003Cb\u003E[2]\u003C\/b\u003E\u003C\/span\u003E 與\u003Cspan style=\"color: #6aa84f;\"\u003E\u003Cb\u003E [1] \u003C\/b\u003E\u003C\/span\u003E發生的順序\u003Cspan style=\"color: #6aa84f;\"\u003E一定會跟我的相同\u003C\/span\u003E)\u003C\/div\u003E\u003Cbr \/\u003E接下來，請靜下心，讓我們好好地來了解 Node.js 的非同步機制。真的要靜下心來看哦！因為很希望讓你看過一次，就把它給搞懂！\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003E熱身：JavaScript 的事件迴圈與非同步機制\u003C\/h3\u003E對於 JavaScript 的事件迴圈與非同步行為，很多書或網路文章都做了很淺顯易懂的說明，加上從實作中累積的經驗，相信每個 JS 的開發者內心，都隱隱約約有概念。\u003Cbr \/\u003E　　\u003Cbr \/\u003E　　如果您還不是那麼清楚，以下兩部 P. Roberts 的影片，您可以花一點時間先看一下。第一部長約 15 分鐘，講得非常好，他很清楚地說明了\u003Cb\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E瀏覽器\u003C\/span\u003E\u003C\/b\u003E中 JS 的 Single Thread + Single Call Stack + Callback Queue 是怎麼樣搭配運行起來的，簡單易懂。第二部影片是他在 JSConfEU 的演講，內容跟第一部大同小異，但是多了一個展示用的 webapp，所以可以跳過不看。當然，JS 老手這兩部都可以直接跳過啦 XDDD....\u003Cbr \/\u003E\u003Cul\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/vimeo.com\/96425312\" target=\"_blank\"\u003EHelp, I’m stuck in an event-loop\u003C\/a\u003E\u0026nbsp;-\u0026nbsp;Philip Roberts\u003C\/li\u003E\u003Cli\u003E\u003Ca href=\"https:\/\/www.youtube.com\/watch?v=8aGhZQkoFbQ\" target=\"_blank\"\u003EWhat the heck is the event loop anyway?\u003C\/a\u003E\u0026nbsp;| JSConf EU \u0026nbsp;- Philip Roberts\u003C\/li\u003E\u003C\/ul\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cbr \/\u003E　　在 Browser 上的情況很容易理解。相對於瀏覽器，作為執行在 Server-side 的 Node.js，事情會稍微複雜一點。Node.js 採用 Google \u003Ca href=\"https:\/\/developers.google.com\/v8\/?hl=zh-tw\" target=\"_blank\"\u003EV8 \u003C\/a\u003E作為 JS 的解釋引擎，而在處理 I\/O 方面則使用了自己設計的 \u003Ca href=\"http:\/\/docs.libuv.org\/en\/v1.x\/\" target=\"_blank\"\u003Elibuv\u003C\/a\u003E。libuv 幫你封裝了不同 OS 平台的 I\/O 操作，往上提供一致的 asynchronous\/non-blocking API 與事件迴圈建設。當我們在討論 Node.js 的事件迴圈時，將會與 libuv 有關。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-5HK7GJNiMoI\/V-NWXY1RuSI\/AAAAAAAAB1Q\/U23hdfs2bmohitL7iKoxCyDqErg-9Bd7ACLcB\/s1600\/nodearchpng.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"270\" src=\"https:\/\/2.bp.blogspot.com\/-5HK7GJNiMoI\/V-NWXY1RuSI\/AAAAAAAAB1Q\/U23hdfs2bmohitL7iKoxCyDqErg-9Bd7ACLcB\/s400\/nodearchpng.png\" width=\"400\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Ch3\u003ENode.js 真的是單執行緒嗎？\u003C\/h3\u003E對於 Node.js 的評論，最常聽見它「單一執行緒」的環境，但實際上它的底層是多執行緒的。Daniel Khan 在 \u003Ca href=\"http:\/\/apmblog.dynatrace.com\/2016\/01\/14\/how-to-track-down-cpu-issues-in-node-js\/\" target=\"_blank\"\u003E\"How to track down CPU issues in Node.js\"\u003C\/a\u003E\u0026nbsp;這篇文章中起了很好的頭，它直接將 node 執行一支 app.js 時，所跑起來的 process 都列出來給你看。我們直接看 Khan 先生怎麼說 (要我自己說，絕對不會比他說的好)：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Cspan style=\"font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003E\u003Cspan style=\"color: #444444;\"\u003E\u003Ci\u003EThe famous statement ‘Node.js runs in a single thread’ is only partly true. \u003Cspan style=\"background-color: yellow;\"\u003EActually only your ‘userland’ code runs in one thread.\u003C\/span\u003E Starting a simple node application and looking at the processes reveals that Node.js in fact spins up a number of threads. This is because Node.js maintains a thread pool to delegate synchronous tasks to, while Google V8 creates its own threads for tasks like garbage collection.\u003C\/i\u003E\u003C\/span\u003E\u0026nbsp;\u003C\/span\u003E\u003C\/blockquote\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-BGE5jF78dbM\/V-EwucVyv3I\/AAAAAAAAB0Q\/vW7o53J3ScwZ1y0DB7iJKd92JewbJ6WowCLcB\/s1600\/CPU1-1024x214.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"81\" src=\"https:\/\/3.bp.blogspot.com\/-BGE5jF78dbM\/V-EwucVyv3I\/AAAAAAAAB0Q\/vW7o53J3ScwZ1y0DB7iJKd92JewbJ6WowCLcB\/s400\/CPU1-1024x214.png\" style=\"cursor: move;\" width=\"400\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Ch3\u003E\u003Cbr \/\u003Elibuv 的 Event Loop 與 Loop Iteration\u003C\/h3\u003E在 libuv 的核心程式碼中，我們會看到一支\u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003E uv_run() \u003C\/span\u003E的函式，他所接受的第一個參數是一個指向\u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003E\u0026nbsp;uv_loop_t\u0026nbsp;\u003C\/span\u003E結構體的指標。這裡，\u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003Euv_loop_t \u003C\/span\u003E結構體即事件迴圈\u0026nbsp;\u003Cspan style=\"font-size: x-small;\"\u003E(名詞)\u003C\/span\u003E，而每一次執行\u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003E uv_run()\u003C\/span\u003E 則是進行一次事件迴圈的 iteration \u003Cspan style=\"font-size: x-small;\"\u003E(執行 uv_run() 是動詞)\u003C\/span\u003E。\u003Cbr \/\u003E\u003Cbr \/\u003E　　\u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003Euv_run()\u003C\/span\u003E 這函式真的是寫得淺顯易懂，我們不需要太執著於細節，只需要知道這支函式一執行起來，將依序跑過 \u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003Euv__update_time(), uv__run_timers(), uv__run_pendings(), ..., uv__run_closing_handles() \u003C\/span\u003E等函式，每支函式稱之為 event loop 的\u003Cb\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E\u003Ci\u003E phase\u003C\/i\u003E\u003C\/span\u003E\u003C\/b\u003E (階段)。Event Loop 跑完一圈，總共會歷經這幾個階段。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cb\u003Elibuv core.cc\u003C\/b\u003E (\u003Cspan id=\"goog_917402993\"\u003E\u003C\/span\u003E\u003Ca href=\"https:\/\/github.com\/libuv\/libuv\/blob\/v1.x\/src\/unix\/core.c#L332-L372\" target=\"_blank\"\u003E原始碼\u0026nbsp;core.cc\u003C\/a\u003E)，底下的程式碼片段用眼睛稍微掃過即可：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; font-family: consolas, \u0026quot;liberation mono\u0026quot;, menlo, courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eint\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Euv_run\u003C\/span\u003E(\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_loop_t\u003C\/span\u003E* loop, uv_run_mode mode) {\u003Cbr \/\u003E  \u003C\/span\u003E\u003Cspan style=\"color: #999999;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E  r = \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__loop_alive\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E  \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E (!r)\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__update_time\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ewhile\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E (r != \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E \u0026amp;\u0026amp; loop-\u0026gt;stop_flag == \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E) {\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__update_time\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__run_timers\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E    ran_pending = \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__run_pending\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__run_idle\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__run_prepare\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E\u003Cbr \/\u003E    timeout = \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E;\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E ((mode == UV_RUN_ONCE \u0026amp;\u0026amp; !ran_pending) || mode == UV_RUN_DEFAULT)\u003Cbr \/\u003E      timeout = \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_backend_timeout\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__io_poll\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop, timeout);\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__run_check\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__run_closing_handles\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E\u003Cbr \/\u003E    \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E (mode == UV_RUN_ONCE) {\u003Cbr \/\u003E      \u003C\/span\u003E\u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #666666;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E      \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__update_time\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E      \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__run_timers\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E    }\u003Cbr \/\u003E\u003Cbr \/\u003E    r = \u003C\/span\u003E\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv__loop_alive\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E(loop);\u003Cbr \/\u003E\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E    \u003C\/span\u003E\u003Cspan style=\"color: #666666;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E\u003Cbr \/\u003E  \u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E\u003Cspan style=\"color: #333333;\"\u003E r;\u003Cbr \/\u003E}\u003C\/span\u003E\u003C\/pre\u003E\u003Ch3\u003E\u003C\/h3\u003E\u003Ch3\u003ENode.js 官方文件對事件迴圈的說明\u003C\/h3\u003ENode.js 官方隨附在原始碼中有一份非常佛心的文件，很簡要地說明了 \u003Ca href=\"https:\/\/github.com\/nodejs\/node\/blob\/v4.x\/doc\/topics\/the-event-loop-timers-and-nexttick.md\" target=\"_blank\"\u003EEvent Loop 的運作方式\u003C\/a\u003E，讓我們不需要苦讀原始碼，便能對 Event Loop 的行為略知一二。這份文件是今年 4 月(2016 年 4 月) 加上去的，熱騰騰呀！\u003Cbr \/\u003E\u003Cbr \/\u003E　　這份文件給了一張圖，我把它重新畫了一次，並且跟上面 libuv core.cc 中看到的各個 phase 工作函式左右對照一下，這樣應該就夠簡單清楚了。我認為每個 Node.js 的開發者，都應該好好閱讀一下這份文件。那如果你真的很懶得看，我下面會作一些重點摘要。這裡先說明一下圖中右邊的「I\/O Callbacks」，例如系統錯誤 (比如 socket 的錯誤, ECONNREFSED) 這一類的 callbacks 都會被 queue 在這裡，對應的是 uv__run_pending() 階段。如果是一般的 I\/O 請求，callbacks 是在 poll 階段被執行。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003C\/div\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-GRE4ySmk9kY\/V-FGYV3nMCI\/AAAAAAAAB08\/ERQArg-1JWkrACrRpjP6Wg_MheRXCEo1gCLcB\/s1600\/node-libuv.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" height=\"288\" src=\"https:\/\/2.bp.blogspot.com\/-GRE4ySmk9kY\/V-FGYV3nMCI\/AAAAAAAAB08\/ERQArg-1JWkrACrRpjP6Wg_MheRXCEo1gCLcB\/s640\/node-libuv.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003EEvent Loop 特點摘要\u003C\/h3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cspan style=\"background-color: yellow;\"\u003E每個 phase 都有自己的 FIFO queue\u003C\/span\u003E，裡面存放和自己相關的 callbacks\u003C\/li\u003E\u003Cli\u003E進入一個 phase 後，該 phase 會將自己 queue 中的 callbacks \u003Cspan style=\"background-color: yellow;\"\u003E依序地同步執行\u003C\/span\u003E，直到完全消化完畢時 (或達到最高數量限制) 再繼續往下個 phase 走\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003E「不要在 callback 中執行繁重的工作，否則事件迴圈將會被阻塞住」，原因在此\u003C\/li\u003E\u003C\/ul\u003E\u003Cli\u003E當 Event Loop 繞完後，若檢查發現已無任何等待中的非同步 I\/O 或 timers，事件迴圈即結束退出\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003E比如說你寫一支 app.js，裡面只有 console.log('Hello')，執行完一定馬上退出。如果你寫一個 http server.listen(3000, function () { ... })，執行起來之後，就一直執行著，因為底層開了一個 socket 一直在等待它的 I\/O 事件，除非你把 socket 給 close 掉\u003C\/li\u003E\u003C\/ul\u003E\u003C\/ul\u003E\u003Ch3\u003E各 Phase 的責任說明\u003C\/h3\u003E\u003Cul\u003E\u003Cli\u003Etimer：執行由 setTimeout() 及 setInterval() 排進來的 callbacks\u003C\/li\u003E\u003Cli\u003EI\/O callbacks：有關系統錯誤等 Callbacks 將 queue 在此\u003C\/li\u003E\u003Cli\u003Eidle, prepare：內部使用\u003C\/li\u003E\u003Cli\u003Epoll：向系統取回新的 I\/O 事件，執行對應的 I\/O callbacks\u003C\/li\u003E\u003Cli\u003Echeck：執行由 setImmediate() 排進來的 callbacks\u003C\/li\u003E\u003Cli\u003Eclose callbacks：監聽 I\/O 'close' 事件的 callbacks (如 socket.on('close', ...))\u003C\/li\u003E\u003C\/ul\u003E\u003Ch3\u003E將工作 (或 callback) 排入事件迴圈中的方法\u003C\/h3\u003E如何將工作排入事件迴圈的觀念非常非常重要，或許你覺得沒什麼，但這卻會關係到如何寫出行為正確地的非同步程式碼。\u003Cbr \/\u003E\u003Cdiv\u003E\u003Cul\u003E\u003Cli\u003E使用了 timer 的 \u003Cspan style=\"background-color: yellow;\"\u003EsetTimeout()\u003C\/span\u003E, \u003Cspan style=\"background-color: yellow;\"\u003EsetInterval()\u003C\/span\u003E\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003Ecallbacks 會被排進 timer phase 的 queue\u003C\/li\u003E\u003C\/ul\u003E\u003Cli\u003E呼叫了使用 libuv \u003Cspan style=\"background-color: yellow;\"\u003Enon-blocking IO 的 API\u003C\/span\u003E\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003E如 sockets, filesystem 相關 API，在 node 裡即如 fs.readFile() 這種非同步的 API\u003C\/li\u003E\u003C\/ul\u003E\u003Cli\u003E使用 \u003Cspan style=\"background-color: yellow;\"\u003EsetImmediate()\u003C\/span\u003E\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003Ecallbacks 被排入 check phase 的 queue\u003C\/li\u003E\u003C\/ul\u003E\u003Cli\u003E透過 \u003Cspan style=\"background-color: yellow;\"\u003Eprocess.nextTick()\u003C\/span\u003E\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003E屬於 Node Event Loop 的一部分，但不屬於 libuv 的 phase。這後面我會說明。\u003C\/li\u003E\u003C\/ul\u003E\u003Cli\u003E還有一個文件中沒有提到，就是使用了 \u003Cspan style=\"background-color: yellow;\"\u003EPromise (microtask)\u003C\/span\u003E\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003E屬於 node event loop 的一部分，但不屬於 libuv 的 phase。這後面我會說明。\u003C\/li\u003E\u003C\/ul\u003E\u003C\/ul\u003E\u003C\/div\u003E\u003Ch3\u003E一個 tick 到底是多長?\u003C\/h3\u003E前面我們有看到 process.nextTick() 這個 API，您是否有想過，nextTick？那一個 tick 的時間到底是多長？\u003Ca href=\"http:\/\/stackoverflow.com\/questions\/19822668\/what-exactly-is-a-node-js-event-loop-tick\" target=\"_blank\"\u003EStackoverflow 上的這個回答\u003C\/a\u003E很清楚，很簡短地說是這樣：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E一個 tick 的時間長度，是 Event Loop 繞完一圈，把所有 queues 中的 callbacks 依序且同步地執行完，所消耗的總時間。因此，一個 tick 的值是不固定的。可能很長，可能很短，但我們希望它能盡量地短。\u003C\/blockquote\u003E所以再一次，所有 Node.js 開發者一再強調：「不要在 callback 中執行 long-running 的工作！」因為你會阻塞 Event Loop，當每一個 tick 的時間被你拉長，代表每單位時間 Event Loop 可以繞行而檢測出 I\/O 事件的次數就會降低，非同步程式碼的效能因而折損。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003E執行順序\u003C\/h3\u003E關於執行順序，請閱讀官方文件的 \u003Ca href=\"https:\/\/github.com\/nodejs\/node\/blob\/v4.x\/doc\/topics\/the-event-loop-timers-and-nexttick.md#phases-in-detail\" target=\"_blank\"\u003EPhases in Detail \u003C\/a\u003E一節。我很快地總結一下幾個重點，同樣回到底下這張圖。雖然整個迴圈看起來是從 timers 開始執行起，在 libuv 看起來也是這樣子。這樣說好了，Event Loop 是一個閉迴路，它在第一次 kick off 時，確實是從 timers 那個 phase 跑起。但是以長遠來看，一個閉迴路，你可以拿任意點當作起跑點。由於程式的目的大多與 I\/O 有關，例如你開了一個 socket，所以 Event Loop 的重心可以視為圍繞在 poll phase 上，因為繞來繞去，你總是會在 poll phase 停留一下子，把該執行的執行完後，再東看看、西看看，看還有沒有其他事情要繼續做的。你在網路上會看到許多文章，或是這份官方文件，都是以 poll phase 作為討論的核心。並且注意官方文件的這句話：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Cspan style=\"font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003E\u003Ci\u003ETechnically, the poll phase controls when timers are executed.\u003C\/i\u003E\u003C\/span\u003E\u003C\/blockquote\u003E\u003Ca href=\"https:\/\/2.bp.blogspot.com\/-GRE4ySmk9kY\/V-FGYV3nMCI\/AAAAAAAAB08\/ERQArg-1JWkrACrRpjP6Wg_MheRXCEo1gCLcB\/s1600\/node-libuv.png\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em; text-align: center;\"\u003E\u003Cimg border=\"0\" height=\"288\" src=\"https:\/\/2.bp.blogspot.com\/-GRE4ySmk9kY\/V-FGYV3nMCI\/AAAAAAAAB08\/ERQArg-1JWkrACrRpjP6Wg_MheRXCEo1gCLcB\/s640\/node-libuv.png\" width=\"640\" \/\u003E\u003C\/a\u003E\u003Cbr \/\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E官方的說明比較零碎一點，我依照我的理解整理一下，如果我們從 poll 開始看起，整個順序會像這樣：\u003Cbr \/\u003E\u003Cdiv\u003E\u003Cul\u003E\u003Cli\u003Epoll phase：I\/O 事件先處理，同時會關心即將逾期的 timer，都處理完後進 check phase\u0026nbsp;\u003C\/li\u003E\u003Cli\u003Echeck phase：處理\u0026nbsp;setImmedaite() 排進來的東西，如果沒有、或處理完了，就捲回 timers 看沒有要到期的\u003C\/li\u003E\u003Cli\u003E然後繼續往下走回到 poll，先看有沒有 I\/O 事件要處理同時關心即將逾期的 timer\u003C\/li\u003E\u003Cli\u003E\u003Cb\u003E一般原則\u003C\/b\u003E\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003Etimer 快逾期，但 I\/O 事件先發生，一律會先等 I\/O 先處理完，再處理到期的 timers，也因此 timers 的 callbacks 不保證可以準時執行\u003C\/li\u003E\u003Cli\u003E以官網的例子來講：例如有個 timer 在 100ms 後到期，但在即將到期之前來了一個 I\/O 事件，則先處理 I\/O，所以 timer 的 callback 可能會稍微延宕一下才被執行到，例如在第 105 ms 時才執行\u003C\/li\u003E\u003C\/ul\u003E\u003Cli\u003E\u003Cb\u003E最高原則\u003C\/b\u003E\u003C\/li\u003E\u003Cul\u003E\u003Cli\u003E\u003Cspan style=\"background-color: yellow;\"\u003E所有以 process.nextTick() 所安排進來的 callbacks 都將在每一個 phase 結束，要轉換至下個 phase 之前，馬上被依序且同步地執行\u003C\/span\u003E\u003C\/li\u003E\u003Cli\u003E因此絕對不可在 process.nextTick 的 callback 中執行 long-running task\u003C\/li\u003E\u003Cli\u003E不可以執行會遞迴呼叫 process.nextTick 的函式，因為那個 phase 永遠會檢測到還有 1 個 callback 要執行，因而造成 Event Loop 永遠被阻塞於該 phase\u003C\/li\u003E\u003C\/ul\u003E\u003C\/ul\u003E\u003Cdiv style=\"text-align: right;\"\u003E\u003Cspan style=\"color: #e06666;\"\u003E(如果有人看了官方文件，認為我的理解有誤，請一定要讓我知道！)\u003C\/span\u003E\u003C\/div\u003E\u003Cdiv\u003E\u003Cbr \/\u003E\u003C\/div\u003E\u003Ch3\u003EsetTimeout() 與 setImmediate()\u003C\/h3\u003E\u003Cul\u003E\u003Cli\u003EsetTimeout() 屬於 timers phase。被設計於逾時執行。\u003C\/li\u003E\u003Cli\u003EsetImmediate() 屬於 check phase。被設計在每次 poll phase 之後執行。\u003C\/li\u003E\u003Cli\u003EsetImmediate() 並不是以計時器來定時的，但 Node.js 仍將這個 API 歸類在 timers 核心模組\u003C\/li\u003E\u003Cli\u003E這兩支方法，如果在 I\/O cycle 被呼叫，setImmediate(cb) 者必定會先執行(因為下一個 phase 就是 check)。如果不是在 I\/O cycle 被呼叫，setImmediate(cb) 與 zeo-second \u0026nbsp;setTimeout(cb, 0) 兩者被執行的次序為\u003Cspan style=\"background-color: yellow;\"\u003E不可預測\u003C\/span\u003E (non-deterministic)\u003C\/li\u003E\u003Cli\u003E請回到文章最開始的「猜猜看」，那裡的 \u003Cb\u003E\u003Cspan style=\"color: #6aa84f;\"\u003E[1] \u003C\/span\u003E\u003C\/b\u003E與 \u003Cspan style=\"color: #6aa84f;\"\u003E\u003Cb\u003E[2]\u003C\/b\u003E\u003C\/span\u003E 發生順序的問題在此處得到了說明\u003C\/li\u003E\u003C\/ul\u003E\u003Cbr \/\u003E\u003Ch3\u003Eprocess.nextTick() 與 setImmediate()\u003C\/h3\u003E\u003Cul\u003E\u003Cli\u003Eprocess.nextTick 不屬於任何一個 phase (後面會提到)\u003C\/li\u003E\u003Cli\u003E由\u0026nbsp;process.nextTick()\u0026nbsp;所排進 queue 的 callbacks 會在當下的那個 phase 結束前被拉出來，全部執行完。所以你若遞迴地呼叫\u0026nbsp;process.nextTick()，將造成 queue 永遠無法清空，該 phase 永遠無法轉換到下一個 phase，因而會造成 I\/O starving(飢餓) 的問題 (無法再 poll)\u003C\/li\u003E\u003Cli\u003E遞迴地呼叫 setImmediate() 所排進的下一個 callback，會被排到下一次 loop iteration 才執行，所以不會塞住 Event Loop\u003C\/li\u003E\u003Cli\u003E神奇的 process.nextTick()，連大神 \u003Ca href=\"https:\/\/github.com\/mafintosh\" target=\"_blank\"\u003Emafintosh \u003C\/a\u003E去年 7 月都在 twitter 上徵求：「\u003Ca href=\"https:\/\/twitter.com\/mafintosh\/status\/624590818125352960\" target=\"_blank\"\u003EDoes anyone have a good code example of when to use setImmediate instead of nextTick?\u003C\/a\u003E」 XDDDD....\u003C\/li\u003E\u003C\/ul\u003E\u003Ch4\u003E\u003Cb\u003E\u003Cspan style=\"color: red;\"\u003E警告！\u003C\/span\u003E\u003C\/b\u003E\u003C\/h4\u003E\u003C\/div\u003E\u003Cdiv\u003E你很可能在書上看到一些教你「使用 process.nextTick()」來拆分 long-running task 的做法！由於 Node.js 對 process.nextTick() 的行為已經調整過。請勿再使用書上介紹的方式，因為 Event Loop 仍然會被你的 long-running task 阻塞住！(拆開的 sub-tasks 仍是排在同一個 phase 中，同步地執行完，結果變成有拆跟沒拆一樣啊！哈哈～ 請改用 setImmediate() 去拆囉～)\u003C\/div\u003E\u003Cdiv\u003E　\u003Cbr \/\u003E從今天起，請勿被它的名字誤導，請不要再有「process.nextTick」可以將工作排到下一次 tick 的想法了！非常非常危險！官方文件這樣說：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Cspan style=\"font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003E\u003Ci\u003EWe recommend developers use setImmediate() in all cases because it's easier to reason about (and it leads to code that's compatible with a wider variety of environments, like browser JS.)\u003C\/i\u003E\u003C\/span\u003E\u003C\/blockquote\u003E\u003Cbr \/\u003E\u003Ch3\u003ENode.js 的 Event Loop\u003C\/h3\u003ENode 官方文件上有提到，它說 process.nextTick 並不算 libuv 的 event loop phases 的一部分。你可以這樣想，Node 的 Event Loop 是對底層 libuv 的一層包裹，在這一層包裹之內、libuv 之外，還有其他事情得處理，就是 process.nextTick 與 Promise 的 microtask。所以當我們談論 Node 的 Event Loop，指的是在 Node 層級的 Event Loop 整體，而不僅是單單 libuv 的 event loop 本身。\u003Cbr \/\u003E　\u003Cbr \/\u003E我在「\u003Ca href=\"http:\/\/simeneer.blogspot.tw\/2016\/09\/node-i-module.html\" target=\"_blank\"\u003E從 node.js 原始碼看 exports 與 module.exports\u003C\/a\u003E」這篇文章有提到 Node 核心是如何執行起來的，順序是這樣：\u003Cbr \/\u003E\u003Cdiv style=\"text-align: center;\"\u003E\u003Cspan style=\"color: blue; font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003EStartNodeInstance() -\u0026gt; CreateEnvironment() -\u0026gt; LoadEnvironment()\u003C\/span\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Ch4\u003EStartNodeInstance()\u003C\/h4\u003E在 StartNodeInstance() 中 uv_run() 被呼叫了，而且是在一個 do ... while 迴圈之中。在 Node 層級上看到的 Event Loop 就在這裡：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E    {\u003Cbr \/\u003E      SealHandleScope \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eseal\u003C\/span\u003E(isolate);\u003Cbr \/\u003E      bool more;\u003Cbr \/\u003E      \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Edo\u003C\/span\u003E {\u003Cbr \/\u003E        v8\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E::\u003C\/span\u003Eplatform\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E::\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EPumpMessageLoop\u003C\/span\u003E(default_platform, isolate);\u003Cbr \/\u003E        more \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Euv_run\u003C\/span\u003E(env\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E-\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026gt;\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eevent_loop\u003C\/span\u003E(), \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EUV_RUN_ONCE\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (more \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E==\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Efalse\u003C\/span\u003E) {\u003Cbr \/\u003E          v8\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E::\u003C\/span\u003Eplatform\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E::\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EPumpMessageLoop\u003C\/span\u003E(default_platform, isolate);\u003Cbr \/\u003E          \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EEmitBeforeExit\u003C\/span\u003E(env);\u003Cbr \/\u003E\u003Cbr \/\u003E          \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ Emit `beforeExit` if the loop became alive either after emitting\u003C\/span\u003E\u003Cbr \/\u003E          \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ event, or after running some callbacks.\u003C\/span\u003E\u003Cbr \/\u003E          more \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Euv_loop_alive\u003C\/span\u003E(env\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E-\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026gt;\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eevent_loop\u003C\/span\u003E());\u003Cbr \/\u003E          \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Euv_run\u003C\/span\u003E(env\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E-\u003C\/span\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026gt;\u003C\/span\u003E\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eevent_loop\u003C\/span\u003E(), \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EUV_RUN_NOWAIT\u003C\/span\u003E) \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E)\u003Cbr \/\u003E            more \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Etrue\u003C\/span\u003E;\u003Cbr \/\u003E        }\u003Cbr \/\u003E      } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ewhile\u003C\/span\u003E (more \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E==\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Etrue\u003C\/span\u003E);\u003Cbr \/\u003E    }\u003C\/pre\u003E\u003Cbr \/\u003E\u003Ch4\u003ECreateEnvironment()\u003C\/h4\u003E建立環境時，需要傳入一個指向 uv_loop_t 結構體的指標，這也告訴我們，每一個 node 的實例都將擁有自己的 Event Loop。建立過程的一部分程式碼即在初始化各個 phase。\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003EEnvironment* \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003ECreateEnvironment\u003C\/span\u003E(Isolate* isolate,\u003Cbr \/\u003E                               \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_loop_t\u003C\/span\u003E* loop,\u003Cbr \/\u003E                               \/\/ ... 略\u003Cbr \/\u003E                               \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Echar\u003C\/span\u003E* \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E* exec_argv) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_check_init\u003C\/span\u003E(env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eevent_loop\u003C\/span\u003E(), env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eimmediate_check_handle\u003C\/span\u003E());\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_unref\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereinterpret_cast\u003C\/span\u003E\u0026lt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_handle_t\u003C\/span\u003E*\u0026gt;(env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eimmediate_check_handle\u003C\/span\u003E()));\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_idle_init\u003C\/span\u003E(env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eevent_loop\u003C\/span\u003E(), env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eimmediate_idle_handle\u003C\/span\u003E());\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_prepare_init\u003C\/span\u003E(env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eevent_loop\u003C\/span\u003E(), env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eidle_prepare_handle\u003C\/span\u003E());\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_check_init\u003C\/span\u003E(env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eevent_loop\u003C\/span\u003E(), env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eidle_check_handle\u003C\/span\u003E());\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_unref\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereinterpret_cast\u003C\/span\u003E\u0026lt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_handle_t\u003C\/span\u003E*\u0026gt;(env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eidle_prepare_handle\u003C\/span\u003E()));\u003Cbr \/\u003E  \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_unref\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereinterpret_cast\u003C\/span\u003E\u0026lt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Euv_handle_t\u003C\/span\u003E*\u0026gt;(env-\u0026gt;\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eidle_check_handle\u003C\/span\u003E()));\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E env;\u003Cbr \/\u003E}\u003C\/pre\u003E\u003Ch4\u003E\u0026nbsp;startup.processNextTick() (\/src\/node.js)\u003C\/h4\u003E\u003Cdiv\u003E這裡我們只要關注一開始的 nextTickQueue，還有 process.nextTick()，這支方法僅僅是把註冊的 callbacks 安排進這個 queue 中。在 _tickCallback() 被抓出來執行時，就把 queue 中的每支 callbacks 撈出來執行，而這些處理完後，下一步則是 _runMicroTasks() 繼續處理 Promise 的事情。如果您想更進一步了解 microtasks，您可以看看這篇 Google 工程師 Jake Archibald 寫的「\u003Ca href=\"https:\/\/jakearchibald.com\/2015\/tasks-microtasks-queues-and-schedules\/\" target=\"_blank\"\u003ETasks, microtasks, queues and schedules\u003C\/a\u003E」，他在裡面也準備了小測驗讓你猜程式碼的執行順序 XDDD。\u003Cbr \/\u003E　\u003Cbr \/\u003E總地來說，我想表達的是：「process.nextTick() 與 microtasks 在非同步程式碼中的優先序是數一數二高的！每個 phase 結束之前都會被執行！(再次提醒，不是每個 tick！)」\u003C\/div\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Estartup\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EprocessNextTick\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E() {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E nextTickQueue \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E [];   \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ Callbacks 會排進這個 queue!!\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E pendingUnhandledRejections \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E [];\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E microtasksScheduled \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Efalse\u003C\/span\u003E;\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E _runMicrotasks \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E {};\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprocess\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EnextTick\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E nextTick;  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ nextTick 函式在下面\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ process._setupNextTick 在 node.cc 中, 我認為意思到了, 就不用再挖下去了\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Econst\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EtickInfo\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprocess\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003E_setupNextTick\u003C\/span\u003E(_tickCallback, _runMicrotasks);\u003Cbr \/\u003E    _runMicrotasks \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_runMicrotasks\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003ErunMicrotasks\u003C\/span\u003E;\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003E_tickCallback\u003C\/span\u003E() {\u003Cbr \/\u003E      \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E callback, args, tock;\u003Cbr \/\u003E\u003Cbr \/\u003E      \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Edo\u003C\/span\u003E {\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ewhile\u003C\/span\u003E (tickInfo[kIndex] \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;\u003C\/span\u003E tickInfo[kLength]) {\u003Cbr \/\u003E        \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ callbacks 從 queue 中一個一個被挖出來執行\u003C\/span\u003E\u003Cbr \/\u003E          tock \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E nextTickQueue[tickInfo[kIndex]\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E++\u003C\/span\u003E];\u003Cbr \/\u003E          callback \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Etock\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecallback\u003C\/span\u003E;\u003Cbr \/\u003E          args \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Etock\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eargs\u003C\/span\u003E;\u003Cbr \/\u003E\u003Cbr \/\u003E          \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (args \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eundefined\u003C\/span\u003E) {\u003Cbr \/\u003E            \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EnextTickCallbackWith0Args\u003C\/span\u003E(callback);\u003Cbr \/\u003E          } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E            \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eswitch\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eargs\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elength\u003C\/span\u003E) {\u003Cbr \/\u003E              \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ecase\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1\u003C\/span\u003E:\u003Cbr \/\u003E                \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EnextTickCallbackWith1Arg\u003C\/span\u003E(callback, args[\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E]);\u003Cbr \/\u003E              \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E            }\u003Cbr \/\u003E          }\u003Cbr \/\u003E          \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1e4\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;\u003C\/span\u003E tickInfo[kIndex])\u003Cbr \/\u003E            \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EtickDone\u003C\/span\u003E();\u003Cbr \/\u003E        }\u003Cbr \/\u003E        \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EtickDone\u003C\/span\u003E();\u003Cbr \/\u003E        \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ process.nextTick 的 callbacks 跑完, 接著跑 Promise 的 microtasks\u003C\/span\u003E\u003Cbr \/\u003E        \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003E_runMicrotasks\u003C\/span\u003E();\u003Cbr \/\u003E        \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EemitPendingUnhandledRejections\u003C\/span\u003E();\u003Cbr \/\u003E      } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ewhile\u003C\/span\u003E (tickInfo[kLength] \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!==\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E);\u003Cbr \/\u003E    }\u003Cbr \/\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...略\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EnextTick\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecallback\u003C\/span\u003E) {\u003Cbr \/\u003E      \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E args;\u003Cbr \/\u003E      \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Earguments\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elength\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026gt;\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1\u003C\/span\u003E) {\u003Cbr \/\u003E        args \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E [];\u003Cbr \/\u003E        \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efor\u003C\/span\u003E (\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E i \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1\u003C\/span\u003E; i \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;\u003C\/span\u003E \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Earguments\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elength\u003C\/span\u003E; i\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E++\u003C\/span\u003E)\u003Cbr \/\u003E          \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eargs\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Epush\u003C\/span\u003E(\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Earguments\u003C\/span\u003E[i]);\u003Cbr \/\u003E      }\u003Cbr \/\u003E\u003Cbr \/\u003E      \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 將 callback 連它的 arguments 用一個物件存起來推進 queue\u003C\/span\u003E\u003Cbr \/\u003E      \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EnextTickQueue\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Epush\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003ETickObject\u003C\/span\u003E(callback, args));\u003Cbr \/\u003E      tickInfo[kLength]\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E++\u003C\/span\u003E;\u003Cbr \/\u003E    }\u003Cbr \/\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ...\u003C\/span\u003E\u003Cbr \/\u003E  };\u003C\/pre\u003E原始碼看到這裡，大致上也拼湊出了一些圖像，因為原始碼實在很多，我想就留給有興趣的人繼續追下去吧！您可以看看 module.js 的 Module.runMain() 方法、node.cc 的\u0026nbsp;MakeCallback() 方法以及它所呼叫\u0026nbsp;env-\u0026gt;tick_callback_function() 都是相關的。\u003Cbr \/\u003E\u003Cbr \/\u003E這裡 nextTickQueue 的 nextTick 從字面上看也會造成誤會，以為是在下一個 loop iteration 執行，實際上這個 queue 中的 callbacks 會在 Event Loop 每次準備作 phase transition 之前執行。關於 nextTick 與 setImmediate 命名上的語義不清之處，Node 官方文件上也有提出說明：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Cspan style=\"font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003E\u003Ci\u003EIn essence, the names should be swapped. process.nextTick() fires more immediately than setImmediate() but this is an artifact of the past which is unlikely to change. Making this switch would break a large percentage of the packages on npm.\u0026nbsp;\u003C\/i\u003E\u003C\/span\u003E\u003C\/blockquote\u003E\u003Cbr \/\u003E看到這裡，假如您還沒睡著！我真的是佩服佩服！...\u003Cbr \/\u003E先不要幹角我啊！我們終於要進入另一個主題 EventEmitter 了！\u003Cbr \/\u003E相信我！這個題目會很快！\u003Cbr \/\u003E\u003Chr \/\u003E\u003Ch3\u003EEventEmitter\u003C\/h3\u003ENode.js 最著名的就是它的「非同步」以及「事件驅動」特性，看完我們上面對 Event Loop 的淺析，相信大家現在應該有點爽爽的感覺。在這邊，我們要再討論一個很重要的東西，就是 \u003Cspan style=\"color: blue;\"\u003E\u003Cb\u003EEventEmitter\u003C\/b\u003E\u003C\/span\u003E。這邊我先說一下我對它的總結：\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Ci\u003E\u003Cspan style=\"color: #444444; font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003ENode.js 給你 EventEmitter，是讓你在使用者空間創造 event pattern 的工具。它的本身與 Event Loop 毫無關係！\u003C\/span\u003E\u003C\/i\u003E\u003C\/blockquote\u003E\u003Cbr \/\u003E什麼？？？？！！！！\u003Cbr \/\u003E\u003Cbr \/\u003E當你看完這句話，或許你會帶點疑惑，又或者帶一點不服氣！很想質疑我到底懂不懂 Node.js！先別抓狂、先別暴怒、先不要摔電腦！讓我們繼續看下去～\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003EEventEmitter 本身是「同步的」\u003C\/h3\u003E關於 EventEmitter 的「同步」本質，在我讀過一些書或文章，很遺憾地，都沒有很明確地指出這一點。甚至有些說法比較囫圇吞棗一點、有些說的比較隱晦、又或者有書上以為 EventEmitter 是事件迴圈的抽象 (這完全不對呀，請不要問我哪本書了)！\u003Cbr \/\u003E\u003Cbr \/\u003E　　當我還是 Node.js 新手時，我也曾經這樣相信了。直到我自己使用 Lua 實作一套符合 Node.js 介面的 \u003Ca href=\"https:\/\/github.com\/simenkid\/lua-events\" target=\"_blank\"\u003EEventEmitter\u003C\/a\u003E 與 \u003Ca href=\"https:\/\/github.com\/simenkid\/nodemcu-timer\" target=\"_blank\"\u003Etimer\u003C\/a\u003E 時，我才發現事情完全不是那麼樣子。也因為想著要符合 Node.js 的介面，也讓我「抄襲」了 Node.js 的作法 (呵呵~ 是向優秀偉大的開發者學習啦~)\u003Cbr \/\u003E\u003Cbr \/\u003E　　以下一樣是以 node.js v4.5.0 LTS 原始碼為例。EventEmitter 的實作在 \/lib\/events.js，它總共不超過 450 行。事件模式有兩支很重要的方法，我們在實作上幾乎都是圍繞在\u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003E .emit(event, ...)\u003C\/span\u003E 以及\u003Cspan style=\"font-family: \u0026quot;courier new\u0026quot; , \u0026quot;courier\u0026quot; , monospace;\"\u003E .on(listener)\u003C\/span\u003E 這兩支方法。.on() 讓你註冊事件監聽器，而 .emit() 讓你發射事件。一旦事件發生，註冊監聽該事件的 callbacks 將被執行。我想這樣的模式，使用 JavaScript 的開發者應該都蠻熟悉的 (豈止熟悉？連想都不用想了....)。\u003Cbr \/\u003E\u003Cbr \/\u003EEventEmitter 的 constructor 長這樣，它的構造真的很簡單，內部就是一個 protected member this._event = {}，這個盒子裡，會以 event type (事件名稱) 當 key，而註冊進來的 listener 作為 value。如果一個事件有很多個 listeners，那麼 value 就會是一個按註冊順序來儲存這些 handlers 的陣列。\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EEventEmitter\u003C\/span\u003E() {\u003Cbr \/\u003E  \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EEventEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Einit\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ecall\u003C\/span\u003E(\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E);\u003Cbr \/\u003E}\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EEventEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Einit\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E() {\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003E\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_events\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E||\u003C\/span\u003E \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_events\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003EObject\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EgetPrototypeOf\u003C\/span\u003E(\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E).\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_events\u003C\/span\u003E) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_events\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E {};      \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 這個物件將用來管理註冊進來的 listeners\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_eventsCount\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E;\u003Cbr \/\u003E  }\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_maxListeners\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_maxListeners\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E||\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eundefined\u003C\/span\u003E;\u003Cbr \/\u003E};\u003C\/pre\u003E\u003Cbr \/\u003E現在讓我們先來看 .on()，它是 addListener 的別名，所以我們直接看 addListener 方法：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EEventEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprototype\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eon\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EEventEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprototype\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EaddListener\u003C\/span\u003E;\u003C\/pre\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EEventEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprototype\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EaddListener\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EaddListener\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Etype\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Elistener\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E events;\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E existing;\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E  events \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_events\u003C\/span\u003E;\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E    existing \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E events[type];\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 如果 event type 不存在, 就把以 type 當 key, 把 listener 當 value 塞進去\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003Eexisting) {\u003Cbr \/\u003E    existing \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E events[type] \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E listener;\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E++\u003C\/span\u003E\u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_eventsCount\u003C\/span\u003E;\u003Cbr \/\u003E  } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 如果事件已存在, 它的值是函式, 現在要改用陣列來儲存\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 如果已經是陣列, 帶有已經有 2 個以上的 listeners, 就繼續把新的 listener push 進去\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Etypeof\u003C\/span\u003E existing \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E===\u003C\/span\u003E \u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Efunction\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E) {\u003Cbr \/\u003E      \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ Adding the second element, need to change to array.\u003C\/span\u003E\u003Cbr \/\u003E      existing \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E events[type] \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E [existing, listener];\u003Cbr \/\u003E    } \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E      \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ If we've already got an array, just append.\u003C\/span\u003E\u003Cbr \/\u003E      \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eexisting\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Epush\u003C\/span\u003E(listener);\u003Cbr \/\u003E    }\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E  }\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E;\u003Cbr \/\u003E};\u003C\/pre\u003E是不是很簡單啊！接著，我們來看 .emit()：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EEventEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprototype\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Etype\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E er, handler, len, args, i, events, domain;\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E  events \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E.\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003E_events\u003C\/span\u003E;\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E  handler \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E events[type];  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 找出 handler\u003C\/span\u003E\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 若沒有那個 type 的監聽器, 就直接 return\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003Ehandler)\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Efalse\u003C\/span\u003E;\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 接下的 cases, 只是 node 為了效能起見, 針對不同 args 數量寫了不同的呼叫方式\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 我們就抓 emitOne 出來看吧\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eswitch\u003C\/span\u003E (len) {\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ fast cases\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ecase\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1\u003C\/span\u003E:\u003Cbr \/\u003E      \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EemitNone\u003C\/span\u003E(handler, isFn, \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E);\u003Cbr \/\u003E      \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ebreak\u003C\/span\u003E;\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ecase\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E2\u003C\/span\u003E:\u003Cbr \/\u003E      \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EemitOne\u003C\/span\u003E(handler, isFn, \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Ethis\u003C\/span\u003E, \u003Cspan class=\"pl-v rich-diff-level-one\" style=\"box-sizing: border-box; color: #ed6a43;\"\u003Earguments\u003C\/span\u003E[\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E1\u003C\/span\u003E]);\u003Cbr \/\u003E      \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E  }\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Ereturn\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Etrue\u003C\/span\u003E;\u003Cbr \/\u003E};\u003C\/pre\u003E就拿 .emitOne() 當代表來說明：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EemitOne\u003C\/span\u003E(\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehandler\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EisFn\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eself\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Earg1\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 如果 handler 是一支函式, 就直接執行\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (isFn)\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehandler\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ecall\u003C\/span\u003E(self, arg1);\u003Cbr \/\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 若非函式, 那就是一堆函式的陣列\u003C\/span\u003E\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eelse\u003C\/span\u003E {\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E len \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ehandler\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elength\u003C\/span\u003E;\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E listeners \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EarrayClone\u003C\/span\u003E(handler, len);\u003Cbr \/\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 陣列中的 handlers 一支支依序被拉出來執行\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 註: 這是同步的程式碼\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efor\u003C\/span\u003E (\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E i \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003E0\u003C\/span\u003E; i \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E\u0026lt;\u003C\/span\u003E len; \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E++\u003C\/span\u003Ei)\u003Cbr \/\u003E      listeners[i].\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Ecall\u003C\/span\u003E(self, arg1);\u003Cbr \/\u003E  }\u003Cbr \/\u003E}\u003C\/pre\u003E這告訴我們，\u003Cspan style=\"background-color: yellow;\"\u003E每一次的 emit，都將跑起一段同步的程式碼\u003C\/span\u003E，一個 callback 執行完再接著下一個，直到執行結束。是不是聽起來跟前面的 callback queue 感覺很像呀！是的，就是那一回事！可是，EventEmitter 本身的運作，壓根與 Node.js 的事件迴圈完全沒有關係！你可以把整份 event.js 讀一讀，你不會看到任何非同步的程式碼！\u003Cbr \/\u003E\u003Cbr \/\u003E如果你曾經使用過 React flux 模式，它的 \u003Ca href=\"https:\/\/github.com\/facebook\/flux\/blob\/master\/src\/Dispatcher.js#L185-L223\" target=\"_blank\"\u003EDispatcher\u003C\/a\u003E 也運用了相同的模式來完成 payload 的 broadcast (請見 register() 與 dispatch() 兩支方法是不是跟 on() 與 emit() 的感覺很像呢？只是裡面多了些狀態控制的東東啦！)。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch3\u003E使用 EventEmitter 要格外小心\u003C\/h3\u003E我們在 node.js 中大部分會使用到 EventEmitter 的情況，除了用於協助工作流程控制外，最常見的場合就是\u003Cspan style=\"color: #6aa84f;\"\u003E用於通知某件事情的發生(或完成)\u003C\/span\u003E，而這大部分多用於通知某個\u003Cspan style=\"color: #6aa84f;\"\u003E非同步\u003C\/span\u003E的工作完成了、發生了(讀檔完成、斷線了、socket 關閉了等等)。例如：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EfooEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edata\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E) {\u003Cbr \/\u003E  \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(data);\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Efs\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EreadFile\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\/path\/to\/file\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, (\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eerr\u003C\/span\u003E, \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Edata\u003C\/span\u003E) \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u0026gt;\u003C\/span\u003E {\u003Cbr \/\u003E  \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Eif\u003C\/span\u003E (\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E!\u003C\/span\u003Eerr)\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003EfooEmitter\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edata\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, data);\u003Cbr \/\u003E});\u003C\/pre\u003E因為使用情境常常都是像上面這樣，所以造成了「使用了 EventEmitter 就好像是寫了非同步程式碼的假象」。\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch4\u003E看過狗追自己的尾巴嗎？來寫一個！\u003C\/h4\u003E我們在一個 event1 handler 中 emit 了一個 'event2' 事件，而在 event2 handler 中又繼續 emit 一個 'event3' 事件，然後最後一個 event3\u0026nbsp;\u0026nbsp;handler 發射 'event1' 事件：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E EventEmitter \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E\"\u003C\/span\u003Eevents\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E\"\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E crazy \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EEventEmitter\u003C\/span\u003E();\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1 fired!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent2\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent2\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent2 fired!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent3\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent3\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent3 fired!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/pre\u003E執行看看！你將會得到 call stack 爆炸的例外 XDDD....　狗狗因為過度暈眩就這樣死了。為什麼？因為所有 callback 的執行是同步的！一直遞迴地 call 下去，永遠不回頭！不要以為這種事不會發生，天底下就是會有那麼多巧合！\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch4\u003E瘋狂旋轉的不死狗\u003C\/h4\u003E那如果第一次 fire 使用 setImmediate() 推入事件迴圈呢(注意哦！很非同步 style 對不對)？你還是會得到一樣的結果！你只是把第一次的 fire 丟入事件迴圈，當事件一發生時，\u003Cspan style=\"background-color: yellow;\"\u003E整個 EventEmitter 的觸發鏈是同步的\u003C\/span\u003E，將把事件迴圈阻塞住，然後 callback 一直遞迴地呼叫下去，直到 stack 爆掉而當機。同樣的道理，如果我們沒有故意把事件兜成一個閉迴路，但是每一個 event handler 都是 long-running 的話，那麼同樣會使事件迴圈被阻塞的時間變長。\u003Cbr \/\u003E\u003Cbr \/\u003E　　接下來，我們將剛剛的程式碼中的每個 emit() 都用\u0026nbsp;setImmediate() 丟入事件迴圈呢？你將得到一隻不死狗：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E EventEmitter \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevents\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E crazy \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EEventEmitter\u003C\/span\u003E();\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1 fired!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EsetImmediate\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent2\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    });\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent2\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent2 fired!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EsetImmediate\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent3\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    });\u003Cbr \/\u003E\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent3\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent3 fired!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EsetImmediate\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    });\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/pre\u003E執行看看！這是真正的非同步程式碼！你會很開心！因為不再當機了！\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Ch4\u003E那改用 process.nextTick 好了\u003C\/h4\u003E現在，你看 process.nextTick 應該也夠眼熟了，如果我們把上面程式碼\u003Cb\u003E\u003Cspan style=\"color: #e06666;\"\u003E全部的\u003C\/span\u003E\u003C\/b\u003E setImmediate() 換成 process.nextTick 呢？你猜結果會怎樣？ (不要試！很恐怖！)\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1 fired!\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    \u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ 將 全部的 setImmediate 換成 process.nextTick\u003C\/span\u003E\u003Cbr \/\u003E    \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Eprocess\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EnextTick\u003C\/span\u003E(\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E        \u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent2\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E    });\u003Cbr \/\u003E});\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-c rich-diff-level-one\" style=\"box-sizing: border-box; color: #969896;\"\u003E\/\/ ... 略\u003C\/span\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Ecrazy\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eemit\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevent1\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003C\/pre\u003E它會卡住！你要等久一點.... 大概 30 秒左右，最後它會給你一個\u0026nbsp;process out of memory 的例外。現在不是 stack 爆掉，而是 GC 沒有辦法成功回收記憶體\u0026nbsp;\u003Cspan style=\"color: #666666; font-size: x-small;\"\u003E(每個 handler 都有自己的 closure 去存取外層的那個 crazy，這個開銷會在 heap 上)\u003C\/span\u003E。姑且不管最後那個 GC 為何無法成功回收的原因，但相信你應該也猜的到，我們的程式會一直鎖死在某個 phase，因為永遠有清除不完的下一個 process.nextTick 的 callback (所以事件迴圈完全被阻塞住了，啾咪～ Heap 爆掉可以說是意外的收穫阿... XDDD)。\u003Cbr \/\u003E\u003Cbr \/\u003E所以，關於 EventEmitter，回到我前面說的：\u003Cbr \/\u003E\u003Cblockquote class=\"tr_bq\"\u003E\u003Ci\u003E\u003Cspan style=\"color: #444444; font-family: \u0026quot;times\u0026quot; , \u0026quot;times new roman\u0026quot; , serif;\"\u003ENode.js 給你 EventEmitter，是讓你在使用者空間創造 event pattern 的工具。它的本身與 Event Loop 毫無關係！\u003C\/span\u003E\u003C\/i\u003E\u003C\/blockquote\u003E那麼我們應該要怎麼樣寫出「非同步的 event pattern」呢？現在你知道，你需要的只是將 EventEmitter 與那些可以將工作丟入 Event Loop 的 APIs 搭配使用即可！\u003Cspan style=\"font-size: x-small;\"\u003E(setTimeout(), setInterval(), Async I\/O APIs, setImmediate(), 以及 process.nextTick()。如果使用 process.nextTick() 要稍微小心一點，只要避免產生遞迴呼叫、避免在 callback 中執行 long-running task，一般是不會有什麼大問題。)\u003C\/span\u003E\u003Cbr \/\u003E　\u003Cbr \/\u003E如果說到這裡，您還是沒辦法被說服，那麼請您試著執行以下程式碼，您認為程式會一直執行下去還是馬上結束呢：\u003Cbr \/\u003E\u003Cpre class=\"rich-diff-level-zero\" style=\"background-color: #f7f7f7; border-radius: 3px; box-sizing: border-box; color: #333333; font-family: Consolas, \u0026quot;Liberation Mono\u0026quot;, Menlo, Courier, monospace; font-size: 13.6px; font-stretch: normal; line-height: 1.45; margin-bottom: 16px; margin-left: 15px; overflow: auto; padding: 10px 20px; word-wrap: normal;\"\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E EventEmitter \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Erequire\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Eevents\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E\u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Evar\u003C\/span\u003E server \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003E=\u003C\/span\u003E \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Enew\u003C\/span\u003E \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003EEventEmitter\u003C\/span\u003E();\u003Cbr \/\u003E\u003Cbr \/\u003E\u003Cspan class=\"pl-smi rich-diff-level-one\" style=\"box-sizing: border-box;\"\u003Eserver\u003C\/span\u003E.\u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Eon\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003Edata\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E, \u003Cspan class=\"pl-k rich-diff-level-one\" style=\"box-sizing: border-box; color: #a71d5d;\"\u003Efunction\u003C\/span\u003E () {\u003Cbr \/\u003E    \u003Cspan class=\"pl-en rich-diff-level-one\" style=\"box-sizing: border-box; color: #795da3;\"\u003Econsole\u003C\/span\u003E.\u003Cspan class=\"pl-c1 rich-diff-level-one\" style=\"box-sizing: border-box; color: #0086b3;\"\u003Elog\u003C\/span\u003E(\u003Cspan class=\"pl-s rich-diff-level-one\" style=\"box-sizing: border-box; color: #183691;\"\u003E\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003EAm I waiting for data incoming?\u003Cspan class=\"pl-pds\" style=\"box-sizing: border-box;\"\u003E'\u003C\/span\u003E\u003C\/span\u003E);\u003Cbr \/\u003E});\u003C\/pre\u003E如果您不用執行，就馬上能回答出來。您已經確確實實懂我的意思了！那裡根本沒有任何事情被安排進 Event Loop。\u003Cbr \/\u003E　\u003Cbr \/\u003E\u003Cspan style=\"color: #3d85c6;\"\u003E[2016\/9\/23] 謝謝網友的回應，聽說在 node 4.4.7@windows 上跑 process.nextTick 的不死狗範例，竟然不會爆!! 我覺得超有趣的阿!!\u003C\/span\u003E\u003Cbr \/\u003E\u003Cdiv class=\"separator\" style=\"clear: both; text-align: center;\"\u003E\u003Ca href=\"https:\/\/3.bp.blogspot.com\/-GpuKwT-lb8U\/V-VFclGIyDI\/AAAAAAAAB1g\/E-UObMdzg44uZEejIxX0O_SUKeTblQE5gCLcB\/s1600\/report.jpg\" imageanchor=\"1\" style=\"margin-left: 1em; margin-right: 1em;\"\u003E\u003Cimg border=\"0\" src=\"https:\/\/3.bp.blogspot.com\/-GpuKwT-lb8U\/V-VFclGIyDI\/AAAAAAAAB1g\/E-UObMdzg44uZEejIxX0O_SUKeTblQE5gCLcB\/s1600\/report.jpg\" \/\u003E\u003C\/a\u003E\u003C\/div\u003E\u003Cbr \/\u003E\u003Ch3\u003E結語\u003C\/h3\u003E這篇文章，我們把 Node.js 的「Event Loop」跟「EventEmitter」兩個概念完全切割開了，把它們各自梳理的很清楚，它們本來就不是天生就結合在一起的東西，EventEmitter\u0026nbsp;更不是\u0026nbsp;Event Loop 的抽象。一旦我們對這兩個概念不再模模糊糊，那麼把它們兩者結合起來運用，你一定會覺得更加得心應手！\u003Cbr \/\u003E\u003Cbr \/\u003E　　很希望這篇文章，對於跟我一樣熱愛 JavaScript、熱愛 Node.js 的開發者，能夠對 Node.js 的非同步行為可以有很好的啟發與認識，然後能繼續寫出更棒的非同步程式碼。然後，我自己有個\u003Cstrike\u003E很不要臉的\u003C\/strike\u003E期待是，希望這篇文章可以成為大家探討 Node.js 非同步行為很好的範例，非常歡迎各界拿去修修改改當教材(因為我覺得正確認識它，真的非常非常重要)。同時也希望大家有發現錯誤的話，能告訴我，讓我們一起把它修改得更好、更正確！\u003Cbr \/\u003E　\u003Cbr \/\u003E　　還有還有，我很久沒在文章裡面請求大家支持我們的\u003Ca href=\"https:\/\/www.facebook.com\/eeRhapsody\/\" target=\"_blank\"\u003E粉絲團\u003C\/a\u003E啦！之前都覺得\u003Cstrike\u003E粉絲跟朋友一樣，不用多，死忠的有一個足矣\u003C\/strike\u003E。不過呢，如果您覺得這裡的文章真的寫得不錯，那麼就請您多多推薦給您的朋友。其實我是不知道這對 front-end 有沒有用，所以我只打算發布在 Node.js TW，不過還是很歡迎大家的轉載。\u003Cbr \/\u003E\u003Cbr \/\u003E當然也別忘了給粉絲團按個讚，持續接受 E.E. 狂想曲的騷擾 XDDD。有大家的鼓勵，也會讓我更有動力繼續努力寫文章！ (眼神死)\u003Cbr \/\u003E　\u003Cbr \/\u003E\u003Cspan style=\"font-size: x-small;\"\u003E(前幾天看到\u0026nbsp;TechBridge技術週刊 - (第 46 期) 的標題 - \u003Cspan style=\"color: #3d85c6;\"\u003EGithub 是全世界最大的同\/異性程式員交友平台\u003C\/span\u003E，讓我想到我在 GitHub 上真的有交到朋友。改天我想寫寫這個的故事，也歡迎大家加我 \u003Ca href=\"https:\/\/www.facebook.com\/chienjung.li.7\" target=\"_blank\"\u003Efacebook \u003C\/a\u003E啊～)\u003C\/span\u003E\u003C\/div\u003E"},"link":[{"rel":"replies","type":"application/atom+xml","href":"http:\/\/simeneer.blogspot.com\/feeds\/3949927765296842465\/comments\/default","title":"張貼留言"},{"rel":"replies","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/09\/nodejs-eventemitter.html#comment-form","title":"27 個意見"},{"rel":"edit","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/3949927765296842465"},{"rel":"self","type":"application/atom+xml","href":"http:\/\/www.blogger.com\/feeds\/37997006600210175\/posts\/default\/3949927765296842465"},{"rel":"alternate","type":"text/html","href":"http:\/\/simeneer.blogspot.com\/2016\/09\/nodejs-eventemitter.html","title":"非同步程式碼之霧：Node.js 的事件迴圈與 EventEmitter"}],"author":[{"name":{"$t":"simen"},"uri":{"$t":"http:\/\/www.blogger.com\/profile\/04929133426620976166"},"email":{"$t":"noreply@blogger.com"},"gd$image":{"rel":"http://schemas.google.com/g/2005#thumbnail","width":"25","height":"32","src":"\/\/4.bp.blogspot.com\/-rgum3MYshXs\/VR52w2rcOQI\/AAAAAAAABJM\/H70F_UZt2m8\/s113\/blogger_head.jpg"}}],"media$thumbnail":{"xmlns$media":"http://search.yahoo.com/mrss/","url":"https:\/\/2.bp.blogspot.com\/-5HK7GJNiMoI\/V-NWXY1RuSI\/AAAAAAAAB1Q\/U23hdfs2bmohitL7iKoxCyDqErg-9Bd7ACLcB\/s72-c\/nodearchpng.png","height":"72","width":"72"},"thr$total":{"$t":"27"}}]}});